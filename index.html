<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Financiero Personal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #0f172a, #020617 45%, #111827 100%);
      color: #e5e7eb;
    }

    /* INDICADOR DE CARREGAMENTO */
    #loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(2, 6, 23, 0.85);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #22c55e;
      font-size: 1.2rem;
      backdrop-filter: blur(4px);
    }

    header {
      background: linear-gradient(90deg, #0ea5e9, #6366f1);
      color: #f9fafb;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 12px rgba(15, 23, 42, 0.6);
      position: sticky;
      top: 0;
      z-index: 30;
    }

    header h1 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    header .user-info {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    header button {
      margin-left: 0.25rem;
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      background: rgba(15, 23, 42, 0.15);
      color: #e5e7eb;
      backdrop-filter: blur(6px);
    }

    header button:hover {
      background: rgba(15, 23, 42, 0.35);
    }

    .container {
      display: flex;
      min-height: calc(100vh - 50px);
    }

    nav {
      width: 230px;
      background: rgba(15,23,42,0.98);
      color: #e5e7eb;
      padding: 1rem 0.75rem;
      box-shadow: 4px 0 16px rgba(0,0,0,0.7);
      position: sticky;
      top: 50px;
      height: calc(100vh - 50px);
    }

    nav h2 {
      font-size: 0.85rem;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      color: #9ca3af;
      letter-spacing: 0.08em;
    }

    nav button {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      color: inherit;
      padding: 0.5rem 0.4rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      transition: background 0.15s, transform 0.1s;
    }

    nav button::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4b5563;
    }

    nav button:hover {
      background: #111827;
      transform: translateX(2px);
    }

    nav button.active {
      background: linear-gradient(90deg, #1d4ed8, #22c55e);
      color: #f9fafb;
    }
    nav button.active::before {
      background: #f9fafb;
    }

    main {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    .main-inner {
      max-width: 1150px;
      margin: 0 auto;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
      border-radius: 14px;
      padding: 0.9rem 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 14px 35px rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.45);
      backdrop-filter: blur(12px);
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.9);
    }

    .card h3 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.4rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.75rem;
    }

    .stat {
      background: radial-gradient(circle at top, #0b1120, #020617);
      border-radius: 10px;
      padding: 0.55rem 0.75rem;
      border: 1px solid #1f2937;
      box-shadow: inset 0 0 0 1px rgba(148,163,184,0.25);
    }

    .stat-label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 0.1rem;
    }

    .stat-value {
      font-size: 1rem;
      font-weight: 700;
      color: #f9fafb;
    }

    .stat-small {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .barra-distribucion {
      margin-top: 0.6rem;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: #111827;
      display: flex;
      box-shadow: inset 0 0 0 1px rgba(55,65,81,0.7);
    }

    .barra-segmento {
      height: 100%;
      transition: width 0.25s ease-out;
    }

    .barra-lazer    { background: #f97316; }
    .barra-essencial { background: #22c55e; }
    .barra-outras   { background: #6366f1; }

    form {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
      align-items: end;
    }

    form .full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 0.8rem;
      color: #cbd5f5;
      margin-bottom: 0.15rem;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 8px;
      border: 1px solid #4b5563;
      font-size: 0.85rem;
      background: #020617;
      color: #e5e7eb;
    }

    input::placeholder {
      color: #6b7280;
    }

    input:focus,
    select:focus {
      outline: 2px solid #22c55e;
      outline-offset: 1px;
      border-color: #22c55e;
    }

    button.primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #f9fafb;
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(22,163,74,0.7);
      white-space: nowrap;
    }

    button.primary:hover {
      background: linear-gradient(135deg, #16a34a, #15803d);
    }

    .btn-icon {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.75rem;
      padding: 0.25rem 0.6rem;
      cursor: pointer;
      line-height: 1.2;
    }

    .btn-icon-danger {
      border-color: #ef4444;
      color: #fecaca;
    }

    .btn-icon-danger:hover {
      background: #7f1d1d;
      border-color: #f97316;
    }

    .tabla-wrapper {
      margin-top: 0.5rem;
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      color: #e5e7eb;
    }

    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 0.4rem 0.55rem;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #020617;
      font-weight: 500;
      color: #9ca3af;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:nth-child(even) td {
      background: #020617;
    }

    tr:nth-child(odd) td {
      background: #030712;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #4b5563;
      margin-right: 0.25rem;
      text-transform: capitalize;
    }

    .tag.entrada {
      border-color: #0ea5e9;
      background: #0c4a6e;
      color: #e0f2fe;
    }
    .tag.salida {
      border-color: #f97316;
      background: #451a03;
      color: #fed7aa;
    }

    .hidden { display: none !important; }

    /* LOGIN */

    #login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #0b1120, #020617 60%);
      color: #f9fafb;
      padding: 1rem;
    }

    #login-box {
      background: radial-gradient(circle at top left, #020617, #020617);
      border-radius: 18px;
      border: 1px solid #4b5563;
      padding: 1.6rem;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 25px 70px rgba(0,0,0,0.9);
      backdrop-filter: blur(14px);
    }

    #login-box h2 {
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
    }

    #login-box p {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }

    #login-box form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    #login-box label {
      color: #e5e7eb;
    }

    #login-box input {
      background: #020617;
      border-color: #4b5563;
      color: #f9fafb;
    }

    #login-box button {
      padding: 0.45rem 0.75rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }

    #login-box button.primary {
      width: 100%;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      box-shadow: 0 4px 14px rgba(22,163,74,0.8);
    }

    #login-box button.primary:hover {
      background: linear-gradient(135deg, #16a34a, #15803d);
    }

    #login-toggle {
      display: flex;
      justify-content: space-between;
      margin-top: 0.3rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    #login-toggle button {
      background: transparent;
      color: #38bdf8;
      padding: 0;
      box-shadow: none;
    }

    #login-message {
      font-size: 0.8rem;
      margin-top: 0.4rem;
      min-height: 1rem;
      color: #f97316;
    }

    #register-extra {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    /* FILAS DE GASTOS FIJOS CON ESTADO */

    .fijo-amarillo {
      background: #422006 !important;
    }
    .fijo-rojo {
      background: #450a0a !important;
    }
    .fijo-verde {
      background: #022c22 !important;
    }

    .badge-estado {
      display: inline-flex;
      align-items: center;
      padding: 0.05rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    .badge-amarillo {
      background: #facc15;
      color: #1f2937;
    }
    .badge-rojo {
      background: #ef4444;
      color: #f9fafb;
    }
    .badge-verde {
      background: #22c55e;
      color: #022c22;
    }
    .badge-normal {
      background: #4b5563;
      color: #e5e7eb;
    }

    .reporte-controles {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
    }
    .reporte-controles > div {
      min-width: 160px;
    }

    /* MODAL PRIMEROS PASOS */

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
      form {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      nav {
        display: none;
        position: fixed;
        top: 50px;
        left: 0;
        height: calc(100vh - 50px);
        z-index: 20;
      }
      nav.open {
        display: block;
      }
      .container {
        flex-direction: column;
      }
      main {
        padding: 0.75rem;
      }
      .main-inner {
        max-width: 100%;
      }
      header button#menu-toggle {
        display: inline-block;
      }
    }

    @media (min-width: 769px) {
      header button#menu-toggle {
        display: none;
      }
    }
  </style>
</head>

<body>

<div id="loading-overlay" class="hidden">Cargando datos...</div>

<section id="login-screen">
  <div id="login-box">
    <h2>Entrar al Control Financiero</h2>
    <p>Inicia sesión o crea una cuenta. Tus datos se sincronizarán en la nube.</p>

    <form id="login-form">
      <div>
        <label for="login-email">Correo electrónico</label>
        <input type="email" id="login-email" required placeholder="tu@ejemplo.com" />
      </div>
      <div>
        <label for="login-password">Contraseña</label>
        <input type="password" id="login-password" required />
      </div>

      <div id="register-extra" class="hidden">
        <div>
          <label for="register-edad">Edad (opcional)</label>
          <input type="number" id="register-edad" min="10" max="120" />
        </div>
        <div>
          <label for="register-meta">Meta mensual de gasto (opcional)</label>
          <input type="text" id="register-meta" placeholder="Ej: 1500" />
        </div>
      </div>

      <button type="submit" class="primary" id="login-submit">Entrar</button>
      <div id="login-toggle">
        <span id="toggle-text">¿No tienes cuenta?</span>
        <button type="button" id="toggle-mode">Crear cuenta</button>
      </div>
      <div id="login-message"></div>
    </form>
  </div>
</section>

<div id="app" class="hidden">
  <header>
    <div style="display:flex; align-items:center; gap:0.5rem;">
      <button id="menu-toggle">☰</button>
      <h1>Control Financiero</h1>
    </div>
    <div class="user-info">
      <span id="user-email"></span>
      <button id="logout-btn">Salir</button>
    </div>
  </header>

  <div class="container">
    <nav id="sidebar">
      <h2>Menú</h2>
      <button data-section="dashboard" class="active">Dashboard</button>
      <button data-section="transacciones">Transacciones</button>
      <button data-section="fijos">Gastos fijos</button>
      <button data-section="tarjetas">Tarjetas</button>
      <button data-section="reportes">Reporte mensual</button>
      <button data-section="categorias">Categorías y metas</button>
      <button data-section="perfil">Perfil</button>
    </nav>

    <main>
      <div class="main-inner">

        <section id="section-dashboard">
          <div class="card">
            <h3>Resumen del mes actual</h3>
            <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:stretch; margin-top:0.5rem;">
              <div style="flex:2 1 220px;">
                <div class="grid">
                  <div class="stat">
                    <div class="stat-label">Entradas</div>
                    <div class="stat-value" id="stat-entradas">$ 0,00</div>
                  </div>
                  <div class="stat">
                    <div class="stat-label">Salidas</div>
                    <div class="stat-value" id="stat-salidas">$ 0,00</div>
                  </div>
                  <div class="stat">
                    <div class="stat-label">Saldo</div>
                    <div class="stat-value" id="stat-saldo">$ 0,00</div>
                    <div class="stat-small" id="stat-saldo-texto"></div>
                  </div>
                </div>
              </div>
              <div style="flex:1 1 160px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <canvas id="meta-chart" width="160" height="160"></canvas>
                <div class="stat-small" id="stat-meta-uso" style="margin-top:0.4rem; text-align:center;"></div>
                <div class="stat-small" id="stat-ingreso-alerta" style="margin-top:0.25rem; text-align:center;"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Objetivo de ahorro específico</h3>
            <p class="card-subtitle">
              Define un objetivo en la sección Perfil (ej.: “Computador 10.000”).
              Cada vez que cambies de objetivo o reinicies, el progreso comienza desde cero.
            </p>
            <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:stretch; margin-top:0.5rem;">
              <div style="flex:2 1 220px;">
                <div class="stat">
                  <div class="stat-label">Objetivo</div>
                  <div class="stat-value" id="obj-nombre">Sin objetivo definido</div>
                  <div class="stat-small">
                    Meta: <span id="obj-meta">-</span>
                  </div>
                </div>
                <div class="grid" style="margin-top:0.5rem;">
                  <div class="stat">
                    <div class="stat-label">Ahorro acumulado para este objetivo</div>
                    <div class="stat-value" id="obj-ahorrado">$ 0,00</div>
                  </div>
                  <div class="stat">
                    <div class="stat-label">Falta para el objetivo</div>
                    <div class="stat-value" id="obj-restante">$ 0,00</div>
                  </div>
                  <div class="stat">
                    <div class="stat-label">Detalle</div>
                    <div class="stat-small" id="obj-texto"></div>
                  </div>
                </div>
              </div>
              <div style="flex:1 1 160px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <canvas id="objetivo-chart" width="160" height="160"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Distribución de salidas del mes</h3>
            <p class="card-subtitle">
              Porcentaje de gastos fijos y otros gastos sobre el total de salidas.
            </p>
            <div class="grid" style="margin-top:0.5rem;">
              <div class="stat">
                <div class="stat-label">Gastos fijos</div>
                <div class="stat-value" id="stat-lazer">0%</div>
              </div>
              <div class="stat">
                <div class="stat-label">Otros gastos</div>
                <div class="stat-value" id="stat-essenciais">0%</div>
              </div>
              <div class="stat">
                <div class="stat-label">—</div>
                <div class="stat-value" id="stat-outras">0%</div>
              </div>
            </div>
            <div class="barra-distribucion">
              <div class="barra-segmento barra-lazer" id="barra-lazer" style="width:0%;"></div>
              <div class="barra-segmento barra-essencial" id="barra-essencial" style="width:0%;"></div>
              <div class="barra-segmento barra-outras" id="barra-outras" style="width:0%;"></div>
            </div>
          </div>
        </section>

        <section id="section-transacciones" class="hidden">
          <div class="card">
            <h3>Nueva transacción</h3>
            <form id="form-transaccion">
              <div>
                <label for="tipo">Tipo</label>
                <select id="tipo" required>
                  <option value="entrada">Entrada</option>
                  <option value="salida">Salida</option>
                </select>
              </div>
              <div>
                <label for="categoria">Categoría</label>
                <select id="categoria" required></select>
              </div>
              <div id="campo-origen" class="hidden">
                <label for="origen">Origen (solo salidas)</label>
                <select id="origen">
                  <option value="normal">Normal</option>
                  <option value="tarjeta">Tarjeta</option>
                </select>
              </div>
              <div id="campo-tarjeta" class="hidden">
                <label for="tarjeta-select">Tarjeta</label>
                <select id="tarjeta-select"></select>
              </div>
              <div>
                <label for="valor">Valor</label>
                <input type="text" id="valor" required placeholder="Ej: 1.300,50" />
              </div>
              <div>
                <label for="data">Fecha</label>
                <input type="date" id="data" required />
              </div>
              <div id="campo-gasto-fijo" class="hidden">
                <label for="gasto-fijo-select">Seleccionar gasto fijo</label>
                <select id="gasto-fijo-select"></select>
              </div>
              <div class="full">
                <label for="descripcion">Descripción</label>
                <input type="text" id="descripcion" placeholder="Ej: Salario, Mercado, Cine, etc." />
              </div>
              <div>
                <button type="submit" class="primary">Añadir</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3>Transacciones del mes</h3>
            <div class="card-subtitle">
              Usa el buscador para encontrarlas por descripción o por fecha.
            </div>

            <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
              <div>
                <label for="filtro-texto">Buscar por descripción</label>
                <input type="text" id="filtro-texto" placeholder="Ej: mercado, cine, alquiler..." />
              </div>
              <div>
                <label for="filtro-fecha">Filtrar por fecha</label>
                <input type="date" id="filtro-fecha" />
              </div>
              <div>
                <button type="button" class="primary" id="btn-limpiar-filtros">Limpiar filtros</button>
              </div>
            </div>

            <div class="tabla-wrapper">
              <table id="tabla-transacciones">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Categoría</th>
                    <th>Origen</th>
                    <th>Descripción</th>
                    <th>Valor</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="section-fijos" class="hidden">
          <div class="card">
            <h3>Nuevo gasto fijo mensual</h3>
            <form id="form-fijo">
              <div>
                <label for="fijo-descripcion">Descripción</label>
                <input type="text" id="fijo-descripcion" required placeholder="Alquiler, Internet, etc." />
              </div>
              <div>
                <label for="fijo-valor">Valor mensual</label>
                <input type="text" id="fijo-valor" required placeholder="Ej: 1.300" />
              </div>
              <div>
                <label for="fijo-vencimiento">Día de vencimiento</label>
                <input type="number" id="fijo-vencimiento" min="1" max="31" required />
              </div>
              <div>
                <button type="submit" class="primary">Añadir fijo</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3>Gastos fijos registrados</h3>
            <p class="card-subtitle">
              Amarillo = cerca de vencer (7 días) · Rojo = vencido / día de vencimiento sin pago · Verde = pagado este mes.
              Si el pago es parcial, verás cuánto falta.
            </p>
            <div class="tabla-wrapper">
              <table id="tabla-fijos">
                <thead>
                  <tr>
                    <th>Descripción</th>
                    <th>Valor</th>
                    <th>Vencimiento</th>
                    <th>Estado del mes</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="section-tarjetas" class="hidden">
          <div class="card">
            <h3>Registrar tarjeta</h3>
            <p class="card-subtitle">
              Guarda una referencia como los últimos dígitos para saber de qué tarjeta salió el gasto.
            </p>
            <form id="form-tarjeta">
              <div>
                <label for="tarjeta-alias">Propietario</label>
                <input type="text" id="tarjeta-alias" placeholder="Ej: Juan Pérez" />
              </div>
              <div>
                <label for="tarjeta-digitos">Últimos dígitos</label>
                <input type="text" id="tarjeta-digitos" maxlength="6" placeholder="Ej: 12345" />
              </div>
              <div>
                <label for="tarjeta-banco">Banco (opcional)</label>
                <input type="text" id="tarjeta-banco" placeholder="Ej: Banco Y" />
              </div>
              <div>
                <button type="submit" class="primary">Añadir tarjeta</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3>Tarjetas registradas</h3>
            <div class="tabla-wrapper">
              <table id="tabla-tarjetas">
                <thead>
                  <tr>
                    <th>Propietario</th>
                    <th>Últimos dígitos</th>
                    <th>Banco</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="section-reportes" class="hidden">
          <div class="card">
            <h3>Reporte mensual</h3>
            <p class="card-subtitle">
              Resumen de entradas, salidas y saldo de un mes, con desglose por categoría.
              Puedes revisarlo al final de cada mes.
            </p>
            <div class="reporte-controles">
              <div>
                <label for="reporte-mes">Seleccionar mes</label>
                <select id="reporte-mes"></select>
              </div>
              <div>
                <button type="button" class="primary" id="reporte-mes-actual">
                  Ir al mes actual
                </button>
              </div>
            </div>

            <div class="grid" style="margin-top:0.75rem;">
              <div class="stat">
                <div class="stat-label">Entradas del mes</div>
                <div class="stat-value" id="rep-entradas">$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Salidas del mes</div>
                <div class="stat-value" id="rep-salidas">$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Saldo del mes</div>
                <div class="stat-value" id="rep-saldo">$ 0,00</div>
                <div class="stat-small" id="rep-saldo-texto"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Gastos por categoría (solo salidas)</h3>
            <div class="tabla-wrapper">
              <table id="reporte-tabla-categorias">
                <thead>
                  <tr>
                    <th>Categoría</th>
                    <th>Tipo</th>
                    <th>Total gastado</th>
                    <th>% sobre las salidas</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="section-categorias" class="hidden">
          <div class="card">
            <h3>Categorías</h3>
            <form id="form-categoria">
              <div>
                <label for="cat-nome">Nombre de la categoría</label>
                <input type="text" id="cat-nome" required placeholder="Ej: Mercado, Gasolina, Universidad, Salud" />
              </div>
              <div>
                <label for="cat-grupo">Tipo</label>
                <select id="cat-grupo" required>
                  <option value="entrada">Entrada</option>
                  <option value="salida">Salida</option>
                </select>
              </div>
              <div>
                <button type="submit" class="primary">Añadir categoría</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3>Categorías registradas</h3>
            <div class="tabla-wrapper">
              <table id="tabla-categorias">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <p class="card-subtitle" style="margin-top:0.4rem;">
              El tipo define dónde se usa la categoría: <strong>Entrada</strong> o <strong>Salida</strong>.
            </p>
          </div>
        </section>

        <section id="section-perfil" class="hidden">
          <div class="card">
            <h3>Perfil financiero</h3>
            <p class="card-subtitle">
              Define tu edad, sexo, país, moneda, ingreso mensual y una meta mensual general de gastos.
              Tambien puedes definir un objetivo específico de ahorro (ej.: pagar un computador de 10.000).
              Cada objetivo tiene su propio “inicio”, y el progreso se resetea al cambiar el objetivo o al usar el botón de reinicio.
            </p>
            <form id="form-perfil">
              <div>
                <label for="perfil-edad">Edad</label>
                <input type="number" id="perfil-edad" min="10" max="120" />
              </div>
              <div>
                <label for="perfil-sexo">Sexo</label>
                <select id="perfil-sexo">
                  <option value="">No informar</option>
                  <option value="m">Masculino</option>
                  <option value="f">Femenino</option>
                  <option value="o">Otro</option>
                </select>
              </div>
              <div>
                <label for="perfil-pais">País (para análisis per cápita)</label>
                <select id="perfil-pais">
                  <option value="">Seleccionar país</option>
                  <option value="bo">Bolivia</option>
                  <option value="br">Brasil</option>
                  <option value="ar">Argentina</option>
                  <option value="cl">Chile</option>
                  <option value="mx">México</option>
                  <option value="otro">Otro país de LATAM</option>
                </select>
              </div>
              <div>
                <label for="perfil-meta">Meta mensual de gasto</label>
                <input type="text" id="perfil-meta" placeholder="Ej: 1500" />
              </div>
              <div>
                <label for="perfil-ingreso">Ingreso mensual aproximado</label>
                <input type="text" id="perfil-ingreso" placeholder="Ej: 2500" />
              </div>
              <div>
                <label for="perfil-moneda">Moneda</label>
                <select id="perfil-moneda">
                  <option value="">Automático por país</option>
                  <option value="BOB">BOB (Boliviano)</option>
                  <option value="BRL">BRL (Real brasileño)</option>
                  <option value="ARS">ARS (Peso argentino)</option>
                  <option value="CLP">CLP (Peso chileno)</option>
                  <option value="MXN">MXN (Peso mexicano)</option>
                  <option value="USD">USD (Dólar americano)</option>
                  <option value="EUR">EUR (Euro)</option>
                </select>
              </div>
              <div>
                <label for="perfil-objetivo-nombre">Objetivo de ahorro (nombre)</label>
                <input type="text" id="perfil-objetivo-nombre" placeholder="Ej: Computador nuevo" />
              </div>
              <div>
                <label for="perfil-objetivo-valor">Valor objetivo</label>
                <input type="text" id="perfil-objetivo-valor" placeholder="Ej: 10.000" />
              </div>
              <div>
                <button type="submit" class="primary">Guardar perfil</button>
              </div>
              <div>
                <button type="button" class="btn-icon" id="perfil-objetivo-reset">
                  Reiniciar progreso del objetivo
                </button>
              </div>
            </form>
            <div id="perfil-mensaje" class="stat-small" style="margin-top:0.4rem;"></div>
            <div id="perfil-analisis" class="stat-small" style="margin-top:0.5rem;"></div>
          </div>

          <div class="card">
            <h3>Historial de objetivos de ahorro</h3>
            <p class="card-subtitle">
              Aquí aparecen los objetivos que foram completados (100% o mais) e são salvos como concluídos.
            </p>
            <div class="tabla-wrapper">
              <table id="tabla-historial-objetivos">
                <thead>
                  <tr>
                    <th>Objetivo</th>
                    <th>Valor meta</th>
                    <th>Ahorro final</th>
                    <th>Fecha inicio</th>
                    <th>Fecha conclusión</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>
</div>

<div id="modal-categorias" class="modal hidden">
  <div class="card" style="max-width:420px; width:90%; text-align:left;">
    <h3>Primeros pasos</h3>
    <p class="card-subtitle">
      Como acabas de crear tu cuenta, tus categorías están vacías.
    </p>
    <p style="font-size:0.85rem; margin-top:0.5rem;">
      1. En el menú lateral, entra en <strong>"Categorías y metas"</strong>.<br/>
      2. Crea tus próprias categorias (ex.: Mercado, Aluguel, Universidade, Saúde, Lazer...).<br/>
      3. Depois, use essas categorias ao registrar suas transações.
    </p>
    <button type="button" class="primary" id="modal-categorias-ok" style="margin-top:0.75rem;">
      Entendido
    </button>
  </div>
</div>

<script type="module">
  // VOLTANDO PARA UNPKG (Compatível com seu iPad)
  import { createClient } from 'https://unpkg.com/@nhost/nhost-js@latest/dist/nhost-js.es.js';

  // CONFIGURAÇÃO DO NHOST
  const nhost = createClient({
    subdomain: 'cpmnrcipviprenstjcwg',
    region: 'sa-east-1',
    // MANTENDO LOCALSTORAGE (Resolve o problema de Sessão Nula)
    clientStorageType: 'localStorage'
  });

  window.nhost = nhost;

  // --- UTILITÁRIOS VISUAIS ---
  function loading(show) {
    const el = document.getElementById('loading-overlay');
    if (el) {
      if (show) el.classList.remove('hidden');
      else el.classList.add('hidden');
    }
  }

  function monedaPorDefectoParaPais(pais) {
    switch (pais) {
      case "bo": return "BOB";
      case "br": return "BRL";
      case "ar": return "ARS";
      case "cl": return "CLP";
      case "mx": return "MXN";
      case "otro": return "USD";
      default: return "USD";
    }
  }

  function parseNumeroLocal(str) {
    if (str === null || str === undefined) return 0;
    if (typeof str !== "string") str = String(str);
    str = str.trim();
    if (!str) return 0;
    str = str.replace(/\./g, "");
    str = str.replace(",", ".");
    const n = parseFloat(str);
    return isNaN(n) ? 0 : n;
  }

  let monedaUsuario = "USD";

  function formatearMoneda(valor) {
    const currency = monedaUsuario || "USD";
    let locale = "en-US";
    switch (currency) {
      case "BRL": locale = "pt-BR"; break;
      case "BOB": locale = "es-BO"; break;
      case "ARS": locale = "es-AR"; break;
      case "CLP": locale = "es-CL"; break;
      case "MXN": locale = "es-MX"; break;
      case "EUR": locale = "es-ES"; break;
      default:    locale = "en-US";
    }
    try {
      return valor.toLocaleString(locale, { style: "currency", currency });
    } catch (e) {
      return valor.toFixed(2);
    }
  }

  function obtenerAnioMesActual() {
    return new Date().toISOString().slice(0, 7);
  }

  function filtrarMesActual(lista, campoFecha) {
    const anioMesActual = obtenerAnioMesActual();
    return lista.filter(item => item[campoFecha].startsWith(anioMesActual));
  }

  function nombreMes(anioMes) {
    if (!anioMes) return "";
    const [anio, mes] = anioMes.split("-");
    const fecha = new Date(parseInt(anio), parseInt(mes) - 1, 1);
    return fecha.toLocaleDateString("es-ES", { month: "long", year: "numeric" });
  }

  function siguienteAnioMes(anioMes) {
    if (!anioMes) return anioMes;
    const [anioStr, mesStr] = anioMes.split("-");
    let anio = parseInt(anioStr, 10);
    let mes = parseInt(mesStr, 10);
    mes += 1;
    if (mes === 13) { mes = 1; anio += 1; }
    return anio.toString().padStart(4, "0") + "-" + mes.toString().padStart(2, "0");
  }

  // --- ESTADO GLOBAL ---
  let usuarioActual = null;
  let categoriasLocal = [];
  let transaccionesLocal = [];
  let fijosLocal = [];
  let tarjetasLocal = [];
  
  let metaMensualUsuario = 0;
  let ingresoMensualUsuario = 0;
  let edadUsuario = null;
  let sexoUsuario = "";
  let paisUsuario = "";
  let yaMostroModalCategorias = false;
  let objetivoNombre = "";
  let objetivoValor = 0;
  let objetivoAhorroBase = 0;
  let objetivoFechaInicio = null;
  let objetivoCompletado = false;
  let objetivosHistorial = [];

  // --- CARREGAR DADOS ---
  async function cargarDatosDelServidor() {
    let user = nhost.auth.getUser();
    
    if (!user) {
        const session = await nhost.auth.getSession();
        if (session) user = session.user;
    }

    if (!user) {
        document.getElementById("app").classList.add("hidden");
        document.getElementById("login-screen").classList.remove("hidden");
        return;
    }
    usuarioActual = user;
    document.getElementById("user-email").textContent = usuarioActual.email;

    loading(true);
    try {
      const query = `
        query GetAllData {
          categorias { id nome grupo }
          gastos_fijos { id descripcion valor vencimiento mes_inicio }
          tarjetas { id alias digitos banco }
          transacciones { id tipo categoria_id gasto_fijo_id tarjeta_id origen valor fecha descripcion }
          perfil_financiero {
            edad sexo pais moneda meta_mensual ingreso_mensual
            objetivo_nombre objetivo_valor objetivo_ahorro_base
            objetivo_fecha_inicio objetivo_completado
            mostro_modal_categorias objetivos_historial
          }
        }
      `;
      const { data, error } = await nhost.graphql.request(query);
      if (error) {
        console.error("GraphQL Error:", error);
        loading(false);
        return;
      }

      categoriasLocal = data.categorias || [];
      fijosLocal = (data.gastos_fijos || []).map(f => ({
        id: f.id, descripcion: f.descripcion, valor: Number(f.valor), vencimiento: f.vencimiento, mesInicio: f.mes_inicio
      }));
      tarjetasLocal = data.tarjetas || [];
      transaccionesLocal = (data.transacciones || []).map(t => ({
        id: t.id, tipo: t.tipo, categoriaId: t.categoria_id, gastoFijoId: t.gasto_fijo_id, tarjetaId: t.tarjeta_id,
        origen: t.origen, valor: Number(t.valor), fecha: t.fecha, descripcion: t.descripcion
      }));

      const p = (data.perfil_financiero && data.perfil_financiero[0]) || {};
      metaMensualUsuario = Number(p.meta_mensual || 0);
      ingresoMensualUsuario = Number(p.ingreso_mensual || 0);
      edadUsuario = p.edad || null;
      sexoUsuario = p.sexo || "";
      paisUsuario = p.pais || "";
      monedaUsuario = p.moneda || monedaPorDefectoParaPais(paisUsuario) || "USD";
      objetivoNombre = p.objetivo_nombre || "";
      objetivoValor = Number(p.objetivo_valor || 0);
      objetivoAhorroBase = Number(p.objetivo_ahorro_base || 0);
      objetivoFechaInicio = p.objetivo_fecha_inicio || null;
      objetivoCompletado = !!p.objetivo_completado;
      yaMostroModalCategorias = !!p.mostro_modal_categorias;
      objetivosHistorial = p.objetivos_historial || [];

      inicializarInterfaz();
      mostrarModalCategoriasSiCorresponde();
      
      document.getElementById("login-screen").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");

    } catch (e) {
      console.error("Exception loading data:", e);
    } finally {
      loading(false);
    }
  }

  // --- SALVAR PERFIL ---
  async function guardarPerfilEnServidor() {
    const user = nhost.auth.getUser();
    if (!user) return;

    loading(true);
    try {
      const mutation = `
        mutation UpsertPerfil($obj: perfil_financiero_insert_input!) {
          insert_perfil_financiero_one(
            object: $obj,
            on_conflict: {
              constraint: perfil_financiero_pkey,
              update_columns: [edad, sexo, pais, moneda, meta_mensual, ingreso_mensual, objetivo_nombre, objetivo_valor, objetivo_ahorro_base, objetivo_fecha_inicio, objetivo_completado, mostro_modal_categorias, objetivos_historial]
            }
          ) { user_id }
        }
      `;
      const variables = {
        obj: {
          user_id: user.id,
          edad: edadUsuario,
          sexo: sexoUsuario || null,
          pais: paisUsuario || null,
          moneda: monedaUsuario || null,
          meta_mensual: metaMensualUsuario,
          ingreso_mensual: ingresoMensualUsuario,
          objetivo_nombre: objetivoNombre || null,
          objetivo_valor: objetivoValor,
          objetivo_ahorro_base: objetivoAhorroBase,
          objetivo_fecha_inicio: objetivoFechaInicio,
          objetivo_completado: objetivoCompletado,
          mostro_modal_categorias: yaMostroModalCategorias,
          objetivos_historial: objetivosHistorial
        }
      };
      const { error } = await nhost.graphql.request(mutation, variables);
      if(error) throw error;
      
      const pm = document.getElementById("perfil-mensaje");
      if(pm) {
          pm.textContent = "Guardado en la nube.";
          setTimeout(() => pm.textContent="", 2000);
      }
    } catch(e) {
      console.error("Error saving profile", e);
    } finally {
      loading(false);
    }
  }

  // --- LOGICA DE LOGIN SEGURA ---
  const loginScreen = document.getElementById("login-screen");
  const app = document.getElementById("app");
  const loginForm = document.getElementById("login-form");
  const loginEmail = document.getElementById("login-email");
  const loginPassword = document.getElementById("login-password");
  const loginSubmit = document.getElementById("login-submit");
  const toggleModeBtn = document.getElementById("toggle-mode");
  const toggleText = document.getElementById("toggle-text");
  const loginMessage = document.getElementById("login-message");
  const registerExtra = document.getElementById("register-extra");
  const registerEdad = document.getElementById("register-edad");
  const registerMeta = document.getElementById("register-meta");

  const modalCategorias = document.getElementById("modal-categorias");
  const modalCategoriasOk = document.getElementById("modal-categorias-ok");
  let modoRegistro = false;

  toggleModeBtn.addEventListener("click", () => {
    modoRegistro = !modoRegistro;
    if (modoRegistro) {
      loginSubmit.textContent = "Crear cuenta";
      toggleText.textContent = "¿Ya tienes cuenta?";
      toggleModeBtn.textContent = "Entrar";
      registerExtra.classList.remove("hidden");
    } else {
      loginSubmit.textContent = "Entrar";
      toggleText.textContent = "¿No tienes cuenta?";
      toggleModeBtn.textContent = "Crear cuenta";
      registerExtra.classList.add("hidden");
    }
    loginMessage.textContent = "";
  });

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = loginEmail.value.trim().toLowerCase();
    const password = loginPassword.value.trim();
    if (!email || !password) return;

    loginMessage.style.color = "#f97316";
    loginMessage.textContent = "Procesando...";

    if (modoRegistro) {
      // REGISTRO
      try {
        const res = await nhost.auth.signUpEmailPassword({ email, password });
        
        if (res.error) {
          loginMessage.textContent = res.error.message || "Error al crear cuenta.";
          return;
        }

        if (res.session) {
            usuarioActual = res.session.user;
            edadUsuario = parseInt(registerEdad.value || "0", 10) || null;
            metaMensualUsuario = parseNumeroLocal(registerMeta.value || "0");
            await guardarPerfilEnServidor();
            abrirApp();
        } else {
            // Se registro ok mas sem sessao
            loginMessage.style.color = "#22c55e";
            loginMessage.textContent = "Cuenta creada. Intenta iniciar sesión ahora.";
            modoRegistro = false;
            loginSubmit.textContent = "Entrar";
            toggleText.textContent = "¿No tienes cuenta?";
            toggleModeBtn.textContent = "Crear cuenta";
            registerExtra.classList.add("hidden");
        }
      } catch (err) {
        loginMessage.textContent = "Error de red al registrar.";
        console.error(err);
      }
    } else {
      // LOGIN
      try {
        const res = await nhost.auth.signInEmailPassword({ email, password });
        
        if (res.error) {
          loginMessage.textContent = "Credenciales inválidas o error de conexión.";
          console.error("Login Error obj:", res.error);
          return;
        }

        if (!res.session) {
           console.warn("Sem sessão. Resposta completa:", res);
           if (res.needsEmailVerification) {
               loginMessage.textContent = "Verifique seu e-mail para ativar a conta.";
           } else {
               loginMessage.textContent = "Erro de sessão. Verifique as URLs no painel Nhost.";
           }
           return;
        }

        usuarioActual = res.session.user;
        abrirApp();

      } catch (err) {
        loginMessage.textContent = "Excepción técnica (ver consola).";
        console.error("Critical Login Exception:", err);
      }
    }
  });

  async function abrirApp() {
    if(!usuarioActual) return;
    document.getElementById("login-screen").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    await cargarDatosDelServidor();
  }

  document.getElementById("logout-btn").addEventListener("click", async () => {
    try { await nhost.auth.signOut(); } catch (e) {}
    usuarioActual = null;
    categoriasLocal=[]; transaccionesLocal=[]; fijosLocal=[]; tarjetasLocal=[];
    document.getElementById("app").classList.add("hidden");
    document.getElementById("login-screen").classList.remove("hidden");
  });

  modalCategoriasOk.addEventListener("click", async () => {
    modalCategorias.classList.add("hidden");
    yaMostroModalCategorias = true;
    await guardarPerfilEnServidor();
  });

  function mostrarModalCategoriasSiCorresponde() {
    if (categoriasLocal.length === 0 && !yaMostroModalCategorias) {
      modalCategorias.classList.remove("hidden");
    } else {
      modalCategorias.classList.add("hidden");
    }
  }

  // --- MENUS E NAVEGAÇÃO ---
  const sidebar = document.getElementById("sidebar");
  const menuToggle = document.getElementById("menu-toggle");
  menuToggle.addEventListener("click", () => sidebar.classList.toggle("open"));
  sidebar.addEventListener("click", (e) => {
    if (e.target.tagName !== "BUTTON") return;
    const seccion = e.target.getAttribute("data-section");
    if (!seccion) return;
    sidebar.querySelectorAll("button").forEach(btn => btn.classList.remove("active"));
    e.target.classList.add("active");
    document.querySelectorAll("main section").forEach(sec => sec.classList.add("hidden"));
    document.getElementById("section-" + seccion).classList.remove("hidden");
    sidebar.classList.remove("open");
  });

  // --- ACOES COM GRAPHQL ---
  const formCategoria = document.getElementById("form-categoria");
  formCategoria.addEventListener("submit", async (e) => {
    e.preventDefault();
    const nome = document.getElementById("cat-nome").value.trim();
    const grupo = document.getElementById("cat-grupo").value;
    if (!nome) return;
    loading(true);
    try {
      await nhost.graphql.request(`mutation AddCat($n:String!,$g:String!,$u:uuid!){insert_categorias_one(object:{nome:$n,grupo:$g,user_id:$u}){id}}`, 
      { n: nome, g: grupo, u: usuarioActual.id });
      document.getElementById("cat-nome").value = "";
      await cargarDatosDelServidor();
    } catch(err) { console.error(err); alert("Error al guardar"); loading(false); }
  });
  async function eliminarCategoria(id) {
    if(!confirm("¿Eliminar?")) return;
    loading(true);
    try {
      await nhost.graphql.request(`mutation Del($id:uuid!){delete_categorias_by_pk(id:$id){id}}`, {id});
      await cargarDatosDelServidor();
    } catch(e){console.error(e); loading(false);}
  }

  const formFijo = document.getElementById("form-fijo");
  formFijo.addEventListener("submit", async (e) => {
    e.preventDefault();
    const d=document.getElementById("fijo-descripcion").value.trim();
    const v=parseNumeroLocal(document.getElementById("fijo-valor").value);
    const ven=parseInt(document.getElementById("fijo-vencimiento").value);
    if(!d||!v||!ven)return;
    loading(true);
    try {
       const m = siguienteAnioMes(obtenerAnioMesActual());
       await nhost.graphql.request(`mutation AddF($d:String!,$v:numeric!,$ven:Int!,$m:String!,$u:uuid!){insert_gastos_fijos_one(object:{descripcion:$d,valor:$v,vencimiento:$ven,mes_inicio:$m,user_id:$u}){id}}`,
       {d,v,ven,m,u:usuarioActual.id});
       document.getElementById("form-fijo").reset();
       await cargarDatosDelServidor();
    } catch(e){console.error(e); alert("Error al guardar"); loading(false);}
  });
  async function eliminarFijo(id) {
      if(!confirm("¿Eliminar?")) return;
      loading(true);
      try {
        await nhost.graphql.request(`mutation Del($id:uuid!){delete_gastos_fijos_by_pk(id:$id){id}}`, {id});
        await cargarDatosDelServidor();
      } catch(e){console.error(e); loading(false);}
  }

  const formTarjeta = document.getElementById("form-tarjeta");
  formTarjeta.addEventListener("submit", async (e) => {
      e.preventDefault();
      const a=document.getElementById("tarjeta-alias").value.trim();
      const d=document.getElementById("tarjeta-digitos").value.trim();
      const b=document.getElementById("tarjeta-banco").value.trim();
      if(!a && !d) return;
      loading(true);
      try {
          await nhost.graphql.request(`mutation AddT($a:String,$d:String,$b:String,$u:uuid!){insert_tarjetas_one(object:{alias:$a,digitos:$d,banco:$b,user_id:$u}){id}}`,
          {a,d,b,u:usuarioActual.id});
          document.getElementById("form-tarjeta").reset();
          await cargarDatosDelServidor();
      } catch(e){console.error(e); alert("Error al guardar"); loading(false);}
  });
  async function eliminarTarjeta(id) {
      if(!confirm("¿Eliminar?")) return;
      loading(true);
      try {
        await nhost.graphql.request(`mutation Del($id:uuid!){delete_tarjetas_by_pk(id:$id){id}}`, {id});
        await cargarDatosDelServidor();
      } catch(e){console.error(e); loading(false);}
  }

  const formTransaccion = document.getElementById("form-transaccion");
  formTransaccion.addEventListener("submit", async (e) => {
      e.preventDefault();
      const tipo = document.getElementById("tipo").value;
      const catVal = document.getElementById("categoria").value;
      const orig = document.getElementById("origen").value;
      const val = parseNumeroLocal(document.getElementById("valor").value);
      const fecha = document.getElementById("data").value;
      const desc = document.getElementById("descripcion").value.trim();
      
      if(!tipo || !catVal || !val || !fecha) return;

      let gfId = null;
      if(tipo==="salida" && catVal==="__gasto_fijo__"){
          gfId = document.getElementById("gasto-fijo-select").value;
          if(!gfId) { alert("Seleccione gasto fijo"); return; }
      }
      let tId = null, origFinal = null;
      if(tipo==="salida"){
          if(orig==="tarjeta"){
              tId = document.getElementById("tarjeta-select").value;
              if(!tId) { alert("Seleccione tarjeta"); return; }
              origFinal="tarjeta";
          } else origFinal="normal";
      }
      
      const catIdDB = (catVal === "__gasto_fijo__") ? null : catVal;
      
      loading(true);
      try {
          await nhost.graphql.request(`mutation AddTr($t:String!,$c:uuid,$g:uuid,$tar:uuid,$o:String,$v:numeric!,$f:date!,$d:String,$u:uuid!){
              insert_transacciones_one(object:{tipo:$t,categoria_id:$c,gasto_fijo_id:$g,tarjeta_id:$tar,origen:$o,valor:$v,fecha:$f,descripcion:$d,user_id:$u}){id}
          }`, {t:tipo, c:catIdDB, g:gfId, tar:tId, o:origFinal, v:val, f:fecha, d:desc, u:usuarioActual.id});
          
          document.getElementById("valor").value="";
          document.getElementById("descripcion").value="";
          await cargarDatosDelServidor();
          actualizarObjetivo();
      } catch(e){console.error(e); alert("Error al guardar"); loading(false);}
  });
  async function eliminarTransaccion(id) {
      if(!confirm("¿Eliminar?")) return;
      loading(true);
      try {
          await nhost.graphql.request(`mutation Del($id:uuid!){delete_transacciones_by_pk(id:$id){id}}`, {id});
          await cargarDatosDelServidor();
          actualizarObjetivo();
      } catch(e){console.error(e); loading(false);}
  }

  // --- FUNCOES UI ---
  function rellenarSelectCategorias() {
    const sel = document.getElementById("categoria");
    sel.innerHTML = "";
    const tipo = document.getElementById("tipo").value;
    if (tipo === "salida" && fijosLocal.length > 0) {
      const opt = document.createElement("option"); opt.value = "__gasto_fijo__"; opt.textContent = "Gastos fijos"; sel.appendChild(opt);
    }
    categoriasLocal.forEach(c => {
       if(c.grupo !== tipo) return;
       const opt = document.createElement("option"); opt.value = c.id; opt.textContent = c.nome; sel.appendChild(opt);
    });
  }
  function rellenarTablaCategorias() {
      const tb = document.querySelector("#tabla-categorias tbody"); tb.innerHTML="";
      categoriasLocal.forEach(c => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${c.nome}</td><td>${c.grupo === "entrada" ? "Entrada" : "Salida"}</td><td></td>`;
          const btn = document.createElement("button"); btn.className="btn-icon btn-icon-danger"; btn.textContent="Eliminar"; btn.onclick = () => eliminarCategoria(c.id);
          tr.lastElementChild.appendChild(btn);
          tb.appendChild(tr);
      });
  }
  function rellenarSelectGastosFijos() {
      const s = document.getElementById("gasto-fijo-select"); s.innerHTML="";
      fijosLocal.forEach(f => {
          const o = document.createElement("option"); o.value=f.id; o.textContent=`${f.descripcion} (${formatearMoneda(f.valor)})`; s.appendChild(o);
      });
  }

  // Lógica de Estados dos Gastos Fixos
  function estadoFijoParaMes(fijo, anioMesActual) {
    const hoy = new Date();
    const diaHoy = hoy.getDate();
    const venc = fijo.vencimiento;
    const mesInicio = fijo.mesInicio || obtenerAnioMesActual();

    if (anioMesActual < mesInicio) {
      return { claseFila: "", badgeClase: "badge-normal", texto: "Aún no aplica este mes", restante: fijo.valor, totalPagado: 0 };
    }

    const transMes = filtrarMesActual(transaccionesLocal, "fecha");
    let totalPagado = 0;
    transMes.forEach(t => {
      if (t.tipo === "salida" && t.gastoFijoId === fijo.id) {
        totalPagado += t.valor;
      }
    });
    const restante = Math.max(0, fijo.valor - totalPagado);
    const pagoCompleto = totalPagado >= (fijo.valor - 0.01);

    if (pagoCompleto) {
      return { claseFila: "fijo-verde", badgeClase: "badge-verde", texto: "Pagado completamente este mes", restante: 0, totalPagado };
    }

    const faltanteTexto = restante > 0 ? `Falta ${formatearMoneda(restante)}` : "";

    if (totalPagado > 0 && !pagoCompleto) {
      if (diaHoy >= venc) {
        return { claseFila: "fijo-rojo", badgeClase: "badge-rojo", texto: `Pago parcial (${formatearMoneda(totalPagado)} de ${formatearMoneda(fijo.valor)}). ${faltanteTexto}`, restante, totalPagado };
      } else if (diaHoy >= venc - 7) {
        return { claseFila: "fijo-amarillo", badgeClase: "badge-amarillo", texto: `Pago parcial (${formatearMoneda(totalPagado)} de ${formatearMoneda(fijo.valor)}). ${faltanteTexto}`, restante, totalPagado };
      } else {
        return { claseFila: "", badgeClase: "badge-normal", texto: `Pago parcial (${formatearMoneda(totalPagado)} de ${formatearMoneda(fijo.valor)}). ${faltanteTexto}`, restante, totalPagado };
      }
    }

    if (diaHoy < venc - 7) {
      return { claseFila: "", badgeClase: "badge-normal", texto: "Pendiente", restante, totalPagado };
    } else if (diaHoy >= venc - 7 && diaHoy < venc) {
      return { claseFila: "fijo-amarillo", badgeClase: "badge-amarillo", texto: "Cerca del vencimiento", restante, totalPagado };
    } else {
      return { claseFila: "fijo-rojo", badgeClase: "badge-rojo", texto: "Vencido / día de vencimiento sin pago", restante, totalPagado };
    }
  }

  function rellenarTablaFijos() {
      const tb = document.querySelector("#tabla-fijos tbody"); tb.innerHTML="";
      const mes = obtenerAnioMesActual();
      fijosLocal.forEach(f => {
          const estado = estadoFijoParaMes(f, mes);
          const tr = document.createElement("tr");
          if (estado.claseFila) tr.classList.add(estado.claseFila);
          tr.innerHTML = `<td>${f.descripcion}</td><td>${formatearMoneda(f.valor)}</td><td>Día ${f.vencimiento}</td>
                          <td><span class="badge-estado ${estado.badgeClase}">${estado.texto}</span></td><td></td>`;
          const btn = document.createElement("button"); btn.className="btn-icon btn-icon-danger"; btn.textContent="Eliminar"; btn.onclick=()=>eliminarFijo(f.id);
          tr.lastElementChild.appendChild(btn);
          tb.appendChild(tr);
      });
      rellenarSelectGastosFijos();
  }
  function rellenarSelectTarjetas() {
      const s = document.getElementById("tarjeta-select"); s.innerHTML="";
      tarjetasLocal.forEach(t => {
          const o = document.createElement("option"); o.value=t.id; o.textContent=`${t.alias||""} ${t.digitos||""}`; s.appendChild(o);
      });
  }
  function rellenarTablaTarjetas() {
      const tb = document.querySelector("#tabla-tarjetas tbody"); tb.innerHTML="";
      tarjetasLocal.forEach(t => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${t.alias || ""}</td><td>${t.digitos || ""}</td><td>${t.banco || ""}</td><td></td>`;
          const btn = document.createElement("button"); btn.className="btn-icon btn-icon-danger"; btn.textContent="Eliminar"; btn.onclick=()=>eliminarTarjeta(t.id);
          tr.lastElementChild.appendChild(btn);
          tb.appendChild(tr);
      });
      rellenarSelectTarjetas();
  }
  
  function obtenerDescripcionFijoPorId(id) {
    const f = fijosLocal.find(x => x.id === id);
    return f ? f.descripcion : "";
  }
  function obtenerNombreCategoriaPorId(id) {
    const c = categoriasLocal.find(x => x.id === id);
    return c ? c.nome : "";
  }
  function obtenerTarjetaTextoPorId(id) {
    const t = tarjetasLocal.find(x => x.id === id);
    return t ? `${t.alias || ""} (${t.digitos || ""})` : "";
  }

  function rellenarTablaTransacciones() {
      const tb = document.querySelector("#tabla-transacciones tbody"); tb.innerHTML="";
      const mes = obtenerAnioMesActual();
      let l = transaccionesLocal.filter(t=>t.fecha.startsWith(mes));
      const ft = document.getElementById("filtro-texto").value.toLowerCase();
      const ff = document.getElementById("filtro-fecha").value;
      if(ft) l = l.filter(t=>(t.descripcion||"").toLowerCase().includes(ft));
      if(ff) l = l.filter(t=>t.fecha===ff);
      l.sort((a,b) => a.fecha<b.fecha?1:-1);
      
      l.forEach(t => {
          const tr = document.createElement("tr");
          
          let catNombre = "-";
          if (t.categoriaId === null && t.gastoFijoId) {
             catNombre = "Gasto fijo - " + obtenerDescripcionFijoPorId(t.gastoFijoId);
          } else {
             catNombre = obtenerNombreCategoriaPorId(t.categoriaId) || "-";
          }

          let origenTexto = "-";
          if (t.tipo === "salida") {
              if(t.origen === "tarjeta" && t.tarjetaId) {
                 origenTexto = "Tarjeta - " + obtenerTarjetaTextoPorId(t.tarjetaId);
              } else {
                 origenTexto = "Normal";
              }
          }

          tr.innerHTML = `<td>${t.fecha}</td><td><span class="tag ${t.tipo}">${t.tipo}</span></td><td>${catNombre}</td><td>${origenTexto}</td><td>${t.descripcion||""}</td><td>${formatearMoneda(t.valor)}</td><td></td>`;
          const btn = document.createElement("button"); btn.className="btn-icon btn-icon-danger"; btn.textContent="Eliminar"; btn.onclick=()=>eliminarTransaccion(t.id);
          tr.lastElementChild.appendChild(btn);
          tb.appendChild(tr);
      });
  }
  
  function inicializarInterfaz() {
      rellenarSelectCategorias();
      rellenarTablaCategorias();
      rellenarTablaFijos();
      rellenarTablaTarjetas();
      rellenarTablaTransacciones();
      rellenarPerfil();
      rellenarHistorialObjetivos();
      actualizarResumen();
      analisisLatam();
      actualizarObjetivo();
      actualizarCampoGastoFijo();
      actualizarCampoOrigenYTarjeta();
      inicializarReporte();
  }
  
  // Listeners
  document.getElementById("tipo").addEventListener("change", ()=>{rellenarSelectCategorias();actualizarCampoGastoFijo();actualizarCampoOrigenYTarjeta();});
  document.getElementById("categoria").addEventListener("change", actualizarCampoGastoFijo);
  document.getElementById("origen").addEventListener("change", actualizarCampoOrigenYTarjeta);
  document.getElementById("filtro-texto").addEventListener("input", rellenarTablaTransacciones);
  document.getElementById("filtro-fecha").addEventListener("change", rellenarTablaTransacciones);
  document.getElementById("btn-limpiar-filtros").addEventListener("click", ()=>{document.getElementById("filtro-texto").value="";document.getElementById("filtro-fecha").value="";rellenarTablaTransacciones();});
  
  window.addEventListener("load", async () => {
      const session = await nhost.auth.getSession();
      if(session && session.user) {
          usuarioActual = session.user;
          abrirApp();
      }
  });

  function rellenarPerfil() {
      if(!usuarioActual) return;
      document.getElementById("perfil-edad").value = edadUsuario||"";
      document.getElementById("perfil-meta").value = metaMensualUsuario||"";
      document.getElementById("perfil-ingreso").value = ingresoMensualUsuario||"";
      document.getElementById("perfil-sexo").value = sexoUsuario||"";
      document.getElementById("perfil-pais").value = paisUsuario||"";
      document.getElementById("perfil-moneda").value = monedaUsuario||"";
      document.getElementById("perfil-objetivo-nombre").value = objetivoNombre||"";
      document.getElementById("perfil-objetivo-valor").value = objetivoValor||"";
  }

  function actualizarResumen() {
    const transMes = filtrarMesActual(transaccionesLocal, "fecha");
    let totalEntradas = 0;
    let totalSalidas = 0;
    let totalSalidasFijos = 0;
    let totalSalidasOtros = 0;

    transMes.forEach(t => {
      if (t.tipo === "entrada") {
        totalEntradas += t.valor;
      } else if (t.tipo === "salida") {
        totalSalidas += t.valor;
        if (t.gastoFijoId) totalSalidasFijos += t.valor;
        else totalSalidasOtros += t.valor;
      }
    });

    const saldo = totalEntradas - totalSalidas;

    document.getElementById("stat-entradas").textContent = formatearMoneda(totalEntradas);
    document.getElementById("stat-salidas").textContent = formatearMoneda(totalSalidas);
    document.getElementById("stat-saldo").textContent = formatearMoneda(saldo);

    const saldoTexto = document.getElementById("stat-saldo-texto");
    if (saldo > 0) saldoTexto.textContent = "Estás con saldo positivo este mes.";
    else if (saldo < 0) saldoTexto.textContent = "Estás gastando más de lo que entra este mes.";
    else saldoTexto.textContent = "Saldo neutro por ahora.";

    let pctFijos = 0;
    let pctOtros = 0;
    const totalSalidasMes = totalSalidasFijos + totalSalidasOtros;
    if (totalSalidasMes > 0) {
      pctFijos = (totalSalidasFijos / totalSalidasMes) * 100;
      pctOtros = (totalSalidasOtros / totalSalidasMes) * 100;
    }

    document.getElementById("stat-lazer").textContent = pctFijos.toFixed(1) + "%";
    document.getElementById("stat-essenciais").textContent = pctOtros.toFixed(1) + "%";
    document.getElementById("barra-lazer").style.width = pctFijos + "%";
    document.getElementById("barra-essencial").style.width = pctOtros + "%";

    // Charts meta
    if(metaMensualUsuario > 0) {
        const uso = (totalSalidas/metaMensualUsuario)*100;
        dibujarGraficoMeta(uso);
        const hoy = new Date();
        const anioMes = obtenerAnioMesActual().split("-");
        const diasMes = new Date(parseInt(anioMes[0]), parseInt(anioMes[1]), 0).getDate();
        const gastoPromedioDia = totalSalidas / (hoy.getDate() || 1);
        const metaPorDia = metaMensualUsuario / diasMes;
        
        let txt = `Has usado ${uso.toFixed(1)}% de tu meta mensual. `;
        if (gastoPromedioDia > metaPorDia) txt += "Tu gasto promedio diario está por encima de lo ideal.";
        else txt += "Tu gasto promedio diario está dentro de lo ideal.";
        
        document.getElementById("stat-meta-uso").textContent = txt;
    } else {
        dibujarGraficoMeta(0);
        document.getElementById("stat-meta-uso").textContent = "Define una meta mensual en Perfil.";
    }

    if (ingresoMensualUsuario > 0) {
      const ratio = (totalSalidas / ingresoMensualUsuario) * 100;
      let msg = `Tus salidas representan aproximadamente ${ratio.toFixed(1)}% de tu ingreso mensual declarado. `;
      if (ratio < 50) msg += "Nivel saludable de gasto frente al ingreso.";
      else if (ratio <= 80) msg += "Nivel moderado. Está relativamente equilibrado.";
      else msg += "Alerta: tus gastos están muy cerca o por encima de tu ingreso mensual.";
      document.getElementById("stat-ingreso-alerta").textContent = msg;
    } else {
      document.getElementById("stat-ingreso-alerta").textContent = "Informa tu ingreso mensual en Perfil para ver la relación gasto/ingreso.";
    }
  }

  function actualizarObjetivo() {
      if(!objetivoNombre || !objetivoValor || objetivoValor <= 0) {
        document.getElementById("obj-nombre").textContent = "Sin objetivo definido";
        document.getElementById("obj-meta").textContent = "-";
        document.getElementById("obj-ahorrado").textContent = formatearMoneda(0);
        document.getElementById("obj-restante").textContent = formatearMoneda(0);
        document.getElementById("obj-texto").textContent = "Define un objetivo en Perfil.";
        dibujarGraficoObjetivo(0);
        rellenarHistorialObjetivos();
        return;
      }

      const ahorroTotal = calcularAhorroTotal();
      let ahorroObjetivo = ahorroTotal - objetivoAhorroBase;
      if (ahorroObjetivo < 0) ahorroObjetivo = 0;
      
      // Check completion
      if (!objetivoCompletado && ahorroObjetivo >= objetivoValor) {
         objetivoCompletado = true;
         const hoy = new Date().toISOString().slice(0,10);
         objetivosHistorial.push({ nombre: objetivoNombre, valorMeta: objetivoValor, ahorroFinal: ahorroObjetivo, fechaInicio: objetivoFechaInicio, fechaConclusion: hoy });
         guardarPerfilEnServidor();
      }
      
      const pct = (ahorroObjetivo/objetivoValor)*100;
      const restante = objetivoValor - ahorroObjetivo;

      document.getElementById("obj-nombre").textContent = objetivoNombre;
      document.getElementById("obj-meta").textContent = formatearMoneda(objetivoValor);
      document.getElementById("obj-ahorrado").textContent = formatearMoneda(ahorroObjetivo);
      document.getElementById("obj-restante").textContent = formatearMoneda(restante > 0 ? restante : 0);
      
      if (restante <= 0) document.getElementById("obj-texto").textContent = "¡Objetivo alcanzado!";
      else document.getElementById("obj-texto").textContent = `Has avanzado ${pct.toFixed(1)}%`;
      
      dibujarGraficoObjetivo(pct);
      rellenarHistorialObjetivos();
  }

  function rellenarHistorialObjetivos() {
    const tb = document.querySelector("#tabla-historial-objetivos tbody"); tb.innerHTML = "";
    objetivosHistorial.forEach(o => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${o.nombre}</td><td>${formatearMoneda(o.valorMeta)}</td><td>${formatearMoneda(o.ahorroFinal)}</td><td>${o.fechaInicio}</td><td>${o.fechaConclusion}</td>`;
      tb.appendChild(tr);
    });
  }

  function calcularAhorroTotal() {
     let e=0, s=0;
     transaccionesLocal.forEach(t => { if(t.tipo==="entrada") e+=t.valor; else s+=t.valor; });
     return Math.max(0, e-s);
  }

  function analisisLatam() {
    const edad = parseInt(perfilEdadInput.value || "0", 10) || 0;
    const pais = perfilPaisInput.value;
    if (!metaMensualUsuario || metaMensualUsuario <= 0 || !pais || !edad) {
      perfilAnalisis.textContent = "Para ver el análisis comparativo, completa país, edad y una meta mensual de gasto.";
      return;
    }
    const base = { bo: 1500, br: 3000, ar: 250000, cl: 400000, mx: 9000, otro: 700 };
    const nombrePais = { bo: "Bolivia", br: "Brasil", ar: "Argentina", cl: "Chile", mx: "México", otro: "otro país de LATAM" };
    const basePais = base[pais] || base.otro;
    let factorEdad = 1;
    if (edad < 25) factorEdad = 0.85; else if (edad < 36) factorEdad = 1.0; else if (edad < 51) factorEdad = 1.1; else factorEdad = 0.95;
    const referencia = basePais * factorEdad;
    const ratio = referencia > 0 ? (metaMensualUsuario / referencia) * 100 : 0;
    let mensaje;
    if (ratio < 70) mensaje = `Tu meta está por debajo del gasto promedio estimado para una persona de tu edad en ${nombrePais[pais]}.`;
    else if (ratio <= 120) mensaje = `Tu meta está en un rango razonable comparado con un gasto promedio estimado para tu perfil en ${nombrePais[pais]}.`;
    else mensaje = `Tu meta de gasto está por encima del nivel promedio estimado para tu edad en ${nombrePais[pais]}.`;
    const refTexto = formatearMoneda(referencia);
    perfilAnalisis.textContent = mensaje + ` Referencia aprox: ${refTexto}. Cálculo orientativo.`;
  }

  function actualizarCampoGastoFijo() {
      const t = document.getElementById("tipo").value;
      const c = document.getElementById("categoria").value;
      const el = document.getElementById("campo-gasto-fijo");
      if(el) el.classList.toggle("hidden", !(t==="salida" && c==="__gasto_fijo__"));
  }
  function actualizarCampoOrigenYTarjeta() {
      const t = document.getElementById("tipo").value;
      const o = document.getElementById("origen").value;
      const divO = document.getElementById("campo-origen");
      const divT = document.getElementById("campo-tarjeta");
      if(t==="salida") {
          divO.classList.remove("hidden");
          divT.classList.toggle("hidden", o!=="tarjeta");
      } else {
          divO.classList.add("hidden");
          divT.classList.add("hidden");
      }
  }

  function inicializarReporte() {
    const mesesSet = new Set();
    transaccionesLocal.forEach(t => { if (t.fecha && t.fecha.length >= 7) mesesSet.add(t.fecha.slice(0, 7)); });
    if (mesesSet.size === 0) mesesSet.add(obtenerAnioMesActual());
    const meses = Array.from(mesesSet).sort();
    const sel = document.getElementById("reporte-mes"); sel.innerHTML = "";
    meses.forEach(m => {
      const opt = document.createElement("option"); opt.value = m; opt.textContent = nombreMes(m); sel.appendChild(opt);
    });
    const actual = obtenerAnioMesActual();
    if (meses.includes(actual)) sel.value = actual;
    actualizarReporte();
  }
  
  document.getElementById("reporte-mes").addEventListener("change", actualizarReporte);
  document.getElementById("reporte-mes-actual").addEventListener("click", () => {
     document.getElementById("reporte-mes").value = obtenerAnioMesActual();
     actualizarReporte();
  });

  // Funcoes graficas
  function dibujarGraficoMeta(porcentajeUsado) {
    const canvas = document.getElementById("meta-chart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width;
    const h = canvas.height;
    const cx = w / 2;
    const cy = h / 2;
    const radio = Math.min(w, h) / 2 - 10;
    const innerRadio = radio * 0.6;
    ctx.clearRect(0, 0, w, h);
    ctx.beginPath();
    ctx.arc(cx, cy, radio, 0, Math.PI * 2);
    ctx.fillStyle = "#111827";
    ctx.fill();
    const clamped = Math.max(0, Math.min(porcentajeUsado, 200)) / 100;
    const inicio = -Math.PI / 2;
    const fin = inicio + Math.PI * 2 * clamped;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radio, inicio, fin);
    ctx.closePath();
    ctx.fillStyle = "#22c55e";
    ctx.fill();
    if (clamped < 1) {
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radio, fin, inicio + Math.PI * 2);
      ctx.closePath();
      ctx.fillStyle = "#4b5563";
      ctx.fill();
    }
    ctx.beginPath();
    ctx.arc(cx, cy, innerRadio, 0, Math.PI * 2);
    ctx.fillStyle = "#020617";
    ctx.fill();
  }

  function dibujarGraficoObjetivo(porcentaje) {
    const canvas = document.getElementById("objetivo-chart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width;
    const h = canvas.height;
    const cx = w / 2;
    const cy = h / 2;
    const radio = Math.min(w, h) / 2 - 10;
    const innerRadio = radio * 0.6;
    ctx.clearRect(0, 0, w, h);
    ctx.beginPath();
    ctx.arc(cx, cy, radio, 0, Math.PI * 2);
    ctx.fillStyle = "#111827";
    ctx.fill();
    const clamped = Math.max(0, Math.min(porcentaje, 200)) / 100;
    const inicio = -Math.PI / 2;
    const fin = inicio + Math.PI * 2 * clamped;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radio, inicio, fin);
    ctx.closePath();
    ctx.fillStyle = "#0ea5e9";
    ctx.fill();
    if (clamped < 1) {
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radio, fin, inicio + Math.PI * 2);
      ctx.closePath();
      ctx.fillStyle = "#4b5563";
      ctx.fill();
    }
    ctx.beginPath();
    ctx.arc(cx, cy, innerRadio, 0, Math.PI * 2);
    ctx.fillStyle = "#020617";
    ctx.fill();
  }

</script>
</body>
</html>
