<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Control Financiero (Prism Glass)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* --- TEMA PRISM GLASS (FUTURISTA ELEGANTE & FLUTUANTE) --- */
:root {
 /* Fundo Profundo */
 --bg-deep: #020617;
 
 /* Cores Prism (Neon Suave) */
 --primary-glow: #8b5cf6;  /* Violeta */
 --secondary-glow: #ec4899; /* Rosa */
 --accent-cyan: #06b6d4;   /* Ciano */
 
 /* Textos */
 --text-primary: #f8fafc;
 --text-secondary: #94a3b8;
 --text-muted: #64748b;
 
 /* Vidro */
 --glass-bg: rgba(255, 255, 255, 0.03);
 --glass-border: rgba(255, 255, 255, 0.08);
 --glass-highlight: rgba(255, 255, 255, 0.15);
 --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
 font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
 background-color: var(--bg-deep);
 color: var(--text-primary);
 padding-bottom: 3rem;
 min-height: 100vh;
 overflow-x: hidden;
 position: relative;
}

/* --- BACKGROUND ANIMADO (AURORA) --- */
body::before {
 content: '';
 position: fixed;
 top: -20%;
 left: -10%;
 width: 600px;
 height: 600px;
 background: radial-gradient(circle, var(--secondary-glow), transparent 70%);
 opacity: 0.15;
 filter: blur(100px);
 z-index: -1;
 animation: floatAurora1 15s infinite alternate ease-in-out;
}

body::after {
 content: '';
 position: fixed;
 bottom: -10%;
 right: -10%;
 width: 500px;
 height: 500px;
 background: radial-gradient(circle, var(--primary-glow), transparent 70%);
 opacity: 0.15;
 filter: blur(100px);
 z-index: -1;
 animation: floatAurora2 18s infinite alternate ease-in-out;
}

@keyframes floatAurora1 { 0% { transform: translate(0,0); } 100% { transform: translate(50px, 50px); } }
@keyframes floatAurora2 { 0% { transform: translate(0,0); } 100% { transform: translate(-50px, -30px); } }

/* INDICADOR DE CARREGAMENTO */
#loading-overlay {
 position: fixed;
 top: 0; left: 0; right: 0; bottom: 0;
 background: rgba(2, 6, 23, 0.95);
 z-index: 100;
 display: flex;
 align-items: center;
 justify-content: center;
 font-weight: 600;
 color: var(--primary-glow);
 font-size: 1.2rem;
 backdrop-filter: blur(10px);
 letter-spacing: 2px;
 text-transform: uppercase;
}

/* HEADER */
header {
 background: rgba(15, 23, 42, 0.7);
 backdrop-filter: blur(20px);
 -webkit-backdrop-filter: blur(20px);
 border-bottom: 1px solid var(--glass-border);
 padding: 1rem 1.5rem;
 display: flex;
 align-items: center;
 justify-content: space-between;
 position: sticky;
 top: 0;
 z-index: 50;
}

header h1 {
 font-size: 1.2rem;
 font-weight: 700;
 background: linear-gradient(to right, #fff, #cbd5e1);
 -webkit-background-clip: text;
 -webkit-text-fill-color: transparent;
 letter-spacing: -0.5px;
}

header .user-info {
 font-size: 0.85rem;
 display: flex;
 align-items: center;
 gap: 1rem;
 color: var(--text-secondary);
}

header button {
 margin-left: 0.5rem;
 padding: 0.4rem 1rem;
 border-radius: 99px;
 border: 1px solid var(--glass-border);
 cursor: pointer;
 font-size: 0.8rem;
 background: rgba(255, 255, 255, 0.05);
 color: #e5e7eb;
 transition: all 0.3s;
}

header button:hover {
 background: rgba(255, 255, 255, 0.15);
 border-color: rgba(255, 255, 255, 0.3);
}

/* --- SELETOR DE IDIOMA (ESTILO) --- */
.lang-select {
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-secondary);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
    cursor: pointer;
    outline: none;
    transition: all 0.2s;
}
.lang-select:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}
.lang-select option {
    background: #0f172a;
    color: #fff;
}

.container {
 display: flex;
 min-height: calc(100vh - 70px);
}

/* SIDEBAR */
nav {
 width: 240px;
 background: rgba(15, 23, 42, 0.4);
 backdrop-filter: blur(16px);
 border-right: 1px solid var(--glass-border);
 color: var(--text-secondary);
 padding: 1.5rem 1rem;
 position: sticky;
 top: 70px;
 height: calc(100vh - 70px);
}

nav h2 {
 font-size: 0.75rem;
 text-transform: uppercase;
 margin-bottom: 1rem;
 color: #64748b;
 letter-spacing: 2px;
 padding-left: 0.5rem;
}

nav button {
 width: 100%;
 text-align: left;
 background: transparent;
 border: none;
 color: inherit;
 padding: 0.75rem 1rem;
 border-radius: 16px;
 cursor: pointer;
 font-size: 0.9rem;
 display: flex;
 align-items: center;
 gap: 0.8rem;
 transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
 margin-bottom: 0.5rem;
}

nav button:hover {
 background: rgba(255, 255, 255, 0.05);
 color: #fff;
 transform: translateX(4px);
}

nav button.active {
 background: linear-gradient(90deg, rgba(139, 92, 246, 0.15), transparent);
 color: #fff;
 border-left: 3px solid var(--primary-glow);
 box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
}

/* Removemos a bolinha do estilo anterior para ficar mais clean */
nav button::before { display: none; }

main {
 flex: 1;
 padding: 2rem;
 overflow-y: auto;
}

.main-inner {
 max-width: 1150px;
 margin: 0 auto;
}

/* --- CARDS FLUTUANTES (PRISM STYLE) --- */
.card {
 background: var(--glass-bg);
 backdrop-filter: blur(24px);
 -webkit-backdrop-filter: blur(24px);
 border-radius: 24px;
 padding: 2rem;
 margin-bottom: 2rem;
 border: 1px solid var(--glass-border);
 box-shadow: var(--glass-shadow);
 
 /* Anima√ß√£o de flutua√ß√£o */
 transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), border-color 0.3s, box-shadow 0.3s;
 position: relative;
 overflow: hidden;
}

/* Brilho ao passar o mouse e leve subida */
.card:hover {
 transform: translateY(-6px);
 border-color: rgba(255, 255, 255, 0.2);
 box-shadow: 0 20px 40px -10px rgba(139, 92, 246, 0.2);
 background: rgba(255, 255, 255, 0.06);
}

.card h3 {
 font-size: 1.2rem;
 margin-bottom: 0.5rem;
 font-weight: 600;
 color: #fff;
 letter-spacing: 0.5px;
}

.card-subtitle {
 font-size: 0.85rem;
 color: var(--text-secondary);
 margin-bottom: 1.5rem;
 font-weight: 300;
}

.grid {
 display: grid;
 grid-template-columns: repeat(3, minmax(0, 1fr));
 gap: 1.5rem;
}

.stat {
 background: rgba(0, 0, 0, 0.2);
 border-radius: 16px;
 padding: 1.2rem;
 border: 1px solid rgba(255, 255, 255, 0.03);
 transition: background 0.2s;
}
.stat:hover {
 background: rgba(0, 0, 0, 0.3);
}

.stat-label {
 font-size: 0.75rem;
 color: var(--text-secondary);
 margin-bottom: 0.4rem;
 text-transform: uppercase;
 letter-spacing: 1px;
}

.stat-value {
 font-size: 1.5rem;
 font-weight: 700;
 color: #fff;
 text-shadow: 0 0 20px rgba(255,255,255,0.1);
}

.stat-small {
 font-size: 0.8rem;
 color: #64748b;
 margin-top: 0.3rem;
}

.stat-prediction {
  font-size: 0.8rem;
  color: var(--accent-cyan);
  margin-top: 0.8rem;
  font-style: italic;
  border-top: 1px solid var(--glass-border);
  padding-top: 0.5rem;
}

/* Cores de status */
.semaforo-verde { color: #4ade80; text-shadow: 0 0 12px rgba(74, 222, 128, 0.4); }
.semaforo-amarillo { color: #facc15; text-shadow: 0 0 12px rgba(250, 204, 21, 0.4); }
.semaforo-rojo { color: #f87171; text-shadow: 0 0 12px rgba(248, 113, 113, 0.4); animation: pulse 2s infinite; }

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.6; transform: scale(1.02); }
  100% { opacity: 1; }
}

/* Barras de distribui√ß√£o */
.dist-row {
   display: flex;
   align-items: center;
   justify-content: space-between;
   margin-bottom: 1rem;
   font-size: 0.85rem;
}
.dist-bar-bg {
   flex: 1;
   height: 8px;
   background: rgba(255, 255, 255, 0.05);
   border-radius: 999px;
   margin: 0 1.2rem;
   overflow: hidden;
}
.dist-bar-fill {
   height: 100%;
   border-radius: 999px;
   box-shadow: 0 0 10px currentColor;
}

/* Formul√°rios */
form {
 display: grid;
 grid-template-columns: repeat(4, minmax(0, 1fr));
 gap: 1.2rem;
 margin-top: 1rem;
 align-items: end;
}

form .full {
 grid-column: 1 / -1;
}

label {
 font-size: 0.8rem;
 color: #cbd5e1;
 margin-bottom: 0.4rem;
 display: block;
 font-weight: 500;
}

input, select {
 width: 100%;
 padding: 0.8rem 1rem;
 border-radius: 14px;
 border: 1px solid var(--glass-border);
 font-size: 0.9rem;
 background: rgba(0, 0, 0, 0.3);
 color: #fff;
 transition: all 0.2s;
}

input::placeholder {
 color: #475569;
}

input:focus,
select:focus {
 outline: none;
 border-color: var(--primary-glow);
 background: rgba(0, 0, 0, 0.5);
 box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
}

/* Bot√µes */
button.primary {
 background: linear-gradient(135deg, var(--secondary-glow), var(--primary-glow));
 color: #fff;
 border-radius: 14px;
 padding: 0.8rem 1.5rem;
 border: none;
 cursor: pointer;
 font-size: 0.9rem;
 font-weight: 600;
 box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
 transition: all 0.3s;
 letter-spacing: 0.5px;
}

button.primary:hover {
 transform: translateY(-2px);
 box-shadow: 0 8px 25px rgba(139, 92, 246, 0.5);
 filter: brightness(1.1);
}

button.secondary {
  background: rgba(255, 255, 255, 0.05);
  color: #fff;
  border-radius: 14px;
  padding: 0.6rem 1.2rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 500;
  backdrop-filter: blur(4px);
  transition: all 0.2s;
}
button.secondary:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: #fff;
}

/* ============================================================ */
/* NOVO ESTILO DO BOT√ÉO REINICIAR - COM GRADIENTE E PRESEN√áA */
/* ============================================================ */
button.danger-action {
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.2), rgba(153, 27, 27, 0.1));
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(248, 113, 113, 0.4);
    color: #fca5a5;
    font-weight: 600;
    font-size: 0.95rem;
    letter-spacing: 0.5px;
    width: 100%;
    padding: 1rem;
    border-radius: 16px;
    margin-top: 1.5rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

button.danger-action:hover {
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.4), rgba(185, 28, 28, 0.3));
    border-color: #ef4444;
    color: #ffffff;
    box-shadow: 0 0 25px rgba(239, 68, 68, 0.5);
    transform: translateY(-3px);
}

button.danger-action:active {
    transform: scale(0.98);
}
/* ============================================================ */

.btn-icon {
 border-radius: 10px;
 border: 1px solid var(--glass-border);
 background: rgba(0, 0, 0, 0.2);
 color: var(--text-secondary);
 font-size: 0.75rem;
 padding: 0.4rem 0.8rem;
 cursor: pointer;
 line-height: 1.2;
 transition: all 0.2s;
}
.btn-icon:hover {
  background: rgba(255,255,255,0.1);
  color: #fff;
}

.btn-icon-danger {
 border-color: rgba(239, 68, 68, 0.3);
 color: #fca5a5;
}

.btn-icon-danger:hover {
 background: rgba(239, 68, 68, 0.15);
 border-color: #ef4444;
 color: #fff;
}

.tabla-wrapper {
 margin-top: 1rem;
 overflow-x: auto;
 border-radius: 16px;
 border: 1px solid var(--glass-border);
 background: rgba(0, 0, 0, 0.2);
}

table {
 width: 100%;
 border-collapse: collapse;
 font-size: 0.9rem;
 color: var(--text-primary);
}

th, td {
 border-bottom: 1px solid var(--glass-border);
 padding: 1rem 1.2rem;
 text-align: left;
 white-space: nowrap;
}

th {
 background: rgba(0, 0, 0, 0.3);
 font-weight: 600;
 color: var(--text-secondary);
 text-transform: uppercase;
 font-size: 0.75rem;
 letter-spacing: 1px;
 position: sticky;
 top: 0;
 z-index: 1;
}

tr:hover td {
  background: rgba(255, 255, 255, 0.02);
}

tr:last-child td {
  border-bottom: none;
}

.tag {
 display: inline-flex;
 align-items: center;
 padding: 0.25rem 0.7rem;
 border-radius: 8px;
 font-size: 0.7rem;
 font-weight: 600;
 margin-right: 0.25rem;
 text-transform: uppercase;
 letter-spacing: 0.5px;
}

.tag.entrada {
 border: 1px solid rgba(16, 185, 129, 0.3);
 background: rgba(16, 185, 129, 0.1);
 color: #6ee7b7;
}
.tag.salida {
 border: 1px solid rgba(249, 115, 22, 0.3);
 background: rgba(249, 115, 22, 0.1);
 color: #fdba74;
}

.hidden { display: none !important; }

/* LOGIN */
#login-screen {
 min-height: 100vh;
 display: flex;
 align-items: center;
 justify-content: center;
 padding: 1rem;
 position: relative;
 z-index: 10;
}

#login-box {
 background: var(--glass-bg);
 backdrop-filter: blur(30px);
 -webkit-backdrop-filter: blur(30px);
 border-radius: 30px;
 border: 1px solid var(--glass-border);
 padding: 3rem;
 width: 100%;
 max-width: 420px;
 box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.6);
}

#login-box h2 {
 font-size: 1.6rem;
 margin-bottom: 0.5rem;
 text-align: center;
 color: #fff;
}

#login-box p {
 font-size: 0.9rem;
 color: var(--text-secondary);
 margin-bottom: 2.5rem;
 text-align: center;
}

#login-box form {
 display: grid;
 grid-template-columns: 1fr;
 gap: 1.5rem;
}

#login-box button.primary {
 width: 100%;
 margin-top: 1rem;
 padding: 1rem;
 font-size: 1rem;
}

#login-toggle {
 display: flex;
 justify-content: center;
 gap: 0.5rem;
 margin-top: 2rem;
 font-size: 0.9rem;
 color: var(--text-secondary);
}

#login-toggle button {
 background: transparent;
 color: var(--primary-glow);
 padding: 0;
 box-shadow: none;
 border: none;
 font-weight: 600;
}

#login-message {
 font-size: 0.85rem;
 margin-top: 1rem;
 min-height: 1.2rem;
 color: var(--secondary-glow);
 text-align: center;
}

#register-extra {
 display: grid;
 grid-template-columns: 1fr;
 gap: 0.75rem;
}

/* ESTADOS ESPEC√çFICOS DE GASTOS FIJOS */
.fijo-amarillo { background: rgba(234, 179, 8, 0.1) !important; }
.fijo-rojo { background: rgba(239, 68, 68, 0.1) !important; }
.fijo-verde { background: rgba(34, 197, 94, 0.1) !important; }

.badge-estado {
 display: inline-flex;
 align-items: center;
 padding: 0.15rem 0.6rem;
 border-radius: 99px;
 font-size: 0.7rem;
 font-weight: 600;
}
.badge-amarillo { background: rgba(250, 204, 21, 0.2); color: #fef08a; border: 1px solid rgba(250, 204, 21, 0.3); }
.badge-rojo { background: rgba(248, 113, 113, 0.2); color: #fecaca; border: 1px solid rgba(248, 113, 113, 0.3); }
.badge-verde { background: rgba(74, 222, 128, 0.2); color: #bbf7d0; border: 1px solid rgba(74, 222, 128, 0.3); }
.badge-normal { background: rgba(255, 255, 255, 0.1); color: #e2e8f0; }

.reporte-controles {
 margin-top: 0.5rem;
 display: flex;
 flex-wrap: wrap;
 gap: 1rem;
 align-items: flex-end;
}
.reporte-controles > div {
 min-width: 160px;
}

/* MODAL */
.modal {
 position: fixed;
 inset: 0;
 background: rgba(0, 0, 0, 0.8);
 backdrop-filter: blur(8px);
 display: flex;
 align-items: center;
 justify-content: center;
 z-index: 40;
}

@media (max-width: 900px) {
 .grid { grid-template-columns: 1fr; }
 form { grid-template-columns: 1fr; }
}

@media (max-width: 768px) {
 nav { display: none; position: fixed; top: 70px; left: 0; height: calc(100vh - 70px); z-index: 20; width: 100%; background: rgba(15,23,42,0.95); backdrop-filter: blur(20px); }
 nav.open { display: block; }
 .container { flex-direction: column; }
 main { padding: 1.5rem; }
 .main-inner { max-width: 100%; }
 header button#menu-toggle { display: inline-block; }
}

@media (min-width: 769px) {
 header button#menu-toggle { display: none; }
}
/* --- AJUSTE MOBILE: ESCONDER EMAIL --- */
@media (max-width: 768px) {
  /* Remove o email da tela para dar espa√ßo ao seletor */
  header .user-info #user-email {
    display: none;
  }
  
  /* Ajusta o espa√ßamento entre o seletor e o bot√£o sair */
  header .user-info {
    gap: 0.5rem;
  }
}


</style>
</head>
<body>

<div id="loading-overlay" class="hidden">Cargando datos...</div>

<section id="login-screen">
<div id="login-box">
<h2 data-i18n="login_title">Control Financiero</h2>

<div style="display:flex; justify-content:center; margin-bottom:1.5rem;">
    <select id="lang-select-login" class="lang-select">
        <option value="es">üá™üá∏ Espa√±ol</option>
        <option value="pt">üáßüá∑ Portugu√™s</option>
    </select>
</div>

<p data-i18n="login_subtitle">Inicia sesi√≥n (Prism Edition)</p>

<form id="login-form">
<div>
  <label for="login-email" data-i18n="lbl_email">Correo electr√≥nico</label>
  <input type="email" id="login-email" required placeholder="tu@ejemplo.com" />
</div>
<div>
  <label for="login-password" data-i18n="lbl_pass">Contrase√±a</label>
  <input type="password" id="login-password" required />
</div>

<div id="register-extra" class="hidden">
  <p style="font-size:0.75rem; color:var(--secondary-glow); text-align:center;" data-i18n="login_extra_info">Datos adicionales se configuran en Perfil.</p>
</div>

<button type="submit" class="primary" id="login-submit" data-i18n="btn_enter">Entrar</button>
<div id="login-toggle">
  <span id="toggle-text" data-i18n="msg_no_account">¬øNo tienes cuenta?</span>
  <button type="button" id="toggle-mode" data-i18n="btn_create">Crear cuenta</button>
</div>
<div id="login-message"></div>
</form>
</div>
</section>
<div id="app" class="hidden">
<header>
<div style="display:flex; align-items:center; gap:0.5rem;">
<button id="menu-toggle">‚ò∞</button>
<h1 data-i18n="login_title">Control Financiero</h1>
</div>
<div class="user-info">
<select id="lang-select-app" class="lang-select" style="margin-right:0.5rem;">
    <option value="es">üá™üá∏ ES</option>
    <option value="pt">üáßüá∑ PT</option>
</select>

<span id="user-email"></span>
<button id="logout-btn" data-i18n="btn_logout">Salir</button>
</div>
</header>

<div class="container">
<nav id="sidebar">
<h2 data-i18n="menu_title">MEN√ö</h2>
<button data-section="dashboard" class="active" data-i18n="menu_dashboard">Inicio</button>
<button data-section="transacciones" data-i18n="menu_transacciones">Transacciones</button>
<button data-section="fijos" data-i18n="menu_fijos">Gastos fijos</button>
<button data-section="tarjetas" data-i18n="menu_tarjetas">Tarjetas</button>
<button data-section="reportes" data-i18n="menu_reportes">Reporte mensual</button>
<button data-section="categorias" data-i18n="menu_categorias">Categor√≠as</button>
<button data-section="perfil" data-i18n="menu_perfil">Perfil</button>
</nav>

<main>
<div class="main-inner">

  <section id="section-dashboard">
    <div class="card">
      <h3 data-i18n="dash_resumen_title">Resumen del mes actual</h3>
      <div style="display:flex; flex-wrap:wrap; gap:1.5rem; align-items:stretch; margin-top:1rem;">
        <div style="flex:2 1 220px;">
          <div class="grid">
            <div class="stat">
              <div class="stat-label" data-i18n="stat_entradas">Entradas</div>
              <div class="stat-value" id="stat-entradas" style="color: #4ade80;">$ 0,00</div>
            </div>
            <div class="stat">
              <div class="stat-label" data-i18n="stat_salidas">Salidas</div>
              <div class="stat-value" id="stat-salidas" style="color: #f87171;">$ 0,00</div>
            </div>
            <div class="stat">
              <div class="stat-label" data-i18n="stat_saldo">Saldo</div>
              <div class="stat-value" id="stat-saldo">$ 0,00</div>
              <div class="stat-small" id="stat-saldo-texto"></div>
            </div>
          </div>
        </div>
        <div style="flex:1 1 200px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
          <div style="position: relative; width: 160px; height: 160px;">
             <canvas id="meta-chart" width="160" height="160"></canvas>
          </div>
          <div class="stat-small" id="stat-meta-uso" style="margin-top:0.8rem; text-align:center; font-weight: 600;"></div>
          <div class="stat-small" id="stat-ingreso-alerta" style="margin-top:0.25rem; text-align:center;"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
         <h3 data-i18n="dash_obj_title">Objetivo de ahorro</h3>
         <button type="button" class="secondary" id="btn-abrir-simulador" data-i18n="btn_simular">üîÆ Simular</button>
      </div>
      <p class="card-subtitle" data-i18n="dash_obj_subtitle">
        Define un objetivo en la secci√≥n Perfil.
      </p>
      <div style="display:flex; flex-wrap:wrap; gap:1.5rem; align-items:stretch; margin-top:1rem;">
        <div style="flex:2 1 220px;">
          <div class="stat" style="margin-bottom:1rem; border-left: none;">
            <div class="stat-label" data-i18n="lbl_obj_activo">Objetivo Activo</div>
            <div class="stat-value" id="obj-nombre">Sin objetivo definido</div>
            <div class="stat-small">
              Meta: <span id="obj-meta">-</span>
            </div>
          </div>
          <div class="grid">
            <div class="stat">
              <div class="stat-label" data-i18n="lbl_ahorro_acumulado">Ahorro acumulado</div>
              <div class="stat-value" id="obj-ahorrado">$ 0,00</div>
            </div>
            <div class="stat">
              <div class="stat-label" data-i18n="lbl_falta">Falta para el objetivo</div>
              <div class="stat-value" id="obj-restante">$ 0,00</div>
            </div>
            <div class="stat">
              <div class="stat-label" data-i18n="lbl_detalle">Detalle y Proyecci√≥n</div>
              <div class="stat-small" id="obj-texto"></div>
              <div class="stat-prediction" id="obj-proyeccion"></div>
            </div>
          </div>
        </div>
        <div style="flex:1 1 200px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
          <div style="position: relative; width: 160px; height: 160px;">
              <canvas id="objetivo-chart" width="160" height="160"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
        <h3 data-i18n="dash_travel_title">Proyecci√≥n Financiera (Viajero en el Tiempo)</h3>
        <div style="width:100%; overflow-x:auto; margin-top:1rem;">
            <canvas id="chart-time-travel" width="600" height="160" style="min-width:100%;"></canvas>
        </div>
     </div>

    <div class="card">
      <h3 data-i18n="dash_dist_title">Distribuci√≥n de salidas del mes</h3>
      <div id="contenedor-distribucion" style="margin-top:1rem;">
        <div style="text-align:center; color:#64748b; font-size:0.9rem; padding:1rem;">...</div>
      </div>
    </div>
  </section>

  <section id="section-transacciones" class="hidden">
    <div class="card">
      <h3 data-i18n="trans_new_title">Nueva transacci√≥n</h3>
      <form id="form-transaccion">
        <div>
          <label for="tipo" data-i18n="lbl_tipo">Tipo</label>
          <select id="tipo" required>
            <option value="entrada" data-i18n="opt_entrada">Entrada</option>
            <option value="salida" data-i18n="opt_salida">Salida</option>
          </select>
        </div>
        <div>
          <label for="categoria" data-i18n="lbl_cat">Categor√≠a</label>
          <select id="categoria" required></select>
        </div>
        <div id="campo-origen" class="hidden">
          <label for="origen" data-i18n="lbl_origen">Origen (solo salidas)</label>
          <select id="origen">
            <option value="efectivo" data-i18n="opt_efectivo">Efectivo</option>
            <option value="tarjeta" data-i18n="opt_tarjeta">Tarjeta</option>
          </select>
        </div>
        <div id="campo-tarjeta" class="hidden">
          <label for="tarjeta-select" data-i18n="menu_tarjetas">Tarjeta</label>
          <select id="tarjeta-select"></select>
        </div>
        <div>
          <label for="valor" data-i18n="lbl_valor">Valor</label>
          <input type="text" id="valor" required placeholder="Ej: 1.300,50" />
        </div>
        <div>
          <label for="data" data-i18n="lbl_fecha">Fecha</label>
          <input type="date" id="data" required />
        </div>
        <div id="campo-gasto-fijo" class="hidden">
          <label for="gasto-fijo-select" data-i18n="lbl_cat">Gasto Fijo</label>
          <select id="gasto-fijo-select"></select>
        </div>
        <div class="full">
          <label for="descripcion" data-i18n="lbl_desc">Descripci√≥n</label>
          <input type="text" id="descripcion" />
        </div>
        <div>
          <button type="submit" class="primary" data-i18n="btn_add">A√±adir</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3 data-i18n="trans_list_title">Transacciones del mes</h3>
      
      <div style="margin-top:1rem; display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end;">
        <div style="flex: 1;">
          <label for="filtro-texto" data-i18n="lbl_desc">Buscar</label>
          <input type="text" id="filtro-texto" data-i18n="placeholder_search" placeholder="Ej: mercado, cine..." />
        </div>
        <div>
          <label for="filtro-fecha" data-i18n="lbl_fecha">Filtrar</label>
          <input type="date" id="filtro-fecha" />
        </div>
        <div>
          <button type="button" class="secondary" id="btn-limpiar-filtros" data-i18n="btn_clean_filter">Limpiar filtros</button>
        </div>
      </div>

      <div class="tabla-wrapper">
        <table id="tabla-transacciones">
          <thead>
            <tr>
              <th data-i18n="lbl_fecha">Fecha</th>
              <th data-i18n="lbl_tipo">Tipo</th>
              <th data-i18n="lbl_cat">Categor√≠a</th>
              <th data-i18n="lbl_origen">Origen</th>
              <th data-i18n="lbl_desc">Descripci√≥n</th>
              <th data-i18n="lbl_valor">Valor</th>
              <th>#</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="section-fijos" class="hidden">
    <div class="card">
      <h3 data-i18n="menu_fijos">Nuevo gasto fijo</h3>
      <form id="form-fijo">
        <div>
          <label for="fijo-descripcion" data-i18n="lbl_desc">Descripci√≥n</label>
          <input type="text" id="fijo-descripcion" required />
        </div>
        <div>
          <label for="fijo-valor" data-i18n="lbl_valor">Valor mensual</label>
          <input type="text" id="fijo-valor" required />
        </div>
        <div>
          <label for="fijo-vencimiento" data-i18n="lbl_fecha">D√≠a de vencimiento</label>
          <input type="number" id="fijo-vencimiento" min="1" max="31" required />
        </div>
        <div>
          <button type="submit" class="primary" data-i18n="btn_add">A√±adir</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3 data-i18n="menu_fijos">Gastos fijos registrados</h3>
      <div class="tabla-wrapper">
        <table id="tabla-fijos">
          <thead>
            <tr>
              <th data-i18n="lbl_desc">Descripci√≥n</th>
              <th data-i18n="lbl_valor">Valor</th>
              <th data-i18n="lbl_fecha">Vencimiento</th>
              <th>Estado</th>
              <th>#</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="section-tarjetas" class="hidden">
    <div class="card">
      <h3 data-i18n="menu_tarjetas">Registrar tarjeta</h3>
      <form id="form-tarjeta">
        <div>
          <label for="tarjeta-alias" data-i18n="lbl_desc">Propietario / Alias</label>
          <input type="text" id="tarjeta-alias" placeholder="Ej: Juan P√©rez" />
        </div>
        <div>
          <label for="tarjeta-digitos">√öltimos 4 d√≠gitos</label>
          <input type="text" id="tarjeta-digitos" maxlength="6" placeholder="1234" />
        </div>
        <div>
          <label for="tarjeta-banco">Banco</label>
          <input type="text" id="tarjeta-banco" />
        </div>
        <div>
          <button type="submit" class="primary" data-i18n="btn_add">A√±adir tarjeta</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3 data-i18n="menu_tarjetas">Tarjetas registradas</h3>
      <div class="tabla-wrapper">
        <table id="tabla-tarjetas">
          <thead>
            <tr>
              <th>Propietario</th>
              <th>D√≠gitos</th>
              <th>Banco</th>
              <th>#</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="section-reportes" class="hidden">
    <div class="card">
      <h3 data-i18n="menu_reportes">Reporte mensual</h3>
      <div class="reporte-controles">
        <div>
          <label for="reporte-mes" data-i18n="lbl_fecha">Seleccionar mes</label>
          <select id="reporte-mes"></select>
        </div>
        <div>
          <button type="button" class="primary" id="reporte-mes-actual" data-i18n="btn_add">
            Ir al mes actual
          </button>
        </div>
      </div>

      <div class="grid" style="margin-top:1.5rem;">
        <div class="stat">
          <div class="stat-label" data-i18n="stat_entradas">Entradas del mes</div>
          <div class="stat-value" id="rep-entradas" style="color: #4ade80;">$ 0,00</div>
        </div>
        <div class="stat">
          <div class="stat-label" data-i18n="stat_salidas">Salidas del mes</div>
          <div class="stat-value" id="rep-salidas" style="color: #f87171;">$ 0,00</div>
        </div>
        <div class="stat">
          <div class="stat-label" data-i18n="stat_saldo">Saldo del mes</div>
          <div class="stat-value" id="rep-saldo">$ 0,00</div>
          <div class="stat-small" id="rep-saldo-texto"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 data-i18n="dash_dist_title">Gastos por categor√≠a</h3>
      <div class="tabla-wrapper">
        <table id="reporte-tabla-categorias">
          <thead>
            <tr>
              <th data-i18n="lbl_cat">Categor√≠a</th>
              <th data-i18n="lbl_tipo">Tipo</th>
              <th data-i18n="lbl_valor">Total</th>
              <th>%</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="section-categorias" class="hidden">
    <div class="card">
      <h3 data-i18n="menu_categorias">Categor√≠as</h3>
      <form id="form-categoria">
        <div>
          <label for="cat-nome" data-i18n="lbl_desc">Nombre</label>
          <input type="text" id="cat-nome" required placeholder="Ej: Mercado, Salud..." />
        </div>
        <div>
          <label for="cat-grupo" data-i18n="lbl_tipo">Tipo</label>
          <select id="cat-grupo" required>
            <option value="entrada" data-i18n="opt_entrada">Entrada</option>
            <option value="salida" data-i18n="opt_salida">Salida</option>
          </select>
        </div>
        <div>
          <button type="submit" class="primary" data-i18n="btn_add">A√±adir</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3 data-i18n="menu_categorias">Categor√≠as registradas</h3>
      <div class="tabla-wrapper">
        <table id="tabla-categorias">
          <thead>
            <tr>
              <th data-i18n="lbl_desc">Nombre</th>
              <th data-i18n="lbl_tipo">Tipo</th>
              <th>#</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="section-perfil" class="hidden">
    <div class="card">
      <h3 data-i18n="perf_title">Perfil financiero</h3>
      <form id="form-perfil">
        <div>
          <label for="perfil-edad" data-i18n="lbl_edad">Edad</label>
          <input type="number" id="perfil-edad" min="10" max="120" />
        </div>
        <div>
          <label for="perfil-sexo" data-i18n="lbl_sexo">Sexo</label>
          <select id="perfil-sexo">
            <option value="">-</option>
            <option value="m">M</option>
            <option value="f">F</option>
          </select>
        </div>
        <div>
          <label for="perfil-pais" data-i18n="lbl_pais">Pa√≠s</label>
          <select id="perfil-pais">
            <option value="">-</option>
            <option value="bo">Bolivia</option>
            <option value="br">Brasil</option>
            <option value="ar">Argentina</option>
            <option value="cl">Chile</option>
            <option value="mx">M√©xico</option>
            <option value="otro">Otro / Other</option>
          </select>
        </div>
        <div>
          <label for="perfil-meta" data-i18n="lbl_meta">Meta mensual</label>
          <input type="text" id="perfil-meta" />
        </div>
        <div>
          <label for="perfil-ingreso" data-i18n="lbl_ingreso">Ingreso mensual</label>
          <input type="text" id="perfil-ingreso" />
        </div>
        <div>
          <label for="perfil-moneda" data-i18n="lbl_moneda">Moneda</label>
          <select id="perfil-moneda">
            <option value="">Auto</option>
            <option value="BOB">BOB</option>
            <option value="BRL">BRL</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <div>
          <label for="perfil-objetivo-nombre" data-i18n="lbl_obj_nome">Nombre Objetivo</label>
          <input type="text" id="perfil-objetivo-nombre" />
        </div>
        <div>
          <label for="perfil-objetivo-valor" data-i18n="lbl_obj_val">Valor Objetivo</label>
          <input type="text" id="perfil-objetivo-valor" />
        </div>
        <div>
          <button type="submit" class="primary" data-i18n="btn_save_perf">Guardar perfil</button>
        </div>
        <div>
          <button type="button" class="danger-action" id="perfil-objetivo-reset" data-i18n="btn_reset_obj">
            Reiniciar progreso
          </button>
        </div>
      </form>
      <div id="perfil-mensaje" class="stat-small" style="margin-top:0.8rem; text-align:center;"></div>
      <div id="perfil-analisis" class="stat-small" style="margin-top:0.5rem; text-align:center;"></div>
    </div>

    <div class="card">
      <h3 data-i18n="dash_obj_title">Historial</h3>
      <div class="tabla-wrapper">
        <table id="tabla-historial-objetivos">
          <thead>
            <tr>
              <th data-i18n="lbl_obj_nome">Objetivo</th>
              <th data-i18n="lbl_obj_val">Valor</th>
              <th data-i18n="lbl_ahorro_acumulado">Final</th>
              <th data-i18n="lbl_fecha">Inicio</th>
              <th data-i18n="lbl_fecha">Fin</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

</div>
</main>
</div>
</div>

<div id="modal-categorias" class="modal hidden">
<div class="card" style="max-width:450px; width:90%; text-align:left; border: 1px solid var(--primary-glow);">
<h3 data-i18n="alert_bienvenida_title">üëã ¬°Bienvenido/a!</h3>
<p class="card-subtitle" style="margin-bottom:1rem;" data-i18n="alert_bienvenida_text">
Para comenzar, elige por d√≥nde quieres empezar a configurar tu cuenta:
</p>

<div style="display:flex; flex-direction:column; gap:1rem;">
  <div style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:16px; display:flex; justify-content:space-between; align-items:center;">
    <div style="margin-right:1rem;">
      <strong style="color:var(--accent-cyan);" data-i18n="btn_ir_perfil">1. Configurar Perfil</strong>
    </div>
    <button type="button" class="secondary" id="btn-ir-perfil">Go</button>
  </div>
  <div style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:16px; display:flex; justify-content:space-between; align-items:center;">
    <div style="margin-right:1rem;">
      <strong style="color:var(--secondary-glow);" data-i18n="btn_ir_cat">2. Crear Categor√≠as</strong>
    </div>
    <button type="button" class="secondary" id="btn-ir-categorias">Go</button>
  </div>
</div>
<button type="button" class="primary" id="modal-categorias-ok" style="margin-top:1.5rem; width:100%;">Ok</button>
</div>
</div>

<div id="modal-simulador" class="modal hidden">
<div class="card" style="max-width:420px; width:90%;">
  <h3 data-i18n="sim_title">üîÆ Simulador</h3>
  
  <div style="margin-top:1rem;">
     <label style="margin-bottom:0.5rem;" data-i18n="sim_lbl_monto">Monto mensual extra:</label>
     <input type="number" id="simulador-monto" style="margin-bottom:1rem;" placeholder="100" />
     
     <div id="simulador-resultado" data-i18n="sim_msg_initial" style="padding:1rem; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:1rem; font-size:0.9rem; color:#94a3b8; min-height: 3.5em; display:flex; align-items:center;">
       ...
     </div>

     <div style="display:flex; gap:0.5rem; justify-content:flex-end;">
       <button type="button" class="secondary" id="btn-cerrar-simulador" data-i18n="sim_btn_close">Cerrar</button>
       <button type="button" class="primary" id="btn-calcular-simulacion" data-i18n="sim_btn_calc">Calcular</button>
     </div>
  </div>
</div>
</div>

<script type="module">
// ===============================================================
// INTEGRACI√ìN FIREBASE
// ===============================================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
getAuth,
createUserWithEmailAndPassword,
signInWithEmailAndPassword,
signOut,
onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
getFirestore,
collection,
addDoc,
getDocs,
getDoc,
setDoc,
deleteDoc,
doc,
query,
where,
onSnapshot,
orderBy,
serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyC2SYOIRUVXWxRZjZXJaFX2hFID1izQks4",
authDomain: "controlefinanceiro-7f8f1.firebaseapp.com",
projectId: "controlefinanceiro-7f8f1",
storageBucket: "controlefinanceiro-7f8f1.firebasestorage.app",
messagingSenderId: "438314445354",
appId: "1:438314445354:web:e4551a6f467b20e9cfb153"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ===============================================================
// SISTEMA DE IDIOMAS (i18n) - DICION√ÅRIO COMPLETO
// ===============================================================
let savedLang = localStorage.getItem('app_lang');
let currentLang = (savedLang === 'es' || savedLang === 'pt') ? savedLang : 'es';

const translations = {
    es: {
        // Login
        login_title: "Control Financiero",
        login_subtitle: "Inicia sesi√≥n (Prism Edition)",
        lbl_email: "Correo electr√≥nico",
        lbl_pass: "Contrase√±a",
        login_extra_info: "Datos adicionales se configuran en Perfil.",
        btn_enter: "Entrar",
        btn_create: "Crear cuenta",
        msg_no_account: "¬øNo tienes cuenta?",
        msg_has_account: "¬øYa tienes cuenta?",
        
        // Menu
        menu_title: "MEN√ö",
        menu_dashboard: "Inicio",
        menu_transacciones: "Transacciones",
        menu_fijos: "Gastos fijos",
        menu_tarjetas: "Tarjetas",
        menu_reportes: "Reporte mensual",
        menu_categorias: "Categor√≠as",
        menu_perfil: "Perfil",
        btn_logout: "Salir",

        // Dashboard
        dash_resumen_title: "Resumen del mes actual",
        stat_entradas: "Entradas",
        stat_salidas: "Salidas",
        stat_saldo: "Saldo",
        dash_obj_title: "Objetivo de ahorro",
        btn_simular: "üîÆ Simular",
        dash_obj_subtitle: "Define un objetivo en la secci√≥n Perfil.",
        lbl_obj_activo: "Objetivo Activo",
        lbl_ahorro_acumulado: "Ahorro acumulado",
        lbl_falta: "Falta para el objetivo",
        lbl_detalle: "Detalle y Proyecci√≥n",
        dash_travel_title: "Proyecci√≥n Financiera (Viajero en el Tiempo)",
        dash_dist_title: "Distribuci√≥n de salidas del mes",
        
        // Transacciones
        trans_new_title: "Nueva transacci√≥n",
        lbl_tipo: "Tipo",
        lbl_cat: "Categor√≠a",
        lbl_origen: "Origen (solo salidas)",
        lbl_valor: "Valor",
        lbl_fecha: "Fecha",
        lbl_desc: "Descripci√≥n",
        btn_add: "A√±adir",
        trans_list_title: "Transacciones del mes",
        placeholder_search: "Ej: mercado, cine...",
        btn_clean_filter: "Limpiar filtros",
        
        // Cards & Labels Gerais
        opt_entrada: "Entrada",
        opt_salida: "Salida",
        opt_efectivo: "Efectivo",
        opt_tarjeta: "Tarjeta",

        // Alertas
        alert_restric: "üö´ ACCESO RESTRINGIDO\n\nEste correo no tiene permisos activos.\nTu cuenta ha sido creada, pero necesitas que el administrador habilite tu acceso.",
        alert_permiso: "üö´ ERROR DE PERMISOS\n\nNo tienes autorizaci√≥n para verificar la licencia.",
        alert_bienvenida_title: "üëã ¬°Bienvenido/a!",
        alert_bienvenida_text: "Para comenzar, elige por d√≥nde quieres empezar a configurar tu cuenta:",
        btn_ir_perfil: "1. Configurar Perfil ‚öôÔ∏è",
        btn_ir_cat: "2. Crear Categor√≠as üìÇ",
        msg_guardado: "Guardado.",
        
        // Perfil
        perf_title: "Perfil financiero",
        lbl_edad: "Edad",
        lbl_sexo: "Sexo",
        lbl_pais: "Pa√≠s",
        lbl_meta: "Meta mensual de gasto",
        lbl_ingreso: "Ingreso mensual",
        lbl_moneda: "Moneda",
        lbl_obj_nome: "Nombre del Objetivo",
        lbl_obj_val: "Valor objetivo",
        btn_save_perf: "Guardar perfil",
        btn_reset_obj: "Reiniciar progreso",
        
                // Simulador
        sim_title: "üîÆ Simulador",
        sim_lbl_monto: "Monto mensual extra:",
        sim_btn_calc: "Calcular",
        sim_btn_close: "Cerrar",
        sim_result_fail: "Actualmente no ahorras.",
        sim_result_success: "¬°Terminar√≠as antes!",
        sim_msg_initial: "Ingresa un valor arriba para ver el impacto.", // <--- NOVA LINHA

        
        // Gr√°ficos
        chart_restante: "Restante",
        chart_falta: "Falta",
        loading_check: "Validando acceso...",
        loading_data: "Cargando datos..."
    },
    pt: {
        // Login
        login_title: "Controle Financeiro",
        login_subtitle: "Fa√ßa login (Prism Edition)",
        lbl_email: "E-mail",
        lbl_pass: "Senha",
        login_extra_info: "Dados adicionais s√£o configurados no Perfil.",
        btn_enter: "Entrar",
        btn_create: "Criar conta",
        msg_no_account: "N√£o tem conta?",
        msg_has_account: "J√° tem conta?",
        
        // Menu
        menu_title: "MENU",
        menu_dashboard: "In√≠cio",
        menu_transacciones: "Transa√ß√µes",
        menu_fijos: "Gastos Fixos",
        menu_tarjetas: "Cart√µes",
        menu_reportes: "Relat√≥rio Mensal",
        menu_categorias: "Categorias",
        menu_perfil: "Perfil",
        btn_logout: "Sair",

        // Dashboard
        dash_resumen_title: "Resumo do m√™s atual",
        stat_entradas: "Entradas",
        stat_salidas: "Sa√≠das",
        stat_saldo: "Saldo",
        dash_obj_title: "Objetivo de Economia",
        btn_simular: "üîÆ Simular",
        dash_obj_subtitle: "Defina um objetivo na se√ß√£o Perfil.",
        lbl_obj_activo: "Objetivo Ativo",
        lbl_ahorro_acumulado: "Economia acumulada",
        lbl_falta: "Falta para o objetivo",
        lbl_detalle: "Detalhe e Proje√ß√£o",
        dash_travel_title: "Proje√ß√£o Financeira (Viajante do Tempo)",
        dash_dist_title: "Distribui√ß√£o de sa√≠das do m√™s",

        // Transacciones
        trans_new_title: "Nova transa√ß√£o",
        lbl_tipo: "Tipo",
        lbl_cat: "Categoria",
        lbl_origen: "Origem (s√≥ sa√≠das)",
        lbl_valor: "Valor",
        lbl_fecha: "Data",
        lbl_desc: "Descri√ß√£o",
        btn_add: "Adicionar",
        trans_list_title: "Transa√ß√µes do m√™s",
        placeholder_search: "Ex: mercado, cinema...",
        btn_clean_filter: "Limpar filtros",

        // Cards & Labels Gerais
        opt_entrada: "Entrada",
        opt_salida: "Sa√≠da",
        opt_efectivo: "Dinheiro",
        opt_tarjeta: "Cart√£o",

        // Alertas
        alert_restric: "üö´ ACESSO RESTRITO\n\nEste e-mail n√£o tem permiss√µes ativas.\nSua conta foi criada, mas voc√™ precisa que o administrador habilite seu acesso.",
        alert_permiso: "üö´ ERRO DE PERMISS√ÉO\n\nVoc√™ n√£o tem autoriza√ß√£o para verificar a licen√ßa.",
        alert_bienvenida_title: "üëã Bem-vindo(a)!",
        alert_bienvenida_text: "Para come√ßar, escolha por onde quer iniciar a configura√ß√£o:",
        btn_ir_perfil: "1. Configurar Perfil ‚öôÔ∏è",
        btn_ir_cat: "2. Criar Categorias üìÇ",
        msg_guardado: "Salvo.",
        
        // Perfil
        perf_title: "Perfil Financeiro",
        lbl_edad: "Idade",
        lbl_sexo: "Sexo",
        lbl_pais: "Pa√≠s",
        lbl_meta: "Meta mensal",
        lbl_ingreso: "Renda mensal",
        lbl_moneda: "Moeda",
        lbl_obj_nome: "Nome do Objetivo",
        lbl_obj_val: "Valor do objetivo",
        btn_save_perf: "Salvar perfil",
        btn_reset_obj: "Reiniciar progresso",
        
                // Simulador
        sim_title: "üîÆ Simulador",
        sim_lbl_monto: "Valor mensal extra:",
        sim_btn_calc: "Calcular",
        sim_btn_close: "Fechar",
        sim_result_fail: "Atualmente voc√™ n√£o economiza.",
        sim_result_success: "Terminaria antes!",
        sim_msg_initial: "Insira um valor acima para ver o impacto.", // <--- NOVA LINHA

        
        // Gr√°ficos
        chart_restante: "Restante",
        chart_falta: "Falta",
        loading_check: "Verificando acesso...",
        loading_data: "Carregando dados..."
    }
};

// Fun√ß√£o Principal de Troca de Idioma (VERS√ÉO COMPLETA COM FAIXA VERMELHA)
function updateLanguage(lang) {
    // Seguran√ßa extra: se chegar algo inv√°lido, for√ßa espanhol
    if (lang !== 'es' && lang !== 'pt') lang = 'es';
    
    currentLang = lang;
    try {
        localStorage.setItem('app_lang', lang);
    } catch (e) { console.warn("Sem acesso ao localStorage"); }

    // Atualiza textos est√°ticos (HTML)
    const elements = document.querySelectorAll('[data-i18n]');
    if (elements) {
        elements.forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                if(el.tagName === "INPUT" && el.hasAttribute("placeholder")) {
                    el.placeholder = translations[lang][key];
                } else {
                    el.textContent = translations[lang][key];
                }
            }
        });
    }

    // Sincroniza os seletores
    const selLogin = document.getElementById("lang-select-login");
    const selApp = document.getElementById("lang-select-app");
    if(selLogin) selLogin.value = lang;
    if(selApp) selApp.value = lang;
    
    // --- NOVO: TRADU√á√ÉO DA FAIXA VERMELHA (AQUI EST√Å A CORRE√á√ÉO) ---
    const avisoBar = document.getElementById("barra-aviso-vencimento");
    if (avisoBar) {
        // L√™ quantos dias faltam (salvo no dataset)
        const dias = parseInt(avisoBar.dataset.dias);
        const spanTexto = avisoBar.querySelector(".msg-texto");
        
        if (spanTexto) {
            const esPt = lang === 'pt';
            if (dias === 0) {
                spanTexto.textContent = esPt 
                    ? "‚ö†Ô∏è ATEN√á√ÉO: Sua assinatura vence HOJE!" 
                    : "‚ö†Ô∏è ATENCI√ìN: ¬°Tu suscripci√≥n vence HOY!";
            } else {
                spanTexto.textContent = esPt 
                    ? `‚ö†Ô∏è ATEN√á√ÉO: Sua assinatura vence em ${dias} dias.` 
                    : `‚ö†Ô∏è ATENCI√ìN: Tu suscripci√≥n vence en ${dias} d√≠as.`;
            }
        }
    }
    // ----------------------------------------------------------------

    // ATUALIZA√á√ÉO DOS GR√ÅFICOS
    if (typeof actualizarResumen === "function") {
        try { actualizarResumen(); } catch(e) { console.error("Erro ao atualizar resumo", e); }
    }
    if (typeof actualizarObjetivo === "function") {
        try { actualizarObjetivo(); } catch(e) { console.error("Erro ao atualizar objetivo", e); }
    }
}

// --- UTILIT√ÅRIOS VISUAIS ---
function loading(show) {
    const el = document.getElementById('loading-overlay');
    if (el) {
        if (show) el.classList.remove('hidden');
        else el.classList.add('hidden');
    }
}

function monedaPorDefectoParaPais(pais) {
    switch (pais) {
        case "bo": return "BOB";
        case "br": return "BRL";
        case "ar": return "ARS";
        case "cl": return "CLP";
        case "mx": return "MXN";
        case "otro": return "USD";
        default: return "USD";
    }
}

function parseNumeroLocal(str) {
    if (str === null || str === undefined) return 0;
    if (typeof str !== "string") str = String(str);
    str = str.trim();
    if (!str) return 0;
    str = str.replace(/\./g, "");
    str = str.replace(",", ".");
    const n = parseFloat(str);
    return isNaN(n) ? 0 : n;
}

let monedaUsuario = "USD";

function formatearMoneda(valor) {
    const currency = monedaUsuario || "USD";
    let locale = "en-US";
    
    // Ajuste fino de locale baseado no idioma escolhido
    if (currentLang === "pt") locale = "pt-BR";
    else locale = "es-ES";

    switch (currency) {
        case "BRL": locale = "pt-BR"; break;
        case "BOB": locale = "es-BO"; break;
        case "ARS": locale = "es-AR"; break;
        case "CLP": locale = "es-CL"; break;
        case "MXN": locale = "es-MX"; break;
        case "EUR": locale = "es-ES"; break;
        case "USD": locale = "en-US"; break;
    }
    try {
        return valor.toLocaleString(locale, { style: "currency", currency });
    } catch (e) {
        return valor.toFixed(2);
    }
}

function obtenerAnioMesActual() {
    return new Date().toISOString().slice(0, 7);
}

function filtrarMesActual(lista, campoFecha) {
    const anioMesActual = obtenerAnioMesActual();
    return lista.filter(item => item[campoFecha] && item[campoFecha].startsWith(anioMesActual));
}

function nombreMes(anioMes) {
    if (!anioMes) return "";
    const [anio, mes] = anioMes.split("-");
    const fecha = new Date(parseInt(anio), parseInt(mes) - 1, 1);
    // Usa o idioma selecionado para a data
    const langLocale = currentLang === "pt" ? "pt-BR" : "es-ES";
    return fecha.toLocaleDateString(langLocale, { month: "long", year: "numeric" });
}

function siguienteAnioMes(anioMes) {
    if (!anioMes) return anioMes;
    const [anioStr, mesStr] = anioMes.split("-");
    let anio = parseInt(anioStr, 10);
    let mes = parseInt(mesStr, 10);
    mes += 1;
    if (mes === 13) { mes = 1; anio += 1; }
    return anio.toString().padStart(4, "0") + "-" + mes.toString().padStart(2, "0");
}

// --- ESTADO GLOBAL ---
let usuarioActual = null;
let categoriasLocal = [];
let transaccionesLocal = [];
let fijosLocal = [];
let tarjetasLocal = [];

let metaMensualUsuario = 0;
let ingresoMensualUsuario = 0;
let edadUsuario = null;
let sexoUsuario = "";
let paisUsuario = "";
let yaMostroModalCategorias = false;
let objetivoNombre = "";
let objetivoValor = 0;
let objetivoAhorroBase = 0;
let objetivoFechaInicio = null;
let objetivoCompletado = false;
let objetivosHistorial = [];

let unsubs = [];

function limparMemoriaGlobal() {
    usuarioActual = null;
    categoriasLocal = []; transaccionesLocal = []; fijosLocal = []; tarjetasLocal = [];
    metaMensualUsuario = 0; ingresoMensualUsuario = 0; edadUsuario = null;
    sexoUsuario = ""; paisUsuario = ""; monedaUsuario = "USD"; 
    objetivoNombre = ""; objetivoValor = 0; objetivoAhorroBase = 0;
    objetivoFechaInicio = null; objetivoCompletado = false; objetivosHistorial = [];
    yaMostroModalCategorias = false;
}

// ----------------------------------------------------------------------
// üëáüëáüëá SUBSTITUA SEU BLOCO ATUAL POR ESTE AQUI üëáüëáüëá
onAuthStateChanged(auth, async (user) => {
   // 1. Garante o idioma atual
  updateLanguage(currentLang);

  // üëáüëáüëá COLE ESTAS 4 LINHAS AQUI (ELAS ESTAVAM FALTANDO) üëáüëáüëá
  const selLogin = document.getElementById("lang-select-login");
  const selApp = document.getElementById("lang-select-app");
  if(selLogin) selLogin.onchange = (e) => updateLanguage(e.target.value);
  if(selApp) selApp.onchange = (e) => updateLanguage(e.target.value);
  // üëÜüëÜüëÜ FIM DO TRECHO QUE FALTAVA üëÜüëÜüëÜ

  if (user) {
     loading(true);
     const loadingText = document.getElementById('loading-overlay');
     if(loadingText && translations[currentLang]) loadingText.textContent = translations[currentLang].loading_check;
     
     try {
         const docRef = doc(db, "clientes_permitidos", user.email); 
         const docSnap = await getDoc(docRef);

         if (docSnap.exists()) {
             const dadosUser = docSnap.data();

             // 1. BLOQUEIO MANUAL
             if (dadosUser.ativo !== true) {
                 alert(translations[currentLang].alert_restric);
                 await signOut(auth);
                 window.location.reload();
                 return;
             }

             // 2. BLOQUEIO POR DATA
             if (dadosUser.data_vencimento) {
                 const hoy = new Date();
                 hoy.setHours(0, 0, 0, 0);

                 // Limpeza da data
                 let dataLimpa = dadosUser.data_vencimento.toString().trim().replace(/\//g, "-");
                 const partes = dataLimpa.split('-');
                 
                 if (partes.length === 3) {
                     const dataVenc = new Date(partes[0], partes[1] - 1, partes[2]);

                     // A) BLOQUEIO üö´
                     if (hoy > dataVenc) {
                         // Define mensagem no idioma correto
                         const esPt = currentLang === 'pt';
                         const msgBloqueio = esPt
                            ? `üö´ ACESSO SUSPENSO\n\nSua assinatura venceu dia: ${dataLimpa}.\nRegularize para acessar.`
                            : `üö´ ACCESO SUSPENDIDO\n\nTu suscripci√≥n venci√≥ el d√≠a: ${dataLimpa}.\nRegulariza para acceder.`;

                         alert(msgBloqueio);
                         await signOut(auth);
                         window.location.reload();
                         return;
                     }

                     // B) AVISO ‚ö†Ô∏è
                     const diffTempo = dataVenc - hoy;
                     const diffDias = Math.ceil(diffTempo / (1000 * 60 * 60 * 24));

                     if (diffDias <= 5 && diffDias >= 0) {
                         // Chama a barra visual
                         setTimeout(() => mostrarAvisoVencimento(diffDias), 1500);
                     }
                 }
             }

             // LIBERA ACESSO ‚úÖ
             if(loadingText && translations[currentLang]) loadingText.textContent = translations[currentLang].loading_data;
             usuarioActual = user;
             document.getElementById("user-email").textContent = user.email;
             document.getElementById("login-screen").classList.add("hidden");
             document.getElementById("app").classList.remove("hidden");
             
             // Atualiza o seletor visual do app
             const selApp = document.getElementById("lang-select-app");
             if(selApp) selApp.value = currentLang;
             
             iniciarListeners(user.uid);

         } else {
             alert(translations[currentLang].alert_restric);
             await signOut(auth);
             window.location.reload();
         }
     } catch (error) {
         console.error("Erro whitelist:", error);
         alert("Error: " + error.message);
         await signOut(auth);
         window.location.reload();
     }

  } else {
     if (usuarioActual) {
         window.location.reload();
         return;
     }
     limparMemoriaGlobal();
     unsubs.forEach(u => u());
     unsubs = [];

     document.getElementById("app").classList.add("hidden");
     document.getElementById("login-screen").classList.remove("hidden");
     
     const selLogin = document.getElementById("lang-select-login");
     if(selLogin) selLogin.value = currentLang;
     loading(false);
  }
});


// ----------------------------------------------------------------------
// CARGA DE DATOS

// ----------------------------------------------------------------------
function iniciarListeners(uid) {
loading(true);

const unsubCat = onSnapshot(query(collection(db, "categorias"), where("uid", "==", uid)), (snapshot) => {
   categoriasLocal = [];
   snapshot.forEach(doc => { categoriasLocal.push({ id: doc.id, ...doc.data() }); });
   inicializarInterfaz();
   mostrarModalCategoriasSiCorresponde();
});
unsubs.push(unsubCat);

const unsubTrans = onSnapshot(query(collection(db, "transacciones"), where("uid", "==", uid)), (snapshot) => {
   transaccionesLocal = [];
   snapshot.forEach(doc => { transaccionesLocal.push({ id: doc.id, ...doc.data() }); });
   inicializarInterfaz();
});
unsubs.push(unsubTrans);

const unsubFijos = onSnapshot(query(collection(db, "gastos_fijos"), where("uid", "==", uid)), (snapshot) => {
   fijosLocal = [];
   snapshot.forEach(doc => { fijosLocal.push({ id: doc.id, ...doc.data() }); });
   inicializarInterfaz();
});
unsubs.push(unsubFijos);

const unsubTarj = onSnapshot(query(collection(db, "tarjetas"), where("uid", "==", uid)), (snapshot) => {
   tarjetasLocal = [];
   snapshot.forEach(doc => { tarjetasLocal.push({ id: doc.id, ...doc.data() }); });
   inicializarInterfaz();
});
unsubs.push(unsubTarj);

const docRef = doc(db, "perfil", uid);
const unsubPerfil = onSnapshot(docRef, (docSnap) => {
   if (docSnap.exists()) {
       const p = docSnap.data();
       edadUsuario = p.edad;
       sexoUsuario = p.sexo;
       paisUsuario = p.pais;
       monedaUsuario = p.moneda || "USD";
       metaMensualUsuario = Number(p.meta_mensual) || 0;
       ingresoMensualUsuario = Number(p.ingreso_mensual) || 0;
       objetivoNombre = p.objetivo_nombre || "";
       objetivoValor = Number(p.objetivo_valor) || 0;
       objetivoAhorroBase = Number(p.objetivo_ahorro_base) || 0;
       objetivoFechaInicio = p.objetivo_fecha_inicio;
       objetivoCompletado = p.objetivo_completado;
       yaMostroModalCategorias = p.mostro_modal_categorias;
       objetivosHistorial = p.objetivos_historial || [];
 
       if(!monedaUsuario && paisUsuario) monedaUsuario = monedaPorDefectoParaPais(paisUsuario);
   } else {
       metaMensualUsuario = 0; ingresoMensualUsuario = 0;
       objetivoNombre = ""; objetivoValor = 0; objetivoAhorroBase = 0;
       yaMostroModalCategorias = false;
   }
   inicializarInterfaz();
   loading(false);
});
unsubs.push(unsubPerfil);
}
// ----------------------------------------------------------------------
// L√ìGICA DE LOGIN E REGISTRO UI
// ----------------------------------------------------------------------
const loginForm = document.getElementById("login-form");
const loginEmail = document.getElementById("login-email");
const loginPassword = document.getElementById("login-password");
const loginSubmit = document.getElementById("login-submit");
const toggleModeBtn = document.getElementById("toggle-mode");
const toggleText = document.getElementById("toggle-text");
const loginMessage = document.getElementById("login-message");
const registerExtra = document.getElementById("register-extra");

let modoRegistro = false;

toggleModeBtn.addEventListener("click", () => {
    modoRegistro = !modoRegistro;
    // Atualiza textos baseado no idioma atual
    if (modoRegistro) {
        loginSubmit.textContent = translations[currentLang].btn_create;
        toggleText.textContent = translations[currentLang].msg_has_account;
        toggleModeBtn.textContent = translations[currentLang].btn_enter;
        registerExtra.classList.remove("hidden");
    } else {
        loginSubmit.textContent = translations[currentLang].btn_enter;
        toggleText.textContent = translations[currentLang].msg_no_account;
        toggleModeBtn.textContent = translations[currentLang].btn_create;
        registerExtra.classList.add("hidden");
    }
    loginMessage.textContent = "";
});

loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = loginEmail.value;
    const pass = loginPassword.value;

    loginMessage.style.color = "#f97316";
    loginMessage.textContent = "Procesando...";

    try {
        if (modoRegistro) {
            await createUserWithEmailAndPassword(auth, email, pass);
        } else {
            await signInWithEmailAndPassword(auth, email, pass);
        }
    } catch (error) {
        console.error(error);
        loginMessage.textContent = "Error: " + error.message;
    }
});

document.getElementById("logout-btn").addEventListener("click", () => {
    signOut(auth);
});

// ----------------------------------------------------------------------
// SALVAR DADOS (ESCRITA FIRESTORE)
// ----------------------------------------------------------------------

// Salvar Perfil
async function guardarPerfilEnServidor() {
    if (!usuarioActual) return;
    try {
        const dados = {
            uid: usuarioActual.uid,
            edad: edadUsuario,
            sexo: sexoUsuario,
            pais: paisUsuario,
            moneda: monedaUsuario,
            meta_mensual: metaMensualUsuario,
            ingreso_mensual: ingresoMensualUsuario,
            objetivo_nombre: objetivoNombre,
            objetivo_valor: objetivoValor,
            objetivo_ahorro_base: Number(objetivoAhorroBase),
            objetivo_fecha_inicio: objetivoFechaInicio,
            objetivo_completado: objetivoCompletado,
            mostro_modal_categorias: yaMostroModalCategorias,
            objetivos_historial: objetivosHistorial
        };
        await setDoc(doc(db, "perfil", usuarioActual.uid), dados, { merge: true });

        const pm = document.getElementById("perfil-mensaje");
        if (pm) {
            pm.textContent = translations[currentLang].msg_guardado;
            setTimeout(() => pm.textContent = "", 1500);
        }
    } catch (e) { console.error("Error al guardar perfil", e); }
}

// Categorias
const formCategoria = document.getElementById("form-categoria");
formCategoria.addEventListener("submit", async (e) => {
    e.preventDefault();
    const nome = document.getElementById("cat-nome").value.trim();
    const grupo = document.getElementById("cat-grupo").value;
    if (!nome) return;

    loading(true);
    try {
        await addDoc(collection(db, "categorias"), {
            uid: usuarioActual.uid,
            nome,
            grupo,
            createdAt: serverTimestamp()
        });
        document.getElementById("cat-nome").value = "";
    } catch (e) { console.error(e); alert("Error"); }
    loading(false);
});
window.eliminarCategoria = async (id) => {
    if (!confirm("Confirm?")) return;
    await deleteDoc(doc(db, "categorias", id));
};

// Gastos Fijos
// Procure esta parte no seu c√≥digo e SUBSTITUA por isso:
const formFijo = document.getElementById("form-fijo");
formFijo.addEventListener("submit", async (e) => {
    e.preventDefault();
    const d = document.getElementById("fijo-descripcion").value.trim();
    const v = parseNumeroLocal(document.getElementById("fijo-valor").value);
    const ven = parseInt(document.getElementById("fijo-vencimiento").value);

    // --- L√ìGICA NOVA: CALCULA O M√äS DE IN√çCIO ---
    const hoje = new Date();
    const diaAtual = hoje.getDate();
    let mesInicio = obtenerAnioMesActual(); // Tenta come√ßar este m√™s

    // Se o dia de vencimento (ex: 19) for menor que hoje (ex: 21), 
    // ent√£o j√° venceu este m√™s, jogamos para o pr√≥ximo.
    if (ven < diaAtual) {
        mesInicio = siguienteAnioMes(mesInicio);
    }
    // ---------------------------------------------

    loading(true);
    try {
        await addDoc(collection(db, "gastos_fijos"), {
            uid: usuarioActual.uid,
            descripcion: d,
            valor: v,
            vencimiento: ven,
            mes_inicio: mesInicio // Usa o m√™s calculado acima
        });
        formFijo.reset();
    } catch (e) { console.error(e); }
    loading(false);
});
// üëáüëáüëá COLE ESTA LINHA QUE ESTAVA FALTANDO üëáüëáüëá
window.eliminarFijo = async (id) => await deleteDoc(doc(db, "gastos_fijos", id));

// Tarjetas
const formTarjeta = document.getElementById("form-tarjeta");
formTarjeta.addEventListener("submit", async (e) => {
    e.preventDefault();
    const a = document.getElementById("tarjeta-alias").value;
    const d = document.getElementById("tarjeta-digitos").value;
    const b = document.getElementById("tarjeta-banco").value;

    loading(true);
    try {
        await addDoc(collection(db, "tarjetas"), {
            uid: usuarioActual.uid,
            alias: a,
            digitos: d,
            banco: b
        });
        formTarjeta.reset();
    } catch (e) { console.error(e); }
    loading(false);
});
window.eliminarTarjeta = async (id) => await deleteDoc(doc(db, "tarjetas", id));

// Transa√ß√µes
const formTransaccion = document.getElementById("form-transaccion");
formTransaccion.addEventListener("submit", async (e) => {
    e.preventDefault();
    const tipo = document.getElementById("tipo").value;
    const catVal = document.getElementById("categoria").value;
    const orig = document.getElementById("origen").value;
    const val = parseNumeroLocal(document.getElementById("valor").value);
    const fecha = document.getElementById("data").value;
    const desc = document.getElementById("descripcion").value.trim();

    let gfId = null;
    if (tipo === "salida" && catVal === "__gasto_fijo__") {
        gfId = document.getElementById("gasto-fijo-select").value;
        if (!gfId) { alert("Seleccione gasto fijo"); return; }
    }
    let tId = null, origFinal = null;
    if (tipo === "salida") {
        if (orig === "tarjeta") {
            tId = document.getElementById("tarjeta-select").value;
            if (!tId) { alert("Seleccione tarjeta"); return; }
            origFinal = "tarjeta";
        } else origFinal = "efectivo";
    }

    const catIdDB = (catVal === "__gasto_fijo__") ? null : catVal;

    loading(true);
    try {
        await addDoc(collection(db, "transacciones"), {
            uid: usuarioActual.uid,
            tipo: tipo,
            categoriaId: catIdDB,
            gastoFijoId: gfId,
            tarjetaId: tId,
            origen: origFinal,
            valor: val,
            fecha: fecha,
            descripcion: desc,
            createdAt: serverTimestamp()
        });
        document.getElementById("valor").value = "";
        document.getElementById("descripcion").value = "";
        actualizarObjetivo();
    } catch (e) { console.error(e); alert("Error"); }
    loading(false);
});
window.eliminarTransaccion = async (id) => {
    await deleteDoc(doc(db, "transacciones", id));
    actualizarObjetivo();
};

// ----------------------------------------------------------------------
// L√ìGICA DE INTERFACE
// ----------------------------------------------------------------------

// Bot√µes e Modais
const modalCategorias = document.getElementById("modal-categorias");
const modalCategoriasOk = document.getElementById("modal-categorias-ok");
modalCategoriasOk.addEventListener("click", async () => {
    modalCategorias.classList.add("hidden");
    yaMostroModalCategorias = true;
    await guardarPerfilEnServidor();
});

// L√≥gica dos bot√µes de boas-vindas
const btnPerfil = document.getElementById("btn-ir-perfil");
if (btnPerfil) {
    btnPerfil.addEventListener("click", async () => {
        document.getElementById("modal-categorias").classList.add("hidden");
        const menuPerfil = document.querySelector('button[data-section="perfil"]');
        if (menuPerfil) menuPerfil.click();
        yaMostroModalCategorias = true;
        await guardarPerfilEnServidor();
    });
}

const btnCategorias = document.getElementById("btn-ir-categorias");
if (btnCategorias) {
    btnCategorias.addEventListener("click", async () => {
        document.getElementById("modal-categorias").classList.add("hidden");
        const menuCategorias = document.querySelector('button[data-section="categorias"]');
        if (menuCategorias) menuCategorias.click();
        yaMostroModalCategorias = true;
        await guardarPerfilEnServidor();
    });
}

function mostrarModalCategoriasSiCorresponde() {
    if (categoriasLocal.length === 0 && !yaMostroModalCategorias) {
        document.getElementById("modal-categorias").classList.remove("hidden");
    } else {
        document.getElementById("modal-categorias").classList.add("hidden");
    }
}

function inicializarInterfaz() {
    rellenarSelectCategorias();
    rellenarTablaCategorias();
    rellenarTablaFijos();
    rellenarTablaTarjetas();
    rellenarTablaTransacciones();
    rellenarPerfil();
    rellenarHistorialObjetivos();
    actualizarResumen();
    analisisLatam();
    actualizarObjetivo();
    dibujarGraficoViajeroTiempo();
    actualizarCampoGastoFijo();
    actualizarCampoOrigenYTarjeta();
    inicializarReporte();
    
    // For√ßa atualiza√ß√£o do modal
    mostrarModalCategoriasSiCorresponde();
    
    // Reaplica idioma para garantir textos din√¢micos (tabelas/gr√°ficos)
    updateLanguage(currentLang);
}

// Navega√ß√£o Lateral
const sidebar = document.getElementById("sidebar");
const menuToggle = document.getElementById("menu-toggle");
menuToggle.addEventListener("click", () => sidebar.classList.toggle("open"));
sidebar.addEventListener("click", (e) => {
    if (e.target.tagName !== "BUTTON") return;
    const seccion = e.target.getAttribute("data-section");
    if (!seccion) return;
    sidebar.querySelectorAll("button").forEach(btn => btn.classList.remove("active"));
    e.target.classList.add("active");
    document.querySelectorAll("main section").forEach(sec => sec.classList.add("hidden"));
    document.getElementById("section-" + seccion).classList.remove("hidden");
    sidebar.classList.remove("open");
});

// Listeners de campos din√¢micos
document.getElementById("tipo").addEventListener("change", () => {
    rellenarSelectCategorias();
    actualizarCampoGastoFijo();
    actualizarCampoOrigenYTarjeta();
});
document.getElementById("categoria").addEventListener("change", actualizarCampoGastoFijo);
document.getElementById("origen").addEventListener("change", actualizarCampoOrigenYTarjeta);
document.getElementById("filtro-texto").addEventListener("input", rellenarTablaTransacciones);
document.getElementById("filtro-fecha").addEventListener("change", rellenarTablaTransacciones);
document.getElementById("btn-limpiar-filtros").addEventListener("click", () => {
    document.getElementById("filtro-texto").value = "";
    document.getElementById("filtro-fecha").value = "";
    rellenarTablaTransacciones();
});

// Salvar perfil
document.getElementById("form-perfil").addEventListener("submit", async (e) => {
    e.preventDefault();
    edadUsuario = parseInt(document.getElementById("perfil-edad").value);
    sexoUsuario = document.getElementById("perfil-sexo").value;
    paisUsuario = document.getElementById("perfil-pais").value;
    metaMensualUsuario = parseNumeroLocal(document.getElementById("perfil-meta").value);
    ingresoMensualUsuario = parseNumeroLocal(document.getElementById("perfil-ingreso").value);
    monedaUsuario = document.getElementById("perfil-moneda").value;
    objetivoNombre = document.getElementById("perfil-objetivo-nombre").value;

    const novoValor = parseNumeroLocal(document.getElementById("perfil-objetivo-valor").value);
    if (novoValor !== objetivoValor && novoValor > 0) {
        objetivoValor = novoValor;
    } else {
        objetivoValor = novoValor;
    }

    await guardarPerfilEnServidor();
    inicializarInterfaz();
});

// Resetar Objetivo
document.getElementById("perfil-objetivo-reset").addEventListener("click", async () => {
    if (!confirm("Confirm reset?")) return;

    objetivoAhorroBase = calcularAhorroTotal();
    objetivoFechaInicio = new Date().toISOString().slice(0, 10);
    objetivoCompletado = false;

    await guardarPerfilEnServidor();
    inicializarInterfaz();
});

// --- SIMULADOR ---
const modalSim = document.getElementById("modal-simulador");

// Bot√£o de Abrir (Com Reset de Texto)
document.getElementById("btn-abrir-simulador").addEventListener("click", () => {
    modalSim.classList.remove("hidden");
    // Reseta o texto para a instru√ß√£o inicial ao abrir
    const res = document.getElementById("simulador-resultado");
    const input = document.getElementById("simulador-monto");
    
    if(translations[currentLang] && translations[currentLang].sim_msg_initial) {
        res.textContent = translations[currentLang].sim_msg_initial;
    } else {
        res.textContent = "...";
    }
    input.value = ""; // Limpa o n√∫mero anterior
});

document.getElementById("btn-cerrar-simulador").addEventListener("click", () => modalSim.classList.add("hidden"));

document.getElementById("btn-calcular-simulacion").addEventListener("click", () => {
    const extra = parseNumeroLocal(document.getElementById("simulador-monto").value);
    const res = document.getElementById("simulador-resultado");

    if (extra <= 0) {
        res.textContent = "Ingresa un monto v√°lido.";
        return;
    }

    let totE = 0, totS = 0;
    transaccionesLocal.forEach(t => {
        const v = Number(t.valor) || 0;
        if (t.tipo === "entrada") totE += v; else totS += v;
    });
    const ahorroTotal = Math.max(0, totE - totS);
    let actual = ahorroTotal - objetivoAhorroBase;
    if (actual < 0) actual = 0;
    const restante = objetivoValor - actual;

    if (restante <= 0) {
        res.textContent = "Goal reached!";
        return;
    }

    const mes = obtenerAnioMesActual();
    const transMes = transaccionesLocal.filter(t => t.fecha && t.fecha.startsWith(mes));
    let eM = 0, sM = 0;
    transMes.forEach(t => {
        const v = Number(t.valor) || 0;
        if (t.tipo === "entrada") eM += v; else sM += v;
    });
    const flujoMes = Math.max(0, eM - sM);
    const dia = new Date().getDate();
    const ritmoBase = (flujoMes / dia) * 30;

    const tiempoActual = ritmoBase > 0 ? (restante / ritmoBase) : 9999;
    const nuevoRitmo = ritmoBase + extra;
    const tiempoNuevo = restante / nuevoRitmo;

    const diasAntes = Math.ceil((tiempoActual * 30) - (tiempoNuevo * 30));

    if (ritmoBase <= 0) {
        res.textContent = translations[currentLang].sim_result_fail;
    } else {
        res.innerHTML = `${translations[currentLang].sim_result_success} (${diasAntes} days)`;
    }
});


// --- GR√ÅFICOS (Completo e Expandido) ---

function dibujarGraficoViajeroTiempo() {
    const canvas = document.getElementById("chart-time-travel");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width;
    const h = canvas.height;

    ctx.clearRect(0, 0, w, h);

    const hoy = new Date();
    const meses = [];
    // Hist√≥rico de 3 meses atr√°s + 6 futuros
    for (let i = -2; i <= 6; i++) {
        const d = new Date(hoy.getFullYear(), hoy.getMonth() + i, 1);
        // TRADU√á√ÉO DA DATA NO EIXO X
        const localeData = currentLang === "pt" ? "pt-BR" : "es-ES";
        meses.push({
            label: d.toLocaleDateString(localeData, { month: 'short' }),
            dateStr: d.toISOString().slice(0, 7),
            isFuture: i > 0
        });
    }

    let saldoAcumulado = 0;
    const primerMesMostrado = meses[0].dateStr;
    transaccionesLocal.forEach(t => {
        if (t.fecha < primerMesMostrado + "-01") {
            const v = Number(t.valor) || 0;
            if (t.tipo === "entrada") saldoAcumulado += v; else saldoAcumulado -= v;
        }
    });

    const puntos = [];
    let tendenciaAhorro = 0;
    let mesesConDatos = 0;

    meses.forEach(m => {
        if (!m.isFuture) {
            const trans = transaccionesLocal.filter(t => t.fecha && t.fecha.startsWith(m.dateStr));

            if (trans.length === 0) {
                puntos.push({ val: null, future: false, label: m.label });
            } else {
                let e = 0, s = 0;
                trans.forEach(t => {
                    const v = Number(t.valor) || 0;
                    if (t.tipo === "entrada") e += v; else s += v;
                });
                saldoAcumulado += (e - s);
                puntos.push({ val: saldoAcumulado, future: false, label: m.label });
                tendenciaAhorro += (e - s);
                mesesConDatos++;
            }
        } else {
            const promedio = mesesConDatos > 0 ? (tendenciaAhorro / mesesConDatos) : 0;
            saldoAcumulado += promedio;
            puntos.push({ val: saldoAcumulado, future: true, label: m.label });
        }
    });

    const valoresValidos = puntos.map(p => p.val).filter(v => v !== null);
    if (valoresValidos.length === 0) return;

    const maxVal = Math.max(...valoresValidos) * 1.1;
    const minVal = Math.min(0, ...valoresValidos);
    const range = maxVal - minVal || 100;

    const getX = (i) => 40 + (i * ((w - 60) / (puntos.length - 1)));
    const getY = (v) => h - 30 - ((v - minVal) / range) * (h - 60);

    ctx.strokeStyle = "rgba(255,255,255,0.1)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(40, 20);
    ctx.lineTo(40, h - 30);
    ctx.lineTo(w - 20, h - 30);
    ctx.stroke();

    ctx.lineWidth = 3;
    for (let i = 0; i < puntos.length - 1; i++) {
        const p1 = puntos[i];
        const p2 = puntos[i + 1];

        if (p1.val === null || p2.val === null) continue;

        ctx.beginPath();
        ctx.moveTo(getX(i), getY(p1.val));
        ctx.lineTo(getX(i + 1), getY(p2.val));

        if (p2.future) {
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = "#06b6d4";
        } else {
            ctx.setLineDash([]);
            ctx.strokeStyle = "#8b5cf6";
        }
        ctx.stroke();
    }
    ctx.setLineDash([]);

    puntos.forEach((p, i) => {
        if (p.val === null) {
            const xLabel = getX(i);
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.font = "10px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText(p.label, xLabel, h - 10);
            return;
        }

        const x = getX(i);
        const y = getY(p.val);
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, Math.PI * 2);
        ctx.fillStyle = p.future ? "#06b6d4" : "#8b5cf6";
        ctx.fill();
        ctx.strokeStyle = "rgba(255,255,255,0.5)";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.fillStyle = "rgba(255,255,255,0.5)";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(p.label, x, h - 10);

        if (i === puntos.length - 1 || (i === 2 && !p.future)) {
            ctx.fillStyle = "#fff";
            ctx.fillText(formatearMoneda(p.val), x, y - 15);
        }
    });
}

// --- AUXILIARES DE UI ---

function rellenarSelectCategorias() {
    const sel = document.getElementById("categoria");
    sel.innerHTML = "";
    const tipo = document.getElementById("tipo").value;
    if (tipo === "salida" && fijosLocal.length > 0) {
        const opt = document.createElement("option");
        opt.value = "__gasto_fijo__";
        opt.textContent = "Gastos fijos";
        sel.appendChild(opt);
    }
    categoriasLocal.forEach(c => {
        if (c.grupo !== tipo) return;
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.nome;
        sel.appendChild(opt);
    });
}

function rellenarTablaCategorias() {
    const tb = document.querySelector("#tabla-categorias tbody");
    tb.innerHTML = "";
    categoriasLocal.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${c.nome}</td><td><span class="tag ${c.grupo}">${c.grupo}</span></td><td></td>`;
        const btn = document.createElement("button");
        btn.className = "btn-icon btn-icon-danger";
        btn.textContent = "X";
        btn.onclick = () => window.eliminarCategoria(c.id);
        tr.lastElementChild.appendChild(btn);
        tb.appendChild(tr);
    });
}

function rellenarSelectGastosFijos() {
    const s = document.getElementById("gasto-fijo-select");
    s.innerHTML = "";
    fijosLocal.forEach(f => {
        const o = document.createElement("option");
        o.value = f.id;
        o.textContent = `${f.descripcion} (${formatearMoneda(f.valor)})`;
        s.appendChild(o);
    });
}

function rellenarTablaFijos() {
    const tb = document.querySelector("#tabla-fijos tbody");
    tb.innerHTML = "";
    const mes = obtenerAnioMesActual();
    fijosLocal.forEach(f => {
        const estado = estadoFijoParaMes(f, mes);
        const tr = document.createElement("tr");
        if (estado.claseFila) tr.classList.add(estado.claseFila);
        tr.innerHTML = `<td>${f.descripcion}</td><td>${formatearMoneda(f.valor)}</td><td>D√≠a ${f.vencimiento}</td>
                   <td><span class="badge-estado ${estado.badgeClase}">${estado.texto}</span></td><td></td>`;
        const btn = document.createElement("button");
        btn.className = "btn-icon btn-icon-danger";
        btn.textContent = "X";
        btn.onclick = () => window.eliminarFijo(f.id);
        tr.lastElementChild.appendChild(btn);
        tb.appendChild(tr);
    });
    rellenarSelectGastosFijos();
}

function rellenarSelectTarjetas() {
    const s = document.getElementById("tarjeta-select");
    s.innerHTML = "";
    tarjetasLocal.forEach(t => {
        const o = document.createElement("option");
        o.value = t.id;
        o.textContent = `${t.alias || ""} ${t.digitos || ""}`;
        s.appendChild(o);
    });
}

function rellenarTablaTarjetas() {
    const tb = document.querySelector("#tabla-tarjetas tbody");
    tb.innerHTML = "";
    tarjetasLocal.forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${t.alias || ""}</td><td>${t.digitos || ""}</td><td>${t.banco || ""}</td><td></td>`;
        const btn = document.createElement("button");
        btn.className = "btn-icon btn-icon-danger";
        btn.textContent = "X";
        btn.onclick = () => window.eliminarTarjeta(t.id);
        tr.lastElementChild.appendChild(btn);
        tb.appendChild(tr);
    });
    rellenarSelectTarjetas();
}

function rellenarTablaTransacciones() {
    const tb = document.querySelector("#tabla-transacciones tbody");
    tb.innerHTML = "";
    const mes = obtenerAnioMesActual();
    let l = transaccionesLocal.filter(t => t.fecha && t.fecha.startsWith(mes));
    const ft = document.getElementById("filtro-texto").value.toLowerCase();
    const ff = document.getElementById("filtro-fecha").value;
    if (ft) l = l.filter(t => (t.descripcion || "").toLowerCase().includes(ft));
    if (ff) l = l.filter(t => t.fecha === ff);
    l.sort((a, b) => a.fecha < b.fecha ? 1 : -1);

    l.forEach(t => {
        const tr = document.createElement("tr");
        let catNombre = "-";
        if (t.categoriaId === null && t.gastoFijoId) {
            const f = fijosLocal.find(x => x.id === t.gastoFijoId);
            catNombre = "Fijo: " + (f ? f.descripcion : "");
        } else {
            const c = categoriasLocal.find(x => x.id === t.categoriaId);
            catNombre = c ? c.nome : "-";
        }
        let origenTexto = "-";
        if (t.tipo === "salida") {
            if (t.origen === "tarjeta" && t.tarjetaId) {
                const tar = tarjetasLocal.find(x => x.id === t.tarjetaId);
                origenTexto = "üí≥ " + (tar ? `${tar.alias}` : "");
            } else {
                // TRADU√á√ÉO APLICADA AQUI:
                origenTexto = "üíµ " + translations[currentLang].opt_efectivo;
            }
        }

        tr.innerHTML = `<td>${t.fecha}</td><td><span class="tag ${t.tipo}">${t.tipo}</span></td><td>${catNombre}</td><td>${origenTexto}</td><td>${t.descripcion || ""}</td><td>${formatearMoneda(t.valor)}</td><td></td>`;
        const btn = document.createElement("button");
        btn.className = "btn-icon btn-icon-danger";
        btn.textContent = "X";
        btn.onclick = () => window.eliminarTransaccion(t.id);
        tr.lastElementChild.appendChild(btn);
        tb.appendChild(tr);
    });
}

function actualizarResumen() {
    const transMes = filtrarMesActual(transaccionesLocal, "fecha");
    let totalEntradas = 0;
    let totalSalidas = 0;
    let totalSalidasFijos = 0;
    let totalSalidasOtros = 0;

    transMes.forEach(t => {
        const v = Number(t.valor) || 0;
        if (t.tipo === "entrada") {
            totalEntradas += v;
        } else if (t.tipo === "salida") {
            totalSalidas += v;
            if (t.gastoFijoId) totalSalidasFijos += v;
            else totalSalidasOtros += v;
        }
    });

    const saldo = totalEntradas - totalSalidas;

    document.getElementById("stat-entradas").textContent = formatearMoneda(totalEntradas);
    document.getElementById("stat-salidas").textContent = formatearMoneda(totalSalidas);
    document.getElementById("stat-saldo").textContent = formatearMoneda(saldo);

    const saldoTexto = document.getElementById("stat-saldo-texto");
    if (saldo > 0) saldoTexto.textContent = "Ok :)";
    else if (saldo < 0) saldoTexto.textContent = "Alert :(";
    else saldoTexto.textContent = "-";

    const contenedorDist = document.getElementById("contenedor-distribucion");
    contenedorDist.innerHTML = "";

    let gastosPorCat = {};
    let totalGastado = 0;

    transMes.forEach(t => {
        if (t.tipo === "salida") {
            let nombreCat = "Sin categor√≠a";
            if (t.gastoFijoId) {
                nombreCat = "Fijos";
            } else if (t.categoriaId) {
                const c = categoriasLocal.find(cat => cat.id === t.categoriaId);
                if (c) nombreCat = c.nome;
            }
            const v = Number(t.valor) || 0;
            if (!gastosPorCat[nombreCat]) gastosPorCat[nombreCat] = 0;
            gastosPorCat[nombreCat] += v;
            totalGastado += v;
        }
    });

    if (totalGastado === 0) {
        contenedorDist.innerHTML = '<div style="text-align:center; color:#64748b; font-size:0.9rem; padding:1rem;">...</div>';
    } else {
        const ordenados = Object.keys(gastosPorCat).sort((a, b) => gastosPorCat[b] - gastosPorCat[a]);

        ordenados.forEach(cat => {
            const valor = gastosPorCat[cat];
            const porcentaje = (valor / totalGastado) * 100;

            const row = document.createElement("div");
            row.className = "dist-row";
            row.innerHTML = `
         <span style="width:100px; color:#cbd5e1;">${cat}</span>
         <div class="dist-bar-bg">
             <div class="dist-bar-fill" style="width:${porcentaje}%; background:${getColorParaCategoria(cat)}"></div>
         </div>
         <span style="width:60px; text-align:right; color:#fff;">${Math.round(porcentaje)}%</span>
     `;
            contenedorDist.appendChild(row);
        });
    }

    const lblMeta = document.getElementById("stat-meta-uso");
    const lblIngreso = document.getElementById("stat-ingreso-alerta");

    if (metaMensualUsuario > 0) {
        const uso = (totalSalidas / metaMensualUsuario) * 100;
        const restanteMeta = metaMensualUsuario - totalSalidas;

        dibujarGraficoMeta(uso, formatearMoneda(restanteMeta));

        lblMeta.textContent = `Meta: ${formatearMoneda(metaMensualUsuario)}`;

        lblMeta.className = "stat-small";
        if (uso < 50) lblMeta.classList.add("semaforo-verde");
        else if (uso >= 50 && uso < 80) lblMeta.classList.add("semaforo-amarillo");
        else {
            lblMeta.classList.add("semaforo-rojo");
            if ("vibrate" in navigator && uso >= 80) navigator.vibrate(200);
        }
    } else {
        dibujarGraficoMeta(0, "");
        lblMeta.textContent = "Define una meta mensual en Perfil.";
        lblMeta.className = "stat-small";
    }

    if (ingresoMensualUsuario > 0) {
        const ratio = (totalSalidas / ingresoMensualUsuario) * 100;
        lblIngreso.textContent = `Ratio: ${ratio.toFixed(1)}%`;
    } else {
        lblIngreso.textContent = "";
    }
}

function calcularAhorroTotal() {
    let e = 0, s = 0;
    transaccionesLocal.forEach(t => {
        const v = Number(t.valor) || 0;
        if (t.tipo === "entrada") e += v;
        else s += v;
    });
    return e - s;
}

function actualizarObjetivo() {
    const elProyeccion = document.getElementById("obj-proyeccion");
    elProyeccion.textContent = "";

    if (!objetivoNombre || !objetivoValor || objetivoValor <= 0) {
        document.getElementById("obj-nombre").textContent = "-";
        document.getElementById("obj-meta").textContent = "-";
        document.getElementById("obj-ahorrado").textContent = formatearMoneda(0);
        document.getElementById("obj-restante").textContent = formatearMoneda(0);
        document.getElementById("obj-texto").textContent = "Define un objetivo en Perfil.";
        dibujarGraficoObjetivo(0, "");
        rellenarHistorialObjetivos();
        return;
    }

    const ahorroTotal = calcularAhorroTotal();
    const base = Number(objetivoAhorroBase) || 0;
    let ahorroObjetivo = ahorroTotal - base;

    if (ahorroObjetivo < 0) ahorroObjetivo = 0;

    if (!objetivoCompletado && ahorroObjetivo >= objetivoValor) {
        objetivoCompletado = true;
        const hoy = new Date().toISOString().slice(0, 10);
        objetivosHistorial.push({ nombre: objetivoNombre, valorMeta: objetivoValor, ahorroFinal: ahorroObjetivo, fechaInicio: objetivoFechaInicio, fechaConclusion: hoy });
        guardarPerfilEnServidor();
    }

    const pct = (ahorroObjetivo / objetivoValor) * 100;
    const restante = Math.max(0, objetivoValor - ahorroObjetivo);

    document.getElementById("obj-nombre").textContent = objetivoNombre;
    document.getElementById("obj-meta").textContent = formatearMoneda(objetivoValor);
    document.getElementById("obj-ahorrado").textContent = formatearMoneda(ahorroObjetivo);
    document.getElementById("obj-restante").textContent = formatearMoneda(restante);

    if (restante <= 0) {
        document.getElementById("obj-texto").textContent = "100%";
    } else {
        document.getElementById("obj-texto").textContent = `${pct.toFixed(1)}%`;

        const transMes = filtrarMesActual(transaccionesLocal, "fecha");
        let eMes = 0; let sMes = 0;
        transMes.forEach(t => {
            const v = Number(t.valor) || 0;
            if (t.tipo === "entrada") eMes += v; else sMes += v;
        });
        let saldoMes = eMes - sMes;

        const diaHoy = new Date().getDate();
        const ritmoDiario = saldoMes / (diaHoy || 1);
        const ahorroProyectadoMensual = ritmoDiario * 30;

        if (ahorroProyectadoMensual <= 0) {
            elProyeccion.textContent = "";
        } else {
            const mesesFaltantes = restante / ahorroProyectadoMensual;
            const diasFaltantes = Math.ceil(mesesFaltantes * 30);
            elProyeccion.textContent = `~ ${diasFaltantes} days left`;
        }
    }

    dibujarGraficoObjetivo(pct, formatearMoneda(restante));
    rellenarHistorialObjetivos();
}

function rellenarHistorialObjetivos() {
    const tb = document.querySelector("#tabla-historial-objetivos tbody"); tb.innerHTML = "";
    objetivosHistorial.forEach(o => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${o.nombre}</td><td>${formatearMoneda(o.valorMeta)}</td><td>${formatearMoneda(o.ahorroFinal)}</td><td>${o.fechaInicio}</td><td>${o.fechaConclusion}</td>`;
        tb.appendChild(tr);
    });
}

function analisisLatam() {
    const edad = edadUsuario;
    const pais = paisUsuario;
    if (!metaMensualUsuario || !pais || !edad) {
        document.getElementById("perfil-analisis").textContent = "Completa perfil para an√°lisis.";
        return;
    }
    const base = { bo: 1500, br: 3000, ar: 250000, cl: 400000, mx: 9000, otro: 700 };
    const basePais = base[pais] || base.otro;
    const referencia = basePais;
    const ratio = referencia > 0 ? (metaMensualUsuario / referencia) * 100 : 0;
    let mensaje;
    if (ratio < 70) mensaje = "Tu meta es baja comparada al promedio.";
    else if (ratio <= 120) mensaje = "Tu meta es razonable.";
    else mensaje = "Tu meta es alta.";
    document.getElementById("perfil-analisis").textContent = mensaje;
}

function actualizarCampoGastoFijo() {
    const t = document.getElementById("tipo").value;
    const c = document.getElementById("categoria").value;
    const el = document.getElementById("campo-gasto-fijo");
    if (el) el.classList.toggle("hidden", !(t === "salida" && c === "__gasto_fijo__"));
}
function actualizarCampoOrigenYTarjeta() {
    const t = document.getElementById("tipo").value;
    const o = document.getElementById("origen").value;
    const divO = document.getElementById("campo-origen");
    const divT = document.getElementById("campo-tarjeta");
    if (t === "salida") {
        divO.classList.remove("hidden");
        divT.classList.toggle("hidden", o !== "tarjeta");
    } else {
        divO.classList.add("hidden");
        divT.classList.add("hidden");
    }
}

function dibujarGraficoMeta(porcentajeUsado, textoCentro) {
    const canvas = document.getElementById("meta-chart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width; const h = canvas.height;
    const cx = w / 2; const cy = h / 2;
    const radio = Math.min(w, h) / 2 - 10;
    const innerRadio = radio * 0.6;
    ctx.clearRect(0, 0, w, h);

    ctx.beginPath(); ctx.arc(cx, cy, radio, 0, Math.PI * 2); ctx.fillStyle = "rgba(255,255,255,0.05)"; ctx.fill();

    const clamped = Math.max(0, Math.min(porcentajeUsado, 100)) / 100;
    const inicio = -Math.PI / 2;
    const fin = inicio + Math.PI * 2 * clamped;

    ctx.beginPath(); ctx.arc(cx, cy, radio, inicio, fin);
    ctx.lineCap = "round";
    ctx.lineWidth = 12;

    let color = "#4ade80";
    if (porcentajeUsado > 80) color = "#f87171";
    else if (porcentajeUsado > 50) color = "#facc15";

    ctx.strokeStyle = color;
    ctx.stroke();

    ctx.beginPath(); ctx.arc(cx, cy, innerRadio, 0, Math.PI * 2); ctx.fillStyle = "#020617"; ctx.fill();

    if (textoCentro) {
        const esNegativo = textoCentro.includes("-");
        ctx.fillStyle = esNegativo ? "#f87171" : "#fff";
        ctx.font = "bold 12px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(textoCentro, cx, cy);

        ctx.fillStyle = "#94a3b8";
        ctx.font = "10px sans-serif";
        // TRADU√á√ÉO DO TEXTO 'RESTANTE'
        ctx.fillText(translations[currentLang].chart_restante, cx, cy + 15);
    }
}

function dibujarGraficoObjetivo(porcentaje, textoCentro) {
    const canvas = document.getElementById("objetivo-chart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width; const h = canvas.height;
    const cx = w / 2; const cy = h / 2;
    const radio = Math.min(w, h) / 2 - 10;
    const innerRadio = radio * 0.6;
    ctx.clearRect(0, 0, w, h);

    ctx.beginPath(); ctx.arc(cx, cy, radio, 0, Math.PI * 2); ctx.fillStyle = "rgba(255,255,255,0.05)"; ctx.fill();
    const end = -Math.PI / 2 + (Math.PI * 2 * (Math.min(porcentaje, 100) / 100));

    const grad = ctx.createLinearGradient(0, 0, w, h);
    grad.addColorStop(0, "#ec4899");
    grad.addColorStop(1, "#8b5cf6");

    ctx.beginPath(); ctx.arc(cx, cy, radio, -Math.PI / 2, end);
    ctx.lineCap = "round";
    ctx.lineWidth = 12;
    ctx.strokeStyle = grad;
    ctx.stroke();

    ctx.beginPath(); ctx.arc(cx, cy, innerRadio, 0, Math.PI * 2); ctx.fillStyle = "#020617"; ctx.fill();

    if (textoCentro) {
        ctx.fillStyle = "#fff";
        ctx.font = "bold 12px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(textoCentro, cx, cy);

        ctx.fillStyle = "#94a3b8";
        ctx.font = "10px sans-serif";
        // TRADU√á√ÉO DO TEXTO 'FALTA'
        ctx.fillText(translations[currentLang].chart_falta, cx, cy + 15);
    }
}

function rellenarPerfil() {
    document.getElementById("perfil-edad").value = edadUsuario || "";
    document.getElementById("perfil-sexo").value = sexoUsuario || "";
    document.getElementById("perfil-pais").value = paisUsuario || "";
    document.getElementById("perfil-meta").value = metaMensualUsuario || "";
    document.getElementById("perfil-ingreso").value = ingresoMensualUsuario || "";
    document.getElementById("perfil-moneda").value = monedaUsuario || "";
    document.getElementById("perfil-objetivo-nombre").value = objetivoNombre || "";
    document.getElementById("perfil-objetivo-valor").value = objetivoValor || "";
}

function inicializarReporte() {
    const sel = document.getElementById("reporte-mes");
    sel.innerHTML = "";
    const meses = new Set();
    meses.add(obtenerAnioMesActual());
    transaccionesLocal.forEach(t => {
        if (t.fecha && t.fecha.length >= 7) meses.add(t.fecha.slice(0, 7));
    });

    const ordenados = Array.from(meses).sort().reverse();
    ordenados.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = nombreMes(m) + " (" + m + ")";
        sel.appendChild(opt);
    });

    sel.onchange = () => cargarDatosReporte(sel.value);
    if (ordenados.length > 0) cargarDatosReporte(ordenados[0]);
}

function cargarDatosReporte(mes) {
    const filtradas = transaccionesLocal.filter(t => t.fecha && t.fecha.startsWith(mes));
    let e = 0, s = 0;
    let gastosPorCat = {};

    filtradas.forEach(t => {
        const v = Number(t.valor) || 0;
        if (t.tipo === "entrada") e += v;
        else {
            s += v;
            let catName = "Sin categor√≠a";
            if (t.gastoFijoId) catName = "Gasto Fijo";
            else if (t.categoriaId) {
                const c = categoriasLocal.find(x => x.id === t.categoriaId);
                if (c) catName = c.nome;
            }
            if (!gastosPorCat[catName]) gastosPorCat[catName] = 0;
            gastosPorCat[catName] += v;
        }
    });

    document.getElementById("rep-entradas").textContent = formatearMoneda(e);
    document.getElementById("rep-salidas").textContent = formatearMoneda(s);
    document.getElementById("rep-saldo").textContent = formatearMoneda(e - s);

    const tb = document.querySelector("#reporte-tabla-categorias tbody");
    tb.innerHTML = "";

    Object.keys(gastosPorCat).forEach(k => {
        const v = gastosPorCat[k];
        const pct = s > 0 ? (v / s) * 100 : 0;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${k}</td><td>Salida</td><td>${formatearMoneda(v)}</td><td>${pct.toFixed(1)}%</td>`;
        tb.appendChild(tr);
    });
}

document.getElementById("reporte-mes-actual").addEventListener("click", () => {
    const current = obtenerAnioMesActual();
    const sel = document.getElementById("reporte-mes");
    sel.value = current;
    cargarDatosReporte(current);
});
// --- FUN√á√ÉO DE CORES (QUE ESTAVA FALTANDO) ---
function getColorParaCategoria(nombre) {
 let hash = 0;
 for (let i = 0; i < nombre.length; i++) {
     hash = nombre.charCodeAt(i) + ((hash << 5) - hash);
 }
 const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
 return "#" + "00000".substring(0, 6 - c.length) + c;
}

// SUBSTITUA a fun√ß√£o 'estadoFijoParaMes' inteira por esta:
function estadoFijoParaMes(gasto, anioMes) {
    
    // 1. NOVO: Verifica se este gasto s√≥ come√ßa no futuro
    // Se o m√™s atual (anioMes) for ANTERIOR ao m√™s de in√≠cio gravado no banco
    if (gasto.mes_inicio && anioMes < gasto.mes_inicio) {
        return { 
            texto: "Pr√≥x. M√™s", 
            badgeClase: "badge-normal", 
            claseFila: "" // Fica cinza/transparente, sem alerta
        };
    }

    // 2. Verifica se j√° foi pago
    const estaPagado = transaccionesLocal.some(t => 
        t.tipo === "salida" && 
        t.gastoFijoId === gasto.id && 
        t.fecha && t.fecha.startsWith(anioMes)
    );

    if (estaPagado) {
        return { texto: "Pago", badgeClase: "badge-verde", claseFila: "fijo-verde" };
    }

    // 3. L√≥gica de datas
    const hoy = new Date();
    const diaHoy = hoy.getDate();
    const [anio, mes] = anioMes.split("-");
    
    // Hist√≥rico passado
    if (anioMes < obtenerAnioMesActual()) {
         return { texto: "Vencido", badgeClase: "badge-rojo", claseFila: "fijo-rojo" };
    }
    // Futuro (al√©m do mes_inicio j√° verificado)
    if (anioMes > obtenerAnioMesActual()) {
        return { texto: "Pendiente", badgeClase: "badge-normal", claseFila: "" };
    }

    // M√™s atual: verifica dia
    const diaVenc = gasto.vencimiento;
    
    if (diaHoy > diaVenc) {
        return { texto: "Vencido", badgeClase: "badge-rojo", claseFila: "fijo-rojo" };
    } else if (diaVenc - diaHoy <= 3) {
        return { texto: "Vence pronto", badgeClase: "badge-amarillo", claseFila: "fijo-amarillo" };
    } else {
        return { texto: "Pendiente", badgeClase: "badge-normal", claseFila: "" };
    }
}

// --- FUN√á√ÉO: MOSTRAR BARRA DE VENCIMENTO (LAYOUT CORRIGIDO + SUPORTE A TRADU√á√ÉO) ---
function mostrarAvisoVencimento(diasRestantes) {
    // Evita criar duas barras se j√° tiver uma
    if(document.getElementById("barra-aviso-vencimento")) return;

    // 1. Define o texto inicial baseado no idioma atual
    const esPt = currentLang === 'pt';
    let textoMensagem = "";

    if (diasRestantes === 0) {
        textoMensagem = esPt 
            ? "‚ö†Ô∏è ATEN√á√ÉO: Sua assinatura vence HOJE!" 
            : "‚ö†Ô∏è ATENCI√ìN: ¬°Tu suscripci√≥n vence HOY!";
    } else {
        textoMensagem = esPt 
            ? `‚ö†Ô∏è ATEN√á√ÉO: Sua assinatura vence em ${diasRestantes} dias.` 
            : `‚ö†Ô∏è ATENCI√ìN: Tu suscripci√≥n vence en ${diasRestantes} d√≠as.`;
    }

    // 2. Cria a barra visual
    const aviso = document.createElement("div");
    aviso.id = "barra-aviso-vencimento";
    
    // IMPORTANTE: Salvamos os dias aqui para a tradu√ß√£o funcionar depois
    aviso.dataset.dias = diasRestantes; 

    aviso.style.cssText = `
        background: linear-gradient(90deg, #ef4444, #b91c1c);
        color: #fff; 
        text-align: center; 
        padding: 12px;
        width: 100%;
        position: relative;
        z-index: 99999; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        gap: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    `;
    
    // Adicionei a classe 'msg-texto' no span para podermos trocar o texto via c√≥digo depois
    aviso.innerHTML = `
        <span class="msg-texto" style="font-weight:600; font-size: 0.9rem; line-height: 1.2;">${textoMensagem}</span>
        <button onclick="this.parentElement.remove()" style="
            background: rgba(0,0,0,0.2); 
            border: none; 
            color: #fff; 
            border-radius: 50%; 
            width: 28px; 
            height: 28px; 
            cursor: pointer; 
            font-weight: bold;
            min-width: 28px;
            display: flex; align-items: center; justify-content: center;
        ">‚úï</button>
    `;
    
    document.body.prepend(aviso);
}

</script>
</body>
</html>