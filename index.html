<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Control Financiero (Firebase)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
 /* --- SEU CSS ORIGINAL (INTACTO) + NUEVOS ESTILOS --- */
 * { box-sizing: border-box; margin: 0; padding: 0; }

 body {
   font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
   background: radial-gradient(circle at top left, #0f172a, #020617 45%, #111827 100%);
   color: #e5e7eb;
   padding-bottom: 2rem; /* Espacio extra al final */
 }

 /* INDICADOR DE CARREGAMENTO */
 #loading-overlay {
   position: fixed;
   top: 0; left: 0; right: 0; bottom: 0;
   background: rgba(2, 6, 23, 0.85);
   z-index: 100;
   display: flex;
   align-items: center;
   justify-content: center;
   font-weight: bold;
   color: #22c55e;
   font-size: 1.2rem;
   backdrop-filter: blur(4px);
 }

 header {
   background: linear-gradient(90deg, #0ea5e9, #6366f1);
   color: #f9fafb;
   padding: 0.75rem 1rem;
   display: flex;
   align-items: center;
   justify-content: space-between;
   box-shadow: 0 2px 12px rgba(15, 23, 42, 0.6);
   position: sticky;
   top: 0;
   z-index: 30;
 }

 header h1 {
   font-size: 1.1rem;
   font-weight: 600;
 }

 header .user-info {
   font-size: 0.85rem;
   display: flex;
   align-items: center;
   gap: 0.5rem;
 }

 header button {
   margin-left: 0.25rem;
   padding: 0.25rem 0.7rem;
   border-radius: 999px;
   border: none;
   cursor: pointer;
   font-size: 0.8rem;
   background: rgba(15, 23, 42, 0.15);
   color: #e5e7eb;
   backdrop-filter: blur(6px);
 }

 header button:hover {
   background: rgba(15, 23, 42, 0.35);
 }

 .container {
   display: flex;
   min-height: calc(100vh - 50px);
 }

 nav {
   width: 230px;
   background: rgba(15,23,42,0.98);
   color: #e5e7eb;
   padding: 1rem 0.75rem;
   box-shadow: 4px 0 16px rgba(0,0,0,0.7);
   position: sticky;
   top: 50px;
   height: calc(100vh - 50px);
 }

 nav h2 {
   font-size: 0.85rem;
   text-transform: uppercase;
   margin-bottom: 0.5rem;
   color: #9ca3af;
   letter-spacing: 0.08em;
 }

 nav button {
   width: 100%;
   text-align: left;
   background: transparent;
   border: none;
   color: inherit;
   padding: 0.5rem 0.4rem;
   border-radius: 8px;
   cursor: pointer;
   font-size: 0.9rem;
   display: flex;
   align-items: center;
   gap: 0.4rem;
   transition: background 0.15s, transform 0.1s;
 }

 nav button::before {
   content: "";
   width: 6px;
   height: 6px;
   border-radius: 999px;
   background: #4b5563;
 }

 nav button:hover {
   background: #111827;
   transform: translateX(2px);
 }

 nav button.active {
   background: linear-gradient(90deg, #1d4ed8, #22c55e);
   color: #f9fafb;
 }
 nav button.active::before {
   background: #f9fafb;
 }

 main {
   flex: 1;
   padding: 1rem;
   overflow-y: auto;
 }

 .main-inner {
   max-width: 1150px;
   margin: 0 auto;
 }

 .card {
   background: radial-gradient(circle at top left, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
   border-radius: 14px;
   padding: 0.9rem 1rem;
   margin-bottom: 1rem;
   box-shadow: 0 14px 35px rgba(15,23,42,0.8);
   border: 1px solid rgba(148,163,184,0.45);
   backdrop-filter: blur(12px);
   transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
 }

 .card:hover {
   transform: translateY(-2px);
   box-shadow: 0 18px 40px rgba(0,0,0,0.9);
 }

 .card h3 {
   font-size: 1rem;
   margin-bottom: 0.5rem;
   font-weight: 600;
   color: #e5e7eb;
 }

 .card-subtitle {
   font-size: 0.8rem;
   color: #9ca3af;
   margin-bottom: 0.4rem;
 }

 .grid {
   display: grid;
   grid-template-columns: repeat(3, minmax(0, 1fr));
   gap: 0.75rem;
 }

 .stat {
   background: radial-gradient(circle at top, #0b1120, #020617);
   border-radius: 10px;
   padding: 0.55rem 0.75rem;
   border: 1px solid #1f2937;
   box-shadow: inset 0 0 0 1px rgba(148,163,184,0.25);
 }

 .stat-label {
   font-size: 0.75rem;
   color: #9ca3af;
   margin-bottom: 0.1rem;
 }

 .stat-value {
   font-size: 1rem;
   font-weight: 700;
   color: #f9fafb;
 }

 .stat-small {
   font-size: 0.75rem;
   color: #9ca3af;
 }

 /* NUEVO: ESTILOS PARA PREDICCIONES Y SEM√ÅFORO */
 .stat-prediction {
    font-size: 0.8rem; color: #38bdf8; margin-top: 0.3rem;
    font-style: italic; border-top: 1px solid #1e293b; padding-top: 0.3rem;
 }
 
 .semaforo-verde { color: #22c55e; text-shadow: 0 0 10px rgba(34, 197, 94, 0.5); }
 .semaforo-amarillo { color: #facc15; text-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
 .semaforo-rojo { color: #ef4444; text-shadow: 0 0 15px rgba(239, 68, 68, 0.8); animation: pulse 1.5s infinite; }
 
 @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; transform: scale(1.02); }
    100% { opacity: 1; }
 }
 
 /* ESTILOS DIN√ÅMICOS DE DISTRIBUCI√ìN */
 .dist-row {
     display: flex;
     align-items: center;
     justify-content: space-between;
     margin-bottom: 0.5rem;
     font-size: 0.85rem;
 }
 .dist-bar-bg {
     flex: 1;
     height: 6px;
     background: #1f2937;
     border-radius: 999px;
     margin: 0 1rem;
     overflow: hidden;
 }
 .dist-bar-fill {
     height: 100%;
     border-radius: 999px;
 }

 form {
   display: grid;
   grid-template-columns: repeat(4, minmax(0, 1fr));
   gap: 0.5rem;
   margin-top: 0.5rem;
   align-items: end;
 }

 form .full {
   grid-column: 1 / -1;
 }

 label {
   font-size: 0.8rem;
   color: #cbd5f5;
   margin-bottom: 0.15rem;
   display: block;
 }

 input, select {
   width: 100%;
   padding: 0.4rem 0.5rem;
   border-radius: 8px;
   border: 1px solid #4b5563;
   font-size: 0.85rem;
   background: #020617;
   color: #e5e7eb;
 }

 input::placeholder {
   color: #6b7280;
 }

 input:focus,
 select:focus {
   outline: 2px solid #22c55e;
   outline-offset: 1px;
   border-color: #22c55e;
 }

 button.primary {
   background: linear-gradient(135deg, #22c55e, #16a34a);
   color: #f9fafb;
   border-radius: 999px;
   padding: 0.4rem 0.9rem;
   border: none;
   cursor: pointer;
   font-size: 0.85rem;
   font-weight: 500;
   box-shadow: 0 4px 12px rgba(22,163,74,0.7);
   white-space: nowrap;
 }

 button.primary:hover {
   background: linear-gradient(135deg, #16a34a, #15803d);
 }
 
 /* BOT√ìN SECUNDARIO (NUEVO) */
 button.secondary {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: white; border-radius: 999px; padding: 0.4rem 0.9rem;
    border: none; cursor: pointer; font-size: 0.8rem;
 }

 .btn-icon {
   border-radius: 999px;
   border: 1px solid #4b5563;
   background: #020617;
   color: #e5e7eb;
   font-size: 0.75rem;
   padding: 0.25rem 0.6rem;
   cursor: pointer;
   line-height: 1.2;
 }

 .btn-icon-danger {
   border-color: #ef4444;
   color: #fecaca;
 }

 .btn-icon-danger:hover {
   background: #7f1d1d;
   border-color: #f97316;
 }

 .tabla-wrapper {
   margin-top: 0.5rem;
   overflow-x: auto;
   border-radius: 10px;
   border: 1px solid #1f2937;
   background: #020617;
 }

 table {
   width: 100%;
   border-collapse: collapse;
   font-size: 0.85rem;
   color: #e5e7eb;
 }

 th, td {
   border-bottom: 1px solid #1f2937;
   padding: 0.4rem 0.55rem;
   text-align: left;
   white-space: nowrap;
 }

 th {
   background: #020617;
   font-weight: 500;
   color: #9ca3af;
   position: sticky;
   top: 0;
   z-index: 1;
 }

 tr:nth-child(even) td {
   background: #020617;
 }

 tr:nth-child(odd) td {
   background: #030712;
 }

 .tag {
   display: inline-flex;
   align-items: center;
   padding: 0.1rem 0.45rem;
   border-radius: 999px;
   font-size: 0.7rem;
   border: 1px solid #4b5563;
   margin-right: 0.25rem;
   text-transform: capitalize;
 }

 .tag.entrada {
   border-color: #0ea5e9;
   background: #0c4a6e;
   color: #e0f2fe;
 }
 .tag.salida {
   border-color: #f97316;
   background: #451a03;
   color: #fed7aa;
 }

 .hidden { display: none !important; }

 /* LOGIN */
 #login-screen {
   min-height: 100vh;
   display: flex;
   align-items: center;
   justify-content: center;
   background: radial-gradient(circle at top, #0b1120, #020617 60%);
   color: #f9fafb;
   padding: 1rem;
 }

 #login-box {
   background: radial-gradient(circle at top left, #020617, #020617);
   border-radius: 18px;
   border: 1px solid #4b5563;
   padding: 1.6rem;
   width: 100%;
   max-width: 380px;
   box-shadow: 0 25px 70px rgba(0,0,0,0.9);
   backdrop-filter: blur(14px);
 }

 #login-box h2 {
   font-size: 1.25rem;
   margin-bottom: 0.75rem;
 }

 #login-box p {
   font-size: 0.85rem;
   color: #9ca3af;
   margin-bottom: 1rem;
 }

 #login-box form {
   display: grid;
   grid-template-columns: 1fr;
   gap: 0.75rem;
 }

 #login-box label {
   color: #e5e7eb;
 }

 #login-box input {
   background: #020617;
   border-color: #4b5563;
   color: #f9fafb;
 }

 #login-box button {
   padding: 0.45rem 0.75rem;
   border-radius: 999px;
   border: none;
   cursor: pointer;
   font-size: 0.9rem;
   font-weight: 500;
 }

 #login-box button.primary {
   width: 100%;
   background: linear-gradient(135deg, #22c55e, #16a34a);
   box-shadow: 0 4px 14px rgba(22,163,74,0.8);
 }

 #login-box button.primary:hover {
   background: linear-gradient(135deg, #16a34a, #15803d);
 }

 #login-toggle {
   display: flex;
   justify-content: space-between;
   margin-top: 0.3rem;
   font-size: 0.8rem;
   color: #9ca3af;
 }

 #login-toggle button {
   background: transparent;
   color: #38bdf8;
   padding: 0;
   box-shadow: none;
 }

 #login-message {
   font-size: 0.8rem;
   margin-top: 0.4rem;
   min-height: 1rem;
   color: #f97316;
 }

 #register-extra {
   display: grid;
   grid-template-columns: 1fr;
   gap: 0.75rem;
 }

 /* FILAS DE GASTOS FIJOS CON ESTADO */
 .fijo-amarillo { background: #422006 !important; }
 .fijo-rojo { background: #450a0a !important; }
 .fijo-verde { background: #022c22 !important; }

 .badge-estado {
   display: inline-flex;
   align-items: center;
   padding: 0.05rem 0.45rem;
   border-radius: 999px;
   font-size: 0.7rem;
   font-weight: 500;
 }
 .badge-amarillo { background: #facc15; color: #1f2937; }
 .badge-rojo { background: #ef4444; color: #f9fafb; }
 .badge-verde { background: #22c55e; color: #022c22; }
 .badge-normal { background: #4b5563; color: #e5e7eb; }

 .reporte-controles {
   margin-top: 0.5rem;
   display: flex;
   flex-wrap: wrap;
   gap: 0.75rem;
   align-items: flex-end;
 }
 .reporte-controles > div {
   min-width: 160px;
 }

 /* MODAL PRIMEROS PASOS */
 .modal {
   position: fixed;
   inset: 0;
   background: rgba(15,23,42,0.85);
   display: flex;
   align-items: center;
   justify-content: center;
   z-index: 40;
 }

 @media (max-width: 900px) {
   .grid { grid-template-columns: 1fr; }
   form { grid-template-columns: 1fr; }
 }

 @media (max-width: 768px) {
   nav { display: none; position: fixed; top: 50px; left: 0; height: calc(100vh - 50px); z-index: 20; }
   nav.open { display: block; }
   .container { flex-direction: column; }
   main { padding: 0.75rem; }
   .main-inner { max-width: 100%; }
   header button#menu-toggle { display: inline-block; }
 }

 @media (min-width: 769px) {
   header button#menu-toggle { display: none; }
 }
</style>
</head>

<body>

<div id="loading-overlay" class="hidden">Cargando datos...</div>

<section id="login-screen">
<div id="login-box">
<h2>Entrar al Control Financiero</h2>
<p>Inicia sesi√≥n o crea una cuenta. (Firebase)</p>

<form id="login-form">
  <div>
    <label for="login-email">Correo electr√≥nico</label>
    <input type="email" id="login-email" required placeholder="tu@ejemplo.com" />
  </div>
  <div>
    <label for="login-password">Contrase√±a</label>
    <input type="password" id="login-password" required />
  </div>

  <div id="register-extra" class="hidden">
    <p style="font-size:0.7rem; color:#facc15;">Datos adicionales se configuran en Perfil.</p>
  </div>

  <button type="submit" class="primary" id="login-submit">Entrar</button>
  <div id="login-toggle">
    <span id="toggle-text">¬øNo tienes cuenta?</span>
    <button type="button" id="toggle-mode">Crear cuenta</button>
  </div>
  <div id="login-message"></div>
</form>
</div>
</section>

<div id="app" class="hidden">
<header>
<div style="display:flex; align-items:center; gap:0.5rem;">
  <button id="menu-toggle">‚ò∞</button>
  <h1>Control Financiero</h1>
</div>
<div class="user-info">
  <span id="user-email"></span>
  <button id="logout-btn">Salir</button>
</div>
</header>

<div class="container">
<nav id="sidebar">
  <h2>Men√∫</h2>
  <button data-section="dashboard" class="active">Dashboard</button>
  <button data-section="transacciones">Transacciones</button>
  <button data-section="fijos">Gastos fijos</button>
  <button data-section="tarjetas">Tarjetas</button>
  <button data-section="reportes">Reporte mensual</button>
  <button data-section="categorias">Categor√≠as y metas</button>
  <button data-section="perfil">Perfil</button>
</nav>

<main>
  <div class="main-inner">

    <section id="section-dashboard">
      <div class="card">
        <h3>Resumen del mes actual</h3>
        <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:stretch; margin-top:0.5rem;">
          <div style="flex:2 1 220px;">
            <div class="grid">
              <div class="stat">
                <div class="stat-label">Entradas</div>
                <div class="stat-value" id="stat-entradas">$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Salidas</div>
                <div class="stat-value" id="stat-salidas">$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Saldo</div>
                <div class="stat-value" id="stat-saldo">$ 0,00</div>
                <div class="stat-small" id="stat-saldo-texto"></div>
              </div>
            </div>
          </div>
          <div style="flex:1 1 160px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <canvas id="meta-chart" width="160" height="160"></canvas>
            <!-- AQU√ç MODIFICADO PARA SEM√ÅFORO -->
            <div class="stat-small" id="stat-meta-uso" style="margin-top:0.4rem; text-align:center;"></div>
            <div class="stat-small" id="stat-ingreso-alerta" style="margin-top:0.25rem; text-align:center;"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
           <h3>Objetivo de ahorro espec√≠fico</h3>
           <!-- BOT√ìN NUEVO SIMULADOR -->
           <button type="button" class="secondary" id="btn-abrir-simulador">üîÆ Simular</button>
        </div>
        <p class="card-subtitle">
          Define un objetivo en la secci√≥n Perfil.
        </p>
        <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:stretch; margin-top:0.5rem;">
          <div style="flex:2 1 220px;">
            <div class="stat">
              <div class="stat-label">Objetivo</div>
              <div class="stat-value" id="obj-nombre">Sin objetivo definido</div>
              <div class="stat-small">
                Meta: <span id="obj-meta">-</span>
              </div>
            </div>
            <div class="grid" style="margin-top:0.5rem;">
              <div class="stat">
                <div class="stat-label">Ahorro acumulado</div>
                <div class="stat-value" id="obj-ahorrado">$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Falta para el objetivo</div>
                <div class="stat-value" id="obj-restante">$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Detalle y Proyecci√≥n</div>
                <div class="stat-small" id="obj-texto"></div>
                <!-- NUEVO CAMPO PROYECCI√ìN -->
                <div class="stat-prediction" id="obj-proyeccion"></div>
              </div>
            </div>
          </div>
          <div style="flex:1 1 160px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <canvas id="objetivo-chart" width="160" height="160"></canvas>
          </div>
        </div>
      </div>

      <!-- NUEVA TARJETA VIAJERO EN EL TIEMPO -->
      <div class="card">
          <h3>Proyecci√≥n Financiera (Viajero en el Tiempo)</h3>
          <p class="card-subtitle">L√≠nea continua: Tu saldo real. L√≠nea punteada: Tu futuro estimado si sigues gastando igual.</p>
          <div style="width:100%; overflow-x:auto; margin-top:1rem;">
              <canvas id="chart-time-travel" width="600" height="250" style="min-width:100%;"></canvas>
          </div>
       </div>

      <div class="card">
        <h3>Distribuci√≥n de salidas del mes</h3>
        <p class="card-subtitle">
          Desglose por categor√≠a (gastos fijos y variables).
        </p>
        <!-- CONTENEDOR DIN√ÅMICO PARA CATEGOR√çAS -->
        <div id="contenedor-distribucion" style="margin-top:0.5rem;">
          <!-- Se llena con JS -->
          <div style="text-align:center; color:#64748b; font-size:0.9rem; padding:1rem;">
            No hay datos suficientes este mes.
          </div>
        </div>
      </div>
    </section>

    <section id="section-transacciones" class="hidden">
      <div class="card">
        <h3>Nueva transacci√≥n</h3>
        <form id="form-transaccion">
          <div>
            <label for="tipo">Tipo</label>
            <select id="tipo" required>
              <option value="entrada">Entrada</option>
              <option value="salida">Salida</option>
            </select>
          </div>
          <div>
            <label for="categoria">Categor√≠a</label>
            <select id="categoria" required></select>
          </div>
          <!-- CAMBIO: NORMAL POR EFECTIVO -->
          <div id="campo-origen" class="hidden">
            <label for="origen">Origen (solo salidas)</label>
            <select id="origen">
              <option value="efectivo">Efectivo</option>
              <option value="tarjeta">Tarjeta</option>
            </select>
          </div>
          <div id="campo-tarjeta" class="hidden">
            <label for="tarjeta-select">Tarjeta</label>
            <select id="tarjeta-select"></select>
          </div>
          <div>
            <label for="valor">Valor</label>
            <input type="text" id="valor" required placeholder="Ej: 1.300,50" />
          </div>
          <div>
            <label for="data">Fecha</label>
            <input type="date" id="data" required />
          </div>
          <div id="campo-gasto-fijo" class="hidden">
            <label for="gasto-fijo-select">Seleccionar gasto fijo</label>
            <select id="gasto-fijo-select"></select>
          </div>
          <div class="full">
            <label for="descripcion">Descripci√≥n</label>
            <input type="text" id="descripcion" placeholder="Ej: Salario, Mercado, Cine, etc." />
          </div>
          <div>
            <button type="submit" class="primary">A√±adir</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>Transacciones del mes</h3>
        <div class="card-subtitle">
          Usa el buscador para encontrarlas por descripci√≥n o por fecha.
        </div>

        <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
          <div>
            <label for="filtro-texto">Buscar por descripci√≥n</label>
            <input type="text" id="filtro-texto" placeholder="Ej: mercado, cine, alquiler..." />
          </div>
          <div>
            <label for="filtro-fecha">Filtrar por fecha</label>
            <input type="date" id="filtro-fecha" />
          </div>
          <div>
            <button type="button" class="primary" id="btn-limpiar-filtros">Limpiar filtros</button>
          </div>
        </div>

        <div class="tabla-wrapper">
          <table id="tabla-transacciones">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Categor√≠a</th>
                <th>Origen</th>
                <th>Descripci√≥n</th>
                <th>Valor</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="section-fijos" class="hidden">
      <div class="card">
        <h3>Nuevo gasto fijo mensual</h3>
        <form id="form-fijo">
          <div>
            <label for="fijo-descripcion">Descripci√≥n</label>
            <input type="text" id="fijo-descripcion" required placeholder="Alquiler, Internet, etc." />
          </div>
          <div>
            <label for="fijo-valor">Valor mensual</label>
            <input type="text" id="fijo-valor" required placeholder="Ej: 1.300" />
          </div>
          <div>
            <label for="fijo-vencimiento">D√≠a de vencimiento</label>
            <input type="number" id="fijo-vencimiento" min="1" max="31" required />
          </div>
          <div>
            <button type="submit" class="primary">A√±adir fijo</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>Gastos fijos registrados</h3>
        <p class="card-subtitle">
          Amarillo = cerca de vencer (7 d√≠as) ¬∑ Rojo = vencido / d√≠a de vencimiento sin pago ¬∑ Verde = pagado este mes.
          Si el pago es parcial, ver√°s cu√°nto falta.
        </p>
        <div class="tabla-wrapper">
          <table id="tabla-fijos">
            <thead>
              <tr>
                <th>Descripci√≥n</th>
                <th>Valor</th>
                <th>Vencimiento</th>
                <th>Estado del mes</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="section-tarjetas" class="hidden">
      <div class="card">
        <h3>Registrar tarjeta</h3>
        <p class="card-subtitle">
          Guarda una referencia como los √∫ltimos d√≠gitos para saber de qu√© tarjeta sali√≥ el gasto.
        </p>
        <form id="form-tarjeta">
          <div>
            <label for="tarjeta-alias">Propietario</label>
            <input type="text" id="tarjeta-alias" placeholder="Ej: Juan P√©rez" />
          </div>
          <div>
            <label for="tarjeta-digitos">√öltimos d√≠gitos</label>
            <input type="text" id="tarjeta-digitos" maxlength="6" placeholder="Ej: 12345" />
          </div>
          <div>
            <label for="tarjeta-banco">Banco (opcional)</label>
            <input type="text" id="tarjeta-banco" placeholder="Ej: Banco Y" />
          </div>
          <div>
            <button type="submit" class="primary">A√±adir tarjeta</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>Tarjetas registradas</h3>
        <div class="tabla-wrapper">
          <table id="tabla-tarjetas">
            <thead>
              <tr>
                <th>Propietario</th>
                <th>√öltimos d√≠gitos</th>
                <th>Banco</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="section-reportes" class="hidden">
      <div class="card">
        <h3>Reporte mensual</h3>
        <p class="card-subtitle">
          Resumen de entradas, salidas y saldo de un mes, con desglose por categor√≠a.
          Puedes revisarlo al final de cada mes.
        </p>
        <div class="reporte-controles">
          <div>
            <label for="reporte-mes">Seleccionar mes</label>
            <select id="reporte-mes"></select>
          </div>
          <div>
            <button type="button" class="primary" id="reporte-mes-actual">
              Ir al mes actual
            </button>
          </div>
        </div>

        <div class="grid" style="margin-top:0.75rem;">
          <div class="stat">
            <div class="stat-label">Entradas del mes</div>
            <div class="stat-value" id="rep-entradas">$ 0,00</div>
          </div>
          <div class="stat">
            <div class="stat-label">Salidas del mes</div>
            <div class="stat-value" id="rep-salidas">$ 0,00</div>
          </div>
          <div class="stat">
            <div class="stat-label">Saldo del mes</div>
            <div class="stat-value" id="rep-saldo">$ 0,00</div>
            <div class="stat-small" id="rep-saldo-texto"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Gastos por categor√≠a (solo salidas)</h3>
        <div class="tabla-wrapper">
          <table id="reporte-tabla-categorias">
            <thead>
              <tr>
                <th>Categor√≠a</th>
                <th>Tipo</th>
                <th>Total gastado</th>
                <th>% sobre las salidas</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="section-categorias" class="hidden">
      <div class="card">
        <h3>Categor√≠as</h3>
        <form id="form-categoria">
          <div>
            <label for="cat-nome">Nombre de la categor√≠a</label>
            <input type="text" id="cat-nome" required placeholder="Ej: Mercado, Gasolina, Universidad, Salud" />
          </div>
          <div>
            <label for="cat-grupo">Tipo</label>
            <select id="cat-grupo" required>
              <option value="entrada">Entrada</option>
              <option value="salida">Salida</option>
            </select>
          </div>
          <div>
            <button type="submit" class="primary">A√±adir categor√≠a</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>Categor√≠as registradas</h3>
        <div class="tabla-wrapper">
          <table id="tabla-categorias">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="card-subtitle" style="margin-top:0.4rem;">
          El tipo define d√≥nde se usa la categor√≠a: <strong>Entrada</strong> o <strong>Salida</strong>.
        </p>
      </div>
    </section>

    <section id="section-perfil" class="hidden">
      <div class="card">
        <h3>Perfil financiero</h3>
        <p class="card-subtitle">
          Define tu edad, sexo, pa√≠s, moneda, ingreso mensual y una meta mensual general de gastos.
          Tambien puedes definir un objetivo espec√≠fico de ahorro.
        </p>
        <form id="form-perfil">
          <div>
            <label for="perfil-edad">Edad</label>
            <input type="number" id="perfil-edad" min="10" max="120" />
          </div>
          <div>
            <label for="perfil-sexo">Sexo</label>
            <select id="perfil-sexo">
              <option value="">No informar</option>
              <option value="m">Masculino</option>
              <option value="f">Femenino</option>
              <option value="o">Otro</option>
            </select>
          </div>
          <div>
            <label for="perfil-pais">Pa√≠s (para an√°lisis per c√°pita)</label>
            <select id="perfil-pais">
              <option value="">Seleccionar pa√≠s</option>
              <option value="bo">Bolivia</option>
              <option value="br">Brasil</option>
              <option value="ar">Argentina</option>
              <option value="cl">Chile</option>
              <option value="mx">M√©xico</option>
              <option value="otro">Otro pa√≠s de LATAM</option>
            </select>
          </div>
          <div>
            <label for="perfil-meta">Meta mensual de gasto</label>
            <input type="text" id="perfil-meta" placeholder="Ej: 1500" />
          </div>
          <div>
            <label for="perfil-ingreso">Ingreso mensual aproximado</label>
            <input type="text" id="perfil-ingreso" placeholder="Ej: 2500" />
          </div>
          <div>
            <label for="perfil-moneda">Moneda</label>
            <select id="perfil-moneda">
              <option value="">Autom√°tico por pa√≠s</option>
              <option value="BOB">BOB (Boliviano)</option>
              <option value="BRL">BRL (Real brasile√±o)</option>
              <option value="ARS">ARS (Peso argentino)</option>
              <option value="CLP">CLP (Peso chileno)</option>
              <option value="MXN">MXN (Peso mexicano)</option>
              <option value="USD">USD (D√≥lar americano)</option>
              <option value="EUR">EUR (Euro)</option>
            </select>
          </div>
          <div>
            <label for="perfil-objetivo-nombre">Objetivo de ahorro (nombre)</label>
            <input type="text" id="perfil-objetivo-nombre" placeholder="Ej: Computador nuevo" />
          </div>
          <div>
            <label for="perfil-objetivo-valor">Valor objetivo</label>
            <input type="text" id="perfil-objetivo-valor" placeholder="Ej: 10.000" />
          </div>
          <div>
            <button type="submit" class="primary">Guardar perfil</button>
          </div>
          <div>
            <button type="button" class="btn-icon" id="perfil-objetivo-reset">
              Reiniciar progreso del objetivo
            </button>
          </div>
        </form>
        <div id="perfil-mensaje" class="stat-small" style="margin-top:0.4rem;"></div>
        <div id="perfil-analisis" class="stat-small" style="margin-top:0.5rem;"></div>
      </div>

      <div class="card">
        <h3>Historial de objetivos de ahorro</h3>
        <div class="tabla-wrapper">
          <table id="tabla-historial-objetivos">
            <thead>
              <tr>
                <th>Objetivo</th>
                <th>Valor meta</th>
                <th>Ahorro final</th>
                <th>Fecha inicio</th>
                <th>Fecha conclusi√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>
</main>
</div>
</div>

<div id="modal-categorias" class="modal hidden">
<div class="card" style="max-width:420px; width:90%; text-align:left;">
<h3>Primeros pasos</h3>
<p class="card-subtitle">
  Como acabas de crear tu cuenta, tus categor√≠as est√°n vac√≠as.
</p>
<p style="font-size:0.85rem; margin-top:0.5rem;">
  1. En el men√∫ lateral, entra en <strong>"Categor√≠as y metas"</strong>.<br/>
  2. Crea tus propias categor√≠as (ej.: Mercado, Alquiler, Universidad, Salud...).<br/>
  3. Despu√©s, usa esas categor√≠as al registrar tus transacciones.
</p>
<button type="button" class="primary" id="modal-categorias-ok" style="margin-top:0.75rem;">
  Entendido
</button>
</div>
</div>

<!-- MODAL SIMULADOR AHORRO (NUEVO) -->
<div id="modal-simulador" class="modal hidden">
<div class="card" style="max-width:420px; width:90%;">
  <h3>üîÆ Simulador de Ahorro</h3>
  <p class="card-subtitle">"¬øQu√© pasar√≠a si corto un gasto mensual?"</p>
 
  <div style="margin-top:1rem;">
    <label style="margin-bottom:0.5rem;">Monto mensual que podr√≠as ahorrar extra:</label>
    <input type="number" id="simulador-monto" placeholder="Ej: 100 (Cenas fuera, suscripciones...)" style="margin-bottom:1rem;" />
    <div id="simulador-resultado" style="padding:1rem; background:#0f172a; border-radius:8px; margin-bottom:1rem; font-size:0.9rem; color:#94a3b8;">
      Ingresa un monto para ver el impacto en tu objetivo.
    </div>
    <div style="display:flex; gap:0.5rem; justify-content:flex-end;">
      <button type="button" class="btn-icon" id="btn-cerrar-simulador">Cerrar</button>
      <button type="button" class="primary" id="btn-calcular-simulacion">Calcular</button>
    </div>
  </div>
</div>
</div>

<script type="module">
// ===============================================================
// INTEGRACI√ìN FIREBASE
// ===============================================================

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
getAuth,
createUserWithEmailAndPassword,
signInWithEmailAndPassword,
signOut,
onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
getFirestore,
collection,
addDoc,
getDocs,
getDoc,
setDoc,
deleteDoc,
doc,
query,
where,
onSnapshot,
orderBy,
serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyC2SYOIRUVXWxRZjZXJaFX2hFID1izQks4",
authDomain: "controlefinanceiro-7f8f1.firebaseapp.com",
projectId: "controlefinanceiro-7f8f1",
storageBucket: "controlefinanceiro-7f8f1.firebasestorage.app",
messagingSenderId: "438314445354",
appId: "1:438314445354:web:e4551a6f467b20e9cfb153"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- UTILIT√ÅRIOS VISUAIS ---
function loading(show) {
const el = document.getElementById('loading-overlay');
if (el) {
  if (show) el.classList.remove('hidden');
  else el.classList.add('hidden');
}
}

function monedaPorDefectoParaPais(pais) {
switch (pais) {
  case "bo": return "BOB";
  case "br": return "BRL";
  case "ar": return "ARS";
  case "cl": return "CLP";
  case "mx": return "MXN";
  case "otro": return "USD";
  default: return "USD";
}
}

function parseNumeroLocal(str) {
if (str === null || str === undefined) return 0;
if (typeof str !== "string") str = String(str);
str = str.trim();
if (!str) return 0;
str = str.replace(/\./g, "");
str = str.replace(",", ".");
const n = parseFloat(str);
return isNaN(n) ? 0 : n;
}

let monedaUsuario = "USD";

function formatearMoneda(valor) {
const currency = monedaUsuario || "USD";
let locale = "en-US";
switch (currency) {
  case "BRL": locale = "pt-BR"; break;
  case "BOB": locale = "es-BO"; break;
  case "ARS": locale = "es-AR"; break;
  case "CLP": locale = "es-CL"; break;
  case "MXN": locale = "es-MX"; break;
  case "EUR": locale = "es-ES"; break;
  default:    locale = "en-US";
}
try {
  return valor.toLocaleString(locale, { style: "currency", currency });
} catch (e) {
  return valor.toFixed(2);
}
}

function obtenerAnioMesActual() {
return new Date().toISOString().slice(0, 7);
}

function filtrarMesActual(lista, campoFecha) {
const anioMesActual = obtenerAnioMesActual();
return lista.filter(item => item[campoFecha] && item[campoFecha].startsWith(anioMesActual));
}

function nombreMes(anioMes) {
if (!anioMes) return "";
const [anio, mes] = anioMes.split("-");
const fecha = new Date(parseInt(anio), parseInt(mes) - 1, 1);
return fecha.toLocaleDateString("es-ES", { month: "long", year: "numeric" });
}

function siguienteAnioMes(anioMes) {
if (!anioMes) return anioMes;
const [anioStr, mesStr] = anioMes.split("-");
let anio = parseInt(anioStr, 10);
let mes = parseInt(mesStr, 10);
mes += 1;
if (mes === 13) { mes = 1; anio += 1; }
return anio.toString().padStart(4, "0") + "-" + mes.toString().padStart(2, "0");
}

// --- ESTADO GLOBAL ---
let usuarioActual = null;
let categoriasLocal = [];
let transaccionesLocal = [];
let fijosLocal = [];
let tarjetasLocal = [];

// Variaveis Perfil
let metaMensualUsuario = 0;
let ingresoMensualUsuario = 0;
let edadUsuario = null;
let sexoUsuario = "";
let paisUsuario = "";
let yaMostroModalCategorias = false;
let objetivoNombre = "";
let objetivoValor = 0;
let objetivoAhorroBase = 0;
let objetivoFechaInicio = null;
let objetivoCompletado = false;
let objetivosHistorial = [];

// Listeners de Firebase (para cancelar subscri√ß√£o ao sair)
let unsubs = [];

// ----------------------------------------------------------------------
// AUTENTICACI√ìN (onAuthStateChanged)
// ----------------------------------------------------------------------
onAuthStateChanged(auth, (user) => {
  if (user) {
      // LOGIN EXITOSO
      usuarioActual = user;
      document.getElementById("user-email").textContent = user.email;
      document.getElementById("login-screen").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
   
      // Carregar Dados (Listeners em tempo real)
      iniciarListeners(user.uid);
  } else {
      // LOGOUT
      usuarioActual = null;
   
      // Limpar dados locais
      categoriasLocal = []; transaccionesLocal = []; fijosLocal = []; tarjetasLocal = [];
   
      // Cancelar listeners
      unsubs.forEach(u => u());
      unsubs = [];
   
      document.getElementById("app").classList.add("hidden");
      document.getElementById("login-screen").classList.remove("hidden");
  }
});

// ----------------------------------------------------------------------
// CARGA DE DATOS (FIRESTORE REALTIME)
// ----------------------------------------------------------------------
function iniciarListeners(uid) {
  loading(true);

  // 1. Categorias
  const qCat = query(collection(db, "categorias"), where("uid", "==", uid));
  const unsubCat = onSnapshot(qCat, (snapshot) => {
      categoriasLocal = [];
      snapshot.forEach(doc => {
          categoriasLocal.push({ id: doc.id, ...doc.data() });
      });
      // Quando carrega categorias, atualiza a UI dependente
      inicializarInterfaz();
      mostrarModalCategoriasSiCorresponde();
  });
  unsubs.push(unsubCat);

  // 2. Transacciones
  const qTrans = query(collection(db, "transacciones"), where("uid", "==", uid));
  const unsubTrans = onSnapshot(qTrans, (snapshot) => {
      transaccionesLocal = [];
      snapshot.forEach(doc => {
          transaccionesLocal.push({ id: doc.id, ...doc.data() });
      });
      inicializarInterfaz();
  });
  unsubs.push(unsubTrans);

  // 3. Gastos Fijos
  const qFijos = query(collection(db, "gastos_fijos"), where("uid", "==", uid));
  const unsubFijos = onSnapshot(qFijos, (snapshot) => {
      fijosLocal = [];
      snapshot.forEach(doc => {
          fijosLocal.push({ id: doc.id, ...doc.data() });
      });
      inicializarInterfaz();
  });
  unsubs.push(unsubFijos);

  // 4. Tarjetas
  const qTarj = query(collection(db, "tarjetas"), where("uid", "==", uid));
  const unsubTarj = onSnapshot(qTarj, (snapshot) => {
      tarjetasLocal = [];
      snapshot.forEach(doc => {
          tarjetasLocal.push({ id: doc.id, ...doc.data() });
      });
      inicializarInterfaz();
  });
  unsubs.push(unsubTarj);

  // 5. Perfil (Documento √önico)
  const docRef = doc(db, "perfil", uid);
  const unsubPerfil = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
          const p = docSnap.data();
          edadUsuario = p.edad;
          sexoUsuario = p.sexo;
          paisUsuario = p.pais;
          monedaUsuario = p.moneda;
          metaMensualUsuario = p.meta_mensual || 0;
          ingresoMensualUsuario = p.ingreso_mensual || 0;
          objetivoNombre = p.objetivo_nombre;
          objetivoValor = p.objetivo_valor || 0;
          objetivoAhorroBase = p.objetivo_ahorro_base || 0;
          objetivoFechaInicio = p.objetivo_fecha_inicio;
          objetivoCompletado = p.objetivo_completado;
          yaMostroModalCategorias = p.mostro_modal_categorias;
          objetivosHistorial = p.objetivos_historial || [];
       
          // Se moeda n√£o definida, tenta deduzir
          if(!monedaUsuario && paisUsuario) {
               monedaUsuario = monedaPorDefectoParaPais(paisUsuario);
          }
      } else {
          // Se n√£o existe perfil, cria vazio na mem√≥ria
          yaMostroModalCategorias = false;
      }
      inicializarInterfaz();
      loading(false); // Fim do carregamento inicial
  });
  unsubs.push(unsubPerfil);
}

// ----------------------------------------------------------------------
// L√ìGICA DE LOGIN E REGISTRO UI
// ----------------------------------------------------------------------
const loginForm = document.getElementById("login-form");
const loginEmail = document.getElementById("login-email");
const loginPassword = document.getElementById("login-password");
const loginSubmit = document.getElementById("login-submit");
const toggleModeBtn = document.getElementById("toggle-mode");
const toggleText = document.getElementById("toggle-text");
const loginMessage = document.getElementById("login-message");
const registerExtra = document.getElementById("register-extra");

let modoRegistro = false;

toggleModeBtn.addEventListener("click", () => {
modoRegistro = !modoRegistro;
if (modoRegistro) {
  loginSubmit.textContent = "Crear cuenta";
  toggleText.textContent = "¬øYa tienes cuenta?";
  toggleModeBtn.textContent = "Entrar";
  registerExtra.classList.remove("hidden");
} else {
  loginSubmit.textContent = "Entrar";
  toggleText.textContent = "¬øNo tienes cuenta?";
  toggleModeBtn.textContent = "Crear cuenta";
  registerExtra.classList.add("hidden");
}
loginMessage.textContent = "";
});

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = loginEmail.value;
  const pass = loginPassword.value;

  loginMessage.style.color = "#f97316";
  loginMessage.textContent = "Procesando...";

  try {
      if (modoRegistro) {
          await createUserWithEmailAndPassword(auth, email, pass);
          // Perfil ser√° criado vazio automaticamente na l√≥gica
      } else {
          await signInWithEmailAndPassword(auth, email, pass);
      }
  } catch (error) {
      console.error(error);
      let msg = error.message;
      if(error.code === 'auth/invalid-credential') msg = "Credenciales incorrectas.";
      if(error.code === 'auth/email-already-in-use') msg = "Email ya registrado.";
      if(error.code === 'auth/weak-password') msg = "Contrase√±a muy d√©bil.";
      loginMessage.textContent = msg;
  }
});

document.getElementById("logout-btn").addEventListener("click", () => {
  signOut(auth);
});

// ----------------------------------------------------------------------
// SALVAR DADOS (ESCRITA FIRESTORE)
// ----------------------------------------------------------------------

// Salvar Perfil (Debounced ou direto)
async function guardarPerfilEnServidor() {
  if (!usuarioActual) return;
  try {
      const dados = {
          uid: usuarioActual.uid,
          edad: edadUsuario,
          sexo: sexoUsuario,
          pais: paisUsuario,
          moneda: monedaUsuario,
          meta_mensual: metaMensualUsuario,
          ingreso_mensual: ingresoMensualUsuario,
          objetivo_nombre: objetivoNombre,
          objetivo_valor: objetivoValor,
          objetivo_ahorro_base: objetivoAhorroBase,
          objetivo_fecha_inicio: objetivoFechaInicio,
          objetivo_completado: objetivoCompletado,
          mostro_modal_categorias: yaMostroModalCategorias,
          objetivos_historial: objetivosHistorial
      };
      // setDoc com merge para atualizar ou criar
      await setDoc(doc(db, "perfil", usuarioActual.uid), dados, { merge: true });
   
      const pm = document.getElementById("perfil-mensaje");
      if(pm) { pm.textContent = "Guardado."; setTimeout(()=>pm.textContent="", 1500); }
  } catch (e) { console.error("Error al guardar perfil", e); }
}

// Categorias
const formCategoria = document.getElementById("form-categoria");
formCategoria.addEventListener("submit", async (e) => {
  e.preventDefault();
  const nome = document.getElementById("cat-nome").value.trim();
  const grupo = document.getElementById("cat-grupo").value;
  if(!nome) return;

  loading(true);
  try {
      await addDoc(collection(db, "categorias"), {
          uid: usuarioActual.uid,
          nome,
          grupo,
          createdAt: serverTimestamp()
      });
      document.getElementById("cat-nome").value = "";
  } catch(e){ console.error(e); alert("Error"); }
  loading(false);
});
window.eliminarCategoria = async (id) => {
  if(!confirm("¬øEliminar?")) return;
  await deleteDoc(doc(db, "categorias", id));
};

// Gastos Fijos
const formFijo = document.getElementById("form-fijo");
formFijo.addEventListener("submit", async (e) => {
  e.preventDefault();
  const d=document.getElementById("fijo-descripcion").value.trim();
  const v=parseNumeroLocal(document.getElementById("fijo-valor").value);
  const ven=parseInt(document.getElementById("fijo-vencimiento").value);

  loading(true);
  try {
      await addDoc(collection(db, "gastos_fijos"), {
          uid: usuarioActual.uid,
          descripcion: d,
          valor: v,
          vencimiento: ven,
          mes_inicio: siguienteAnioMes(obtenerAnioMesActual())
      });
      formFijo.reset();
  } catch(e){ console.error(e); }
  loading(false);
});
window.eliminarFijo = async (id) => await deleteDoc(doc(db, "gastos_fijos", id));

// Tarjetas
const formTarjeta = document.getElementById("form-tarjeta");
formTarjeta.addEventListener("submit", async (e) => {
  e.preventDefault();
  const a=document.getElementById("tarjeta-alias").value;
  const d=document.getElementById("tarjeta-digitos").value;
  const b=document.getElementById("tarjeta-banco").value;

  loading(true);
  try {
      await addDoc(collection(db, "tarjetas"), {
          uid: usuarioActual.uid,
          alias: a, digitos: d, banco: b
      });
      formTarjeta.reset();
  } catch(e){ console.error(e); }
  loading(false);
});
window.eliminarTarjeta = async (id) => await deleteDoc(doc(db, "tarjetas", id));

// Transa√ß√µes
const formTransaccion = document.getElementById("form-transaccion");
formTransaccion.addEventListener("submit", async (e) => {
  e.preventDefault();
  const tipo = document.getElementById("tipo").value;
  const catVal = document.getElementById("categoria").value;
  const orig = document.getElementById("origen").value;
  const val = parseNumeroLocal(document.getElementById("valor").value);
  const fecha = document.getElementById("data").value;
  const desc = document.getElementById("descripcion").value.trim();

  let gfId = null;
  if(tipo==="salida" && catVal==="__gasto_fijo__"){
      gfId = document.getElementById("gasto-fijo-select").value;
      if(!gfId) { alert("Seleccione gasto fijo"); return; }
  }
  let tId = null, origFinal = null;
  if(tipo==="salida"){
      if(orig==="tarjeta"){
          tId = document.getElementById("tarjeta-select").value;
          if(!tId) { alert("Seleccione tarjeta"); return; }
          origFinal="tarjeta";
      } else origFinal="efectivo"; // CAMBIO: NORMAL A EFECTIVO
  }

  const catIdDB = (catVal === "__gasto_fijo__") ? null : catVal;

  loading(true);
  try {
      await addDoc(collection(db, "transacciones"), {
          uid: usuarioActual.uid,
          tipo: tipo,
          categoriaId: catIdDB,
          gastoFijoId: gfId,
          tarjetaId: tId,
          origen: origFinal,
          valor: val,
          fecha: fecha,
          descripcion: desc,
          createdAt: serverTimestamp()
      });
      document.getElementById("valor").value="";
      document.getElementById("descripcion").value="";
      actualizarObjetivo(); // Recalcula localmente e salva se bater meta
  } catch(e){ console.error(e); alert("Error"); }
  loading(false);
});
window.eliminarTransaccion = async (id) => await deleteDoc(doc(db, "transacciones", id));


// ----------------------------------------------------------------------
// L√ìGICA DE INTERFACE
// ----------------------------------------------------------------------

// UI Helpers para preencher tabelas
window.eliminarCategoria = eliminarCategoria; // Tornar global para o HTML onclick
window.eliminarFijo = eliminarFijo;
window.eliminarTarjeta = eliminarTarjeta;
window.eliminarTransaccion = eliminarTransaccion;

const modalCategorias = document.getElementById("modal-categorias");
const modalCategoriasOk = document.getElementById("modal-categorias-ok");
modalCategoriasOk.addEventListener("click", async () => {
modalCategorias.classList.add("hidden");
yaMostroModalCategorias = true;
await guardarPerfilEnServidor();
});

function mostrarModalCategoriasSiCorresponde() {
if (categoriasLocal.length === 0 && !yaMostroModalCategorias) {
  modalCategorias.classList.remove("hidden");
} else {
  modalCategorias.classList.add("hidden");
}
}

function inicializarInterfaz() {
  rellenarSelectCategorias();
  rellenarTablaCategorias();
  rellenarTablaFijos();
  rellenarTablaTarjetas();
  rellenarTablaTransacciones();
  rellenarPerfil();
  rellenarHistorialObjetivos();
  actualizarResumen(); // INCLUYE SEMAFORO Y DISTRIBUCI√ìN ESPEC√çFICA
  analisisLatam();
  actualizarObjetivo(); // INCLUYE PROYECCION Y NUMEROS EN PIZZA
  dibujarGraficoViajeroTiempo(); // NUEVO
  actualizarCampoGastoFijo();
  actualizarCampoOrigenYTarjeta();
  inicializarReporte();
}

// UI Listeners
const sidebar = document.getElementById("sidebar");
const menuToggle = document.getElementById("menu-toggle");
menuToggle.addEventListener("click", () => sidebar.classList.toggle("open"));
sidebar.addEventListener("click", (e) => {
if (e.target.tagName !== "BUTTON") return;
const seccion = e.target.getAttribute("data-section");
if (!seccion) return;
sidebar.querySelectorAll("button").forEach(btn => btn.classList.remove("active"));
e.target.classList.add("active");
document.querySelectorAll("main section").forEach(sec => sec.classList.add("hidden"));
document.getElementById("section-" + seccion).classList.remove("hidden");
sidebar.classList.remove("open");
});

document.getElementById("tipo").addEventListener("change", ()=>{rellenarSelectCategorias();actualizarCampoGastoFijo();actualizarCampoOrigenYTarjeta();});
document.getElementById("categoria").addEventListener("change", actualizarCampoGastoFijo);
document.getElementById("origen").addEventListener("change", actualizarCampoOrigenYTarjeta);
document.getElementById("filtro-texto").addEventListener("input", rellenarTablaTransacciones);
document.getElementById("filtro-fecha").addEventListener("change", rellenarTablaTransacciones);
document.getElementById("btn-limpiar-filtros").addEventListener("click", ()=>{document.getElementById("filtro-texto").value="";document.getElementById("filtro-fecha").value="";rellenarTablaTransacciones();});

// Salvar perfil ao submit do form
document.getElementById("form-perfil").addEventListener("submit", async (e) => {
  e.preventDefault();
  edadUsuario = parseInt(document.getElementById("perfil-edad").value);
  sexoUsuario = document.getElementById("perfil-sexo").value;
  paisUsuario = document.getElementById("perfil-pais").value;
  metaMensualUsuario = parseNumeroLocal(document.getElementById("perfil-meta").value);
  ingresoMensualUsuario = parseNumeroLocal(document.getElementById("perfil-ingreso").value);
  monedaUsuario = document.getElementById("perfil-moneda").value;
  objetivoNombre = document.getElementById("perfil-objetivo-nombre").value;

  // L√≥gica de resetar objetivo se mudar valor
  const novoValor = parseNumeroLocal(document.getElementById("perfil-objetivo-valor").value);
  if (novoValor !== objetivoValor && novoValor > 0) {
      // Novo objetivo
      objetivoValor = novoValor;
      objetivoAhorroBase = calcularAhorroTotal();
      objetivoFechaInicio = new Date().toISOString().slice(0,10);
      objetivoCompletado = false;
  } else {
      objetivoValor = novoValor;
  }

  await guardarPerfilEnServidor();
  inicializarInterfaz();
});

document.getElementById("perfil-objetivo-reset").addEventListener("click", async () => {
  if(!confirm("¬øReiniciar progreso?")) return;
  objetivoAhorroBase = calcularAhorroTotal();
  objetivoFechaInicio = new Date().toISOString().slice(0,10);
  objetivoCompletado = false;
  await guardarPerfilEnServidor();
  inicializarInterfaz();
});

// --- LOGICA DEL SIMULADOR DE AHORRO ---
const modalSim = document.getElementById("modal-simulador");
document.getElementById("btn-abrir-simulador").addEventListener("click", () => modalSim.classList.remove("hidden"));
document.getElementById("btn-cerrar-simulador").addEventListener("click", () => modalSim.classList.add("hidden"));

document.getElementById("btn-calcular-simulacion").addEventListener("click", () => {
  const extra = parseNumeroLocal(document.getElementById("simulador-monto").value);
  const res = document.getElementById("simulador-resultado");
 
  if(extra <= 0) { res.textContent = "Ingresa un monto v√°lido."; return; }
 
  // Recalcular estado actual
  let totE=0, totS=0;
  transaccionesLocal.forEach(t => { if(t.tipo==="entrada") totE+=t.valor; else totS+=t.valor; });
  const ahorroTotal = Math.max(0, totE - totS);
  let actual = ahorroTotal - objetivoAhorroBase;
  if(actual<0) actual=0;
  const restante = objetivoValor - actual;
 
  if(restante <= 0) { res.textContent = "¬°Ya cumpliste tu objetivo!"; return; }

  // Ritmo actual del mes
  const mes = obtenerAnioMesActual();
  const transMes = transaccionesLocal.filter(t => t.fecha && t.fecha.startsWith(mes));
  let eM=0, sM=0;
  transMes.forEach(t => { if(t.tipo==="entrada") eM+=t.valor; else sM+=t.valor; });
  const flujoMes = Math.max(0, eM - sM);
  const dia = new Date().getDate();
  const ritmoBase = (flujoMes/dia)*30; // Ahorro/mes estimado
 
  // Escenarios
  const tiempoActual = ritmoBase > 0 ? (restante / ritmoBase) : 9999;
  const nuevoRitmo = ritmoBase + extra;
  const tiempoNuevo = restante / nuevoRitmo;
 
  // D√≠as
  const diasAntes = Math.ceil(tiempoActual * 30);
  const diasDespues = Math.ceil(tiempoNuevo * 30);
  const ganancia = diasAntes - diasDespues;
 
  if(ritmoBase <= 0) {
      res.textContent = `Actualmente no ahorras. Con este corte, terminar√≠as en ${diasDespues} d√≠as.`;
      res.style.color = "#22c55e";
  } else {
      res.innerHTML = `Ahorrar√≠as <strong style="color:#fff">${diasDespues} d√≠as</strong> en total.<br>¬°Terminar√≠as <strong style="color:#22c55e">${ganancia} d√≠as antes</strong> que ahora!`;
      res.style.color = "#94a3b8";
  }
});

// --- LOGICA DEL GR√ÅFICO VIAJERO EN EL TIEMPO ---
function dibujarGraficoViajeroTiempo() {
  const canvas = document.getElementById("chart-time-travel");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const w = canvas.width; const h = canvas.height;
 
  ctx.clearRect(0,0,w,h);
 
  const hoy = new Date();
  const meses = [];
  // Hist√≥rico de 3 meses atr√°s + 6 futuros
  for(let i=-2; i<=6; i++) {
      const d = new Date(hoy.getFullYear(), hoy.getMonth() + i, 1);
      meses.push({
          label: d.toLocaleDateString("es-ES",{month:'short'}),
          dateStr: d.toISOString().slice(0,7),
          isFuture: i > 0
      });
  }
 
  let saldoAcumulado = 0;
  const primerMesMostrado = meses[0].dateStr;
  transaccionesLocal.forEach(t => {
      if(t.fecha < primerMesMostrado + "-01") {
          if(t.tipo==="entrada") saldoAcumulado += t.valor; else saldoAcumulado -= t.valor;
      }
  });
 
  const puntos = [];
  let tendenciaAhorro = 0;
  let mesesConDatos = 0;

  meses.forEach(m => {
      if(!m.isFuture) {
          const trans = transaccionesLocal.filter(t => t.fecha && t.fecha.startsWith(m.dateStr));
          let e=0, s=0;
          trans.forEach(t => { if(t.tipo==="entrada") e+=t.valor; else s+=t.valor; });
          saldoAcumulado += (e-s);
          puntos.push({ val: saldoAcumulado, future: false, label: m.label });
          tendenciaAhorro += (e-s);
          mesesConDatos++;
      } else {
          const promedio = mesesConDatos > 0 ? (tendenciaAhorro / mesesConDatos) : 0;
          saldoAcumulado += promedio;
          puntos.push({ val: saldoAcumulado, future: true, label: m.label });
      }
  });

  const maxVal = Math.max(...puntos.map(p=>p.val)) * 1.1;
  const minVal = Math.min(0, ...puntos.map(p=>p.val));
  const range = maxVal - minVal || 100;
 
  const getX = (i) => 40 + (i * ((w-60) / (puntos.length-1)));
  const getY = (v) => h - 30 - ((v - minVal) / range) * (h - 60);

  // Ejes
  ctx.strokeStyle = "#334155"; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(40, 20); ctx.lineTo(40, h-30); ctx.lineTo(w-20, h-30); ctx.stroke();
 
  // L√≠nea
  ctx.lineWidth = 3;
  for(let i=0; i<puntos.length-1; i++) {
      const p1 = puntos[i]; const p2 = puntos[i+1];
      ctx.beginPath();
      ctx.moveTo(getX(i), getY(p1.val));
      ctx.lineTo(getX(i+1), getY(p2.val));
     
      if(p2.future) {
          ctx.setLineDash([5, 5]);
          ctx.strokeStyle = "#38bdf8";
      } else {
          ctx.setLineDash([]);
          ctx.strokeStyle = "#22c55e";
      }
      ctx.stroke();
  }
  ctx.setLineDash([]);

  // Puntos
  puntos.forEach((p, i) => {
      const x = getX(i); const y = getY(p.val);
      ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI*2);
      ctx.fillStyle = p.future ? "#38bdf8" : "#22c55e";
      ctx.fill();
     
      ctx.fillStyle = "#94a3b8"; ctx.font = "10px sans-serif"; ctx.textAlign = "center";
      ctx.fillText(p.label, x, h-10);
     
      if(i === puntos.length-1 || i === 2) {
         ctx.fillStyle = "#e2e8f0";
         ctx.fillText(formatearMoneda(p.val), x, y - 10);
      }
  });
}

// --- FUN√á√ïES AUXILIARES DE UI (TABELAS E SELECTS) ---
function rellenarSelectCategorias() {
const sel = document.getElementById("categoria");
sel.innerHTML = "";
const tipo = document.getElementById("tipo").value;
if (tipo === "salida" && fijosLocal.length > 0) {
  const opt = document.createElement("option"); opt.value = "__gasto_fijo__"; opt.textContent = "Gastos fijos"; sel.appendChild(opt);
}
categoriasLocal.forEach(c => {
   if(c.grupo !== tipo) return;
   const opt = document.createElement("option"); opt.value = c.id; opt.textContent = c.nome; sel.appendChild(opt);
});
}

function rellenarTablaCategorias() {
  const tb = document.querySelector("#tabla-categorias tbody"); tb.innerHTML="";
  categoriasLocal.forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${c.nome}</td><td>${c.grupo === "entrada" ? "Entrada" : "Salida"}</td><td></td>`;
      const btn = document.createElement("button"); btn.className="btn-icon btn-icon-danger"; btn.textContent="Eliminar"; btn.onclick = () => window.eliminarCategoria(c.id);
      tr.lastElementChild.appendChild(btn);
      tb.appendChild(tr);
  });
}

function rellenarSelectGastosFijos() {
  const s = document.getElementById("gasto-fijo-select"); s.innerHTML="";
  fijosLocal.forEach(f => {
      const o = document.createElement("option"); o.value=f.id; o.textContent=`${f.descripcion} (${formatearMoneda(f.valor)})`; s.appendChild(o);
  });
}

function rellenarTablaFijos() {
  const tb = document.querySelector("#tabla-fijos tbody"); tb.innerHTML="";
  const mes = obtenerAnioMesActual();
  fijosLocal.forEach(f => {
      const estado = estadoFijoParaMes(f, mes);
      const tr = document.createElement("tr");
      if (estado.claseFila) tr.classList.add(estado.claseFila);
      tr.innerHTML = `<td>${f.descripcion}</td><td>${formatearMoneda(f.valor)}</td><td>D√≠a ${f.vencimiento}</td>
                      <td><span class="badge-estado ${estado.badgeClase}">${estado.texto}</span></td><td></td>`;
      const btn = document.createElement("button"); btn.className="btn-icon btn-icon-danger"; btn.textContent="Eliminar"; btn.onclick=()=>window.eliminarFijo(f.id);
      tr.lastElementChild.appendChild(btn);
      tb.appendChild(tr);
  });
  rellenarSelectGastosFijos();
}

function estadoFijoParaMes(fijo, anioMesActual) {
const hoy = new Date();
const diaHoy = hoy.getDate();
const venc = fijo.vencimiento;
const mesInicio = fijo.mes_inicio || obtenerAnioMesActual(); // Adapta√ß√£o: Firebase usa camelCase ou snake_case conforme salvo

if (anioMesActual < mesInicio) {
  return { claseFila: "", badgeClase: "badge-normal", texto: "A√∫n no aplica este mes", restante: fijo.valor, totalPagado: 0 };
}

const transMes = filtrarMesActual(transaccionesLocal, "fecha");
let totalPagado = 0;
transMes.forEach(t => {
  if (t.tipo === "salida" && t.gastoFijoId === fijo.id) {
    totalPagado += t.valor;
  }
});
const restante = Math.max(0, fijo.valor - totalPagado);
const pagoCompleto = totalPagado >= (fijo.valor - 0.01);

if (pagoCompleto) {
  return { claseFila: "fijo-verde", badgeClase: "badge-verde", texto: "Pagado completamente este mes", restante: 0, totalPagado };
}
const faltanteTexto = restante > 0 ? `Falta ${formatearMoneda(restante)}` : "";
if (totalPagado > 0 && !pagoCompleto) {
  if (diaHoy >= venc) return { claseFila: "fijo-rojo", badgeClase: "badge-rojo", texto: `Pago parcial. ${faltanteTexto}`, restante, totalPagado };
  else if (diaHoy >= venc - 7) return { claseFila: "fijo-amarillo", badgeClase: "badge-amarillo", texto: `Pago parcial. ${faltanteTexto}`, restante, totalPagado };
  else return { claseFila: "", badgeClase: "badge-normal", texto: `Pago parcial. ${faltanteTexto}`, restante, totalPagado };
}
if (diaHoy < venc - 7) return { claseFila: "", badgeClase: "badge-normal", texto: "Pendiente", restante, totalPagado };
else if (diaHoy >= venc - 7 && diaHoy < venc) return { claseFila: "fijo-amarillo", badgeClase: "badge-amarillo", texto: "Cerca del vencimiento", restante, totalPagado };
else return { claseFila: "fijo-rojo", badgeClase: "badge-rojo", texto: "Vencido", restante, totalPagado };
}

function rellenarSelectTarjetas() {
  const s = document.getElementById("tarjeta-select"); s.innerHTML="";
  tarjetasLocal.forEach(t => {
      const o = document.createElement("option"); o.value=t.id; o.textContent=`${t.alias||""} ${t.digitos||""}`; s.appendChild(o);
  });
}
function rellenarTablaTarjetas() {
  const tb = document.querySelector("#tabla-tarjetas tbody"); tb.innerHTML="";
  tarjetasLocal.forEach(t => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${t.alias || ""}</td><td>${t.digitos || ""}</td><td>${t.banco || ""}</td><td></td>`;
      const btn = document.createElement("button"); btn.className="btn-icon btn-icon-danger"; btn.textContent="Eliminar"; btn.onclick=()=>window.eliminarTarjeta(t.id);
      tr.lastElementChild.appendChild(btn);
      tb.appendChild(tr);
  });
  rellenarSelectTarjetas();
}

function rellenarTablaTransacciones() {
  const tb = document.querySelector("#tabla-transacciones tbody"); tb.innerHTML="";
  const mes = obtenerAnioMesActual();
  // Filtrar localmente (j√° que pegamos tudo do user)
  let l = transaccionesLocal.filter(t=>t.fecha && t.fecha.startsWith(mes));
  const ft = document.getElementById("filtro-texto").value.toLowerCase();
  const ff = document.getElementById("filtro-fecha").value;
  if(ft) l = l.filter(t=>(t.descripcion||"").toLowerCase().includes(ft));
  if(ff) l = l.filter(t=>t.fecha===ff);
  l.sort((a,b) => a.fecha<b.fecha?1:-1);

  l.forEach(t => {
      const tr = document.createElement("tr");
      let catNombre = "-";
      if (t.categoriaId === null && t.gastoFijoId) {
         const f = fijosLocal.find(x => x.id === t.gastoFijoId);
         catNombre = "Gasto fijo - " + (f ? f.descripcion : "");
      } else {
         const c = categoriasLocal.find(x => x.id === t.categoriaId);
         catNombre = c ? c.nome : "-";
      }
      let origenTexto = "-";
      if (t.tipo === "salida") {
          if(t.origen === "tarjeta" && t.tarjetaId) {
             const tar = tarjetasLocal.find(x => x.id === t.tarjetaId);
             origenTexto = "Tarjeta - " + (tar ? `${tar.alias} (${tar.digitos})` : "");
          } else origenTexto = "Efectivo"; // CAMBIADO A EFECTIVO
      }

      tr.innerHTML = `<td>${t.fecha}</td><td><span class="tag ${t.tipo}">${t.tipo}</span></td><td>${catNombre}</td><td>${origenTexto}</td><td>${t.descripcion||""}</td><td>${formatearMoneda(t.valor)}</td><td></td>`;
      const btn = document.createElement("button"); btn.className="btn-icon btn-icon-danger"; btn.textContent="Eliminar"; btn.onclick=()=>window.eliminarTransaccion(t.id);
      tr.lastElementChild.appendChild(btn);
      tb.appendChild(tr);
  });
}

function actualizarResumen() {
const transMes = filtrarMesActual(transaccionesLocal, "fecha");
let totalEntradas = 0;
let totalSalidas = 0;
let totalSalidasFijos = 0;
let totalSalidasOtros = 0;

transMes.forEach(t => {
  if (t.tipo === "entrada") {
    totalEntradas += t.valor;
  } else if (t.tipo === "salida") {
    totalSalidas += t.valor;
    if (t.gastoFijoId) totalSalidasFijos += t.valor;
    else totalSalidasOtros += t.valor;
  }
});

const saldo = totalEntradas - totalSalidas;

document.getElementById("stat-entradas").textContent = formatearMoneda(totalEntradas);
document.getElementById("stat-salidas").textContent = formatearMoneda(totalSalidas);
document.getElementById("stat-saldo").textContent = formatearMoneda(saldo);

const saldoTexto = document.getElementById("stat-saldo-texto");
if (saldo > 0) saldoTexto.textContent = "Est√°s con saldo positivo este mes.";
else if (saldo < 0) saldoTexto.textContent = "Est√°s gastando m√°s de lo que entra este mes.";
else saldoTexto.textContent = "Saldo neutro por ahora.";

// --- L√ìGICA NUEVA: DISTRIBUCI√ìN ESPEC√çFICA ---
const contenedorDist = document.getElementById("contenedor-distribucion");
contenedorDist.innerHTML = ""; // Limpiar

// Agrupar gastos por categor√≠a
let gastosPorCat = {};
let totalGastado = 0;

transMes.forEach(t => {
    if(t.tipo === "salida") {
        let nombreCat = "Sin categor√≠a";
        if(t.gastoFijoId) {
            nombreCat = "Gastos Fijos"; // Opcional: Podr√≠as buscar el nombre espec√≠fico del gasto fijo
        } else if(t.categoriaId) {
            const c = categoriasLocal.find(cat => cat.id === t.categoriaId);
            if(c) nombreCat = c.nome;
        }
       
        if(!gastosPorCat[nombreCat]) gastosPorCat[nombreCat] = 0;
        gastosPorCat[nombreCat] += t.valor;
        totalGastado += t.valor;
    }
});

if(totalGastado === 0) {
   contenedorDist.innerHTML = '<div style="text-align:center; color:#64748b; font-size:0.9rem; padding:1rem;">No hay salidas este mes.</div>';
} else {
   // Ordenar de mayor a menor
   const ordenados = Object.keys(gastosPorCat).sort((a,b) => gastosPorCat[b] - gastosPorCat[a]);
   
   ordenados.forEach(cat => {
       const valor = gastosPorCat[cat];
       const porcentaje = (valor / totalGastado) * 100;
       
       // Crear elementos HTML din√°micos
       const row = document.createElement("div");
       row.className = "dist-row";
       row.innerHTML = `
           <span style="width:100px; color:#cbd5e1;">${cat}</span>
           <div class="dist-bar-bg">
               <div class="dist-bar-fill" style="width:${porcentaje}%; background:${getColorParaCategoria(cat)}"></div>
           </div>
           <span style="width:60px; text-align:right; color:#fff;">${Math.round(porcentaje)}%</span>
       `;
       contenedorDist.appendChild(row);
   });
}

// SEMAFORO DE GASTOS
const lblMeta = document.getElementById("stat-meta-uso");
const lblIngreso = document.getElementById("stat-ingreso-alerta");

if(metaMensualUsuario > 0) {
    const uso = (totalSalidas/metaMensualUsuario)*100;
    const restanteMeta = Math.max(0, metaMensualUsuario - totalSalidas);
   
    // Pasa el texto del restante al gr√°fico
    dibujarGraficoMeta(uso, formatearMoneda(restanteMeta));
   
    lblMeta.textContent = `Meta: ${formatearMoneda(metaMensualUsuario)}`;
   
    // Logica Semaforo
    lblMeta.className = "stat-small"; // Reset
    if(uso < 50) lblMeta.classList.add("semaforo-verde");
    else if(uso >= 50 && uso < 80) lblMeta.classList.add("semaforo-amarillo");
    else {
        lblMeta.classList.add("semaforo-rojo");
        // Vibracion en movil
        if("vibrate" in navigator && uso >= 80) navigator.vibrate(200);
    }
} else {
    dibujarGraficoMeta(0, "");
    lblMeta.textContent = "Define una meta mensual en Perfil.";
    lblMeta.className = "stat-small";
}

if (ingresoMensualUsuario > 0) {
  const ratio = (totalSalidas / ingresoMensualUsuario) * 100;
  lblIngreso.textContent = `Tus salidas son ${ratio.toFixed(1)}% de tu ingreso.`;
} else {
  lblIngreso.textContent = "";
}
}

// Helper para colores aleatorios consistentes
function getColorParaCategoria(nombre) {
   let hash = 0;
   for (let i = 0; i < nombre.length; i++) {
       hash = nombre.charCodeAt(i) + ((hash << 5) - hash);
   }
   const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
   return "#" + "00000".substring(0, 6 - c.length) + c;
}

function actualizarObjetivo() {
  const elProyeccion = document.getElementById("obj-proyeccion");
  elProyeccion.textContent = "";

  if(!objetivoNombre || !objetivoValor || objetivoValor <= 0) {
    document.getElementById("obj-nombre").textContent = "Sin objetivo definido";
    document.getElementById("obj-meta").textContent = "-";
    document.getElementById("obj-ahorrado").textContent = formatearMoneda(0);
    document.getElementById("obj-restante").textContent = formatearMoneda(0);
    document.getElementById("obj-texto").textContent = "Define un objetivo en Perfil.";
    dibujarGraficoObjetivo(0, "");
    rellenarHistorialObjetivos();
    return;
  }

  const ahorroTotal = calcularAhorroTotal();
  let ahorroObjetivo = ahorroTotal - objetivoAhorroBase;
  if (ahorroObjetivo < 0) ahorroObjetivo = 0;

  if (!objetivoCompletado && ahorroObjetivo >= objetivoValor) {
     objetivoCompletado = true;
     const hoy = new Date().toISOString().slice(0,10);
     objetivosHistorial.push({ nombre: objetivoNombre, valorMeta: objetivoValor, ahorroFinal: ahorroObjetivo, fechaInicio: objetivoFechaInicio, fechaConclusion: hoy });
     guardarPerfilEnServidor();
  }

  const pct = (ahorroObjetivo/objetivoValor)*100;
  const restante = Math.max(0, objetivoValor - ahorroObjetivo); // Valor que falta

  document.getElementById("obj-nombre").textContent = objetivoNombre;
  document.getElementById("obj-meta").textContent = formatearMoneda(objetivoValor);
  document.getElementById("obj-ahorrado").textContent = formatearMoneda(ahorroObjetivo);
  document.getElementById("obj-restante").textContent = formatearMoneda(restante);

  if (restante <= 0) {
      document.getElementById("obj-texto").textContent = "¬°Objetivo alcanzado!";
  } else {
      document.getElementById("obj-texto").textContent = `Has avanzado ${pct.toFixed(1)}%`;
     
      // PROYECCION INTELIGENTE
      const transMes = filtrarMesActual(transaccionesLocal, "fecha");
      let eMes = 0; let sMes = 0;
      transMes.forEach(t => { if(t.tipo==="entrada") eMes+=t.valor; else sMes+=t.valor; });
      let saldoMes = eMes - sMes;
     
      const diaHoy = new Date().getDate();
      const ritmoDiario = saldoMes / (diaHoy || 1);
      const ahorroProyectadoMensual = ritmoDiario * 30;

      if (ahorroProyectadoMensual <= 0) {
          elProyeccion.textContent = "Tu flujo actual es negativo. Reduce gastos para proyectar fecha.";
          elProyeccion.style.color = "#f87171";
      } else {
          const mesesFaltantes = restante / ahorroProyectadoMensual;
          const diasFaltantes = Math.ceil(mesesFaltantes * 30);
          const fechaEstimada = new Date();
          fechaEstimada.setDate(fechaEstimada.getDate() + diasFaltantes);
          const fechaStr = fechaEstimada.toLocaleDateString("es-ES", { day: 'numeric', month: 'short', year: 'numeric' });

          elProyeccion.textContent = `Al ritmo actual, terminar√°s en ~${diasFaltantes} d√≠as (${fechaStr}).`;
          elProyeccion.style.color = "#38bdf8";
      }
  }

  // Pasamos el valor restante al gr√°fico
  dibujarGraficoObjetivo(pct, formatearMoneda(restante));
  rellenarHistorialObjetivos();
}

function calcularAhorroTotal() {
 let e=0, s=0;
 transaccionesLocal.forEach(t => { if(t.tipo==="entrada") e+=t.valor; else s+=t.valor; });
 return Math.max(0, e-s);
}

function rellenarHistorialObjetivos() {
const tb = document.querySelector("#tabla-historial-objetivos tbody"); tb.innerHTML = "";
objetivosHistorial.forEach(o => {
  const tr = document.createElement("tr");
  tr.innerHTML = `<td>${o.nombre}</td><td>${formatearMoneda(o.valorMeta)}</td><td>${formatearMoneda(o.ahorroFinal)}</td><td>${o.fechaInicio}</td><td>${o.fechaConclusion}</td>`;
  tb.appendChild(tr);
});
}

function analisisLatam() {
const edad = edadUsuario;
const pais = paisUsuario;
if (!metaMensualUsuario || !pais || !edad) {
  document.getElementById("perfil-analisis").textContent = "Completa perfil para an√°lisis.";
  return;
}
// Logica simples de exemplo
const base = { bo: 1500, br: 3000, ar: 250000, cl: 400000, mx: 9000, otro: 700 };
const basePais = base[pais] || base.otro;
const referencia = basePais;
const ratio = referencia > 0 ? (metaMensualUsuario / referencia) * 100 : 0;
let mensaje;
if (ratio < 70) mensaje = "Tu meta es baja comparada al promedio.";
else if (ratio <= 120) mensaje = "Tu meta es razonable.";
else mensaje = "Tu meta es alta.";
document.getElementById("perfil-analisis").textContent = mensaje;
}

function actualizarCampoGastoFijo() {
  const t = document.getElementById("tipo").value;
  const c = document.getElementById("categoria").value;
  const el = document.getElementById("campo-gasto-fijo");
  if(el) el.classList.toggle("hidden", !(t==="salida" && c==="__gasto_fijo__"));
}
function actualizarCampoOrigenYTarjeta() {
  const t = document.getElementById("tipo").value;
  const o = document.getElementById("origen").value;
  const divO = document.getElementById("campo-origen");
  const divT = document.getElementById("campo-tarjeta");
  if(t==="salida") {
      divO.classList.remove("hidden");
      divT.classList.toggle("hidden", o!=="tarjeta");
  } else {
      divO.classList.add("hidden");
      divT.classList.add("hidden");
  }
}

// Charts (Canvas - CON N√öMEROS EN EL CENTRO)
function dibujarGraficoMeta(porcentajeUsado, textoCentro) {
const canvas = document.getElementById("meta-chart");
if (!canvas) return;
const ctx = canvas.getContext("2d");
const w = canvas.width; const h = canvas.height;
const cx = w / 2; const cy = h / 2;
const radio = Math.min(w, h) / 2 - 10;
const innerRadio = radio * 0.6;
ctx.clearRect(0, 0, w, h);

// Fondo
ctx.beginPath(); ctx.arc(cx, cy, radio, 0, Math.PI * 2); ctx.fillStyle = "#111827"; ctx.fill();

const clamped = Math.max(0, Math.min(porcentajeUsado, 200)) / 100;
const inicio = -Math.PI / 2;
const fin = inicio + Math.PI * 2 * clamped;

// Arco
ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, radio, inicio, fin); ctx.closePath();

// Colores sem√°foro en el gr√°fico tambi√©n
if(porcentajeUsado > 80) ctx.fillStyle = "#ef4444";
else if(porcentajeUsado > 50) ctx.fillStyle = "#facc15";
else ctx.fillStyle = "#22c55e";

ctx.fill();

// Centro
ctx.beginPath(); ctx.arc(cx, cy, innerRadio, 0, Math.PI * 2); ctx.fillStyle = "#020617"; ctx.fill();

// TEXTO EN EL CENTRO (NUEVO)
if(textoCentro) {
   ctx.fillStyle = "#fff";
   ctx.font = "bold 12px sans-serif";
   ctx.textAlign = "center";
   ctx.textBaseline = "middle";
   ctx.fillText(textoCentro, cx, cy);
   
   ctx.fillStyle = "#94a3b8";
   ctx.font = "10px sans-serif";
   ctx.fillText("Restante", cx, cy + 15);
}
}

function dibujarGraficoObjetivo(porcentaje, textoCentro) {
const canvas = document.getElementById("objetivo-chart");
if (!canvas) return;
const ctx = canvas.getContext("2d");
const w = canvas.width; const h = canvas.height;
const cx = w / 2; const cy = h / 2;
const radio = Math.min(w, h) / 2 - 10;
const innerRadio = radio * 0.6;
ctx.clearRect(0, 0, w, h);

ctx.beginPath(); ctx.arc(cx, cy, radio, 0, Math.PI * 2); ctx.fillStyle = "#111827"; ctx.fill();
const end = -Math.PI/2 + (Math.PI*2 * (Math.min(porcentaje,100)/100));
ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, radio, -Math.PI/2, end);
ctx.fillStyle = "#0ea5e9"; ctx.fill();
ctx.beginPath(); ctx.arc(cx, cy, innerRadio, 0, Math.PI * 2); ctx.fillStyle = "#020617"; ctx.fill();

// TEXTO EN EL CENTRO (NUEVO)
if(textoCentro) {
   ctx.fillStyle = "#fff";
   ctx.font = "bold 12px sans-serif";
   ctx.textAlign = "center";
   ctx.textBaseline = "middle";
   ctx.fillText(textoCentro, cx, cy);
   
   ctx.fillStyle = "#94a3b8";
   ctx.font = "10px sans-serif";
   ctx.fillText("Falta", cx, cy + 15);
}
}

// --- FUN√á√ïES QUE FALTAVAM NA SUA C√ìPIA (Adicionadas para n√£o quebrar) ---
function rellenarPerfil() {
  document.getElementById("perfil-edad").value = edadUsuario || "";
  document.getElementById("perfil-sexo").value = sexoUsuario || "";
  document.getElementById("perfil-pais").value = paisUsuario || "";
  document.getElementById("perfil-meta").value = metaMensualUsuario || "";
  document.getElementById("perfil-ingreso").value = ingresoMensualUsuario || "";
  document.getElementById("perfil-moneda").value = monedaUsuario || "";
  document.getElementById("perfil-objetivo-nombre").value = objetivoNombre || "";
  document.getElementById("perfil-objetivo-valor").value = objetivoValor || "";
}

function inicializarReporte() {
  const sel = document.getElementById("reporte-mes");
  sel.innerHTML = "";
  // Pega meses √∫nicos das transa√ß√µes
  const meses = new Set();
  meses.add(obtenerAnioMesActual());
  transaccionesLocal.forEach(t => {
      if (t.fecha && t.fecha.length >= 7) meses.add(t.fecha.slice(0,7));
  });

  const ordenados = Array.from(meses).sort().reverse();
  ordenados.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = nombreMes(m) + " (" + m + ")";
      sel.appendChild(opt);
  });

  sel.onchange = () => cargarDatosReporte(sel.value);
  // Carrega mes atual
  if (ordenados.length > 0) cargarDatosReporte(ordenados[0]);
}

function cargarDatosReporte(mes) {
  const filtradas = transaccionesLocal.filter(t => t.fecha && t.fecha.startsWith(mes));
  let e = 0, s = 0;
  let gastosPorCat = {};

  filtradas.forEach(t => {
      if(t.tipo==="entrada") e+=t.valor;
      else {
          s+=t.valor;
          // Agrupa
          let catName = "Sin categor√≠a";
          if (t.gastoFijoId) catName = "Gasto Fijo";
          else if (t.categoriaId) {
              const c = categoriasLocal.find(x=>x.id===t.categoriaId);
              if(c) catName = c.nome;
          }
          if(!gastosPorCat[catName]) gastosPorCat[catName] = 0;
          gastosPorCat[catName] += t.valor;
      }
  });

  document.getElementById("rep-entradas").textContent = formatearMoneda(e);
  document.getElementById("rep-salidas").textContent = formatearMoneda(s);
  document.getElementById("rep-saldo").textContent = formatearMoneda(e - s);

  const tb = document.querySelector("#reporte-tabla-categorias tbody");
  tb.innerHTML = "";

  Object.keys(gastosPorCat).forEach(k => {
      const v = gastosPorCat[k];
      const pct = s > 0 ? (v/s)*100 : 0;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${k}</td><td>Salida</td><td>${formatearMoneda(v)}</td><td>${pct.toFixed(1)}%</td>`;
      tb.appendChild(tr);
  });
}

document.getElementById("reporte-mes-actual").addEventListener("click", () => {
 const current = obtenerAnioMesActual();
 const sel = document.getElementById("reporte-mes");
 sel.value = current;
 cargarDatosReporte(current);
});

</script>
</body>
</html>
