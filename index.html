<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Financiero Personal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #0f172a, #020617 45%, #111827 100%);
      color: #e5e7eb;
    }

    header {
      background: linear-gradient(90deg, #0ea5e9, #6366f1);
      color: #f9fafb;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 12px rgba(15, 23, 42, 0.6);
      position: sticky;
      top: 0;
      z-index: 30;
    }

    header h1 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    header .user-info {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    header button {
      margin-left: 0.25rem;
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      background: rgba(15, 23, 42, 0.15);
      color: #e5e7eb;
      backdrop-filter: blur(6px);
    }

    header button:hover {
      background: rgba(15, 23, 42, 0.35);
    }

    .container {
      display: flex;
      min-height: calc(100vh - 50px);
    }

    nav {
      width: 230px;
      background: rgba(15,23,42,0.98);
      color: #e5e7eb;
      padding: 1rem 0.75rem;
      box-shadow: 4px 0 16px rgba(0,0,0,0.7);
      position: sticky;
      top: 50px;
      height: calc(100vh - 50px);
    }

    nav h2 {
      font-size: 0.85rem;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      color: #9ca3af;
      letter-spacing: 0.08em;
    }

    nav button {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      color: inherit;
      padding: 0.5rem 0.4rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      transition: background 0.15s, transform 0.1s;
    }

    nav button::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4b5563;
    }

    nav button:hover {
      background: #111827;
      transform: translateX(2px);
    }

    nav button.active {
      background: linear-gradient(90deg, #1d4ed8, #22c55e);
      color: #f9fafb;
    }
    nav button.active::before {
      background: #f9fafb;
    }

    main {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    .main-inner {
      max-width: 1150px;
      margin: 0 auto;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
      border-radius: 14px;
      padding: 0.9rem 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 14px 35px rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.45);
      backdrop-filter: blur(12px);
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.9);
    }

    .card h3 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.4rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.75rem;
    }

    .stat {
      background: radial-gradient(circle at top, #0b1120, #020617);
      border-radius: 10px;
      padding: 0.55rem 0.75rem;
      border: 1px solid #1f2937;
      box-shadow: inset 0 0 0 1px rgba(148,163,184,0.25);
    }

    .stat-label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 0.1rem;
    }

    .stat-value {
      font-size: 1rem;
      font-weight: 700;
      color: #f9fafb;
    }

    .stat-small {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .barra-distribucion {
      margin-top: 0.6rem;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: #111827;
      display: flex;
      box-shadow: inset 0 0 0 1px rgba(55,65,81,0.7);
    }

    .barra-segmento {
      height: 100%;
      transition: width 0.25s ease-out;
    }

    .barra-lazer    { background: #f97316; }
    .barra-essencial { background: #22c55e; }
    .barra-outras   { background: #6366f1; }

    form {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
      align-items: end;
    }

    form .full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 0.8rem;
      color: #cbd5f5;
      margin-bottom: 0.15rem;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 8px;
      border: 1px solid #4b5563;
      font-size: 0.85rem;
      background: #020617;
      color: #e5e7eb;
    }

    input::placeholder {
      color: #6b7280;
    }

    input:focus,
    select:focus {
      outline: 2px solid #22c55e;
      outline-offset: 1px;
      border-color: #22c55e;
    }

    button.primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #f9fafb;
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(22,163,74,0.7);
      white-space: nowrap;
    }

    button.primary:hover {
      background: linear-gradient(135deg, #16a34a, #15803d);
    }

    .btn-icon {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.75rem;
      padding: 0.25rem 0.6rem;
      cursor: pointer;
      line-height: 1.2;
    }

    .btn-icon-danger {
      border-color: #ef4444;
      color: #fecaca;
    }

    .btn-icon-danger:hover {
      background: #7f1d1d;
      border-color: #f97316;
    }

    .tabla-wrapper {
      margin-top: 0.5rem;
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      color: #e5e7eb;
    }

    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 0.4rem 0.55rem;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #020617;
      font-weight: 500;
      color: #9ca3af;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:nth-child(even) td {
      background: #020617;
    }

    tr:nth-child(odd) td {
      background: #030712;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #4b5563;
      margin-right: 0.25rem;
      text-transform: capitalize;
    }

    .tag.entrada {
      border-color: #0ea5e9;
      background: #0c4a6e;
      color: #e0f2fe;
    }
    .tag.salida {
      border-color: #f97316;
      background: #451a03;
      color: #fed7aa;
    }

    .hidden { display: none !important; }

    /* LOGIN */

    #login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #0b1120, #020617 60%);
      color: #f9fafb;
      padding: 1rem;
    }

    #login-box {
      background: radial-gradient(circle at top left, #020617, #020617);
      border-radius: 18px;
      border: 1px solid #4b5563;
      padding: 1.6rem;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 25px 70px rgba(0,0,0,0.9);
      backdrop-filter: blur(14px);
    }

    #login-box h2 {
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
    }

    #login-box p {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }

    #login-box form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    #login-box label {
      color: #e5e7eb;
    }

    #login-box input {
      background: #020617;
      border-color: #4b5563;
      color: #f9fafb;
    }

    #login-box button {
      padding: 0.45rem 0.75rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }

    #login-box button.primary {
      width: 100%;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      box-shadow: 0 4px 14px rgba(22,163,74,0.8);
    }

    #login-box button.primary:hover {
      background: linear-gradient(135deg, #16a34a, #15803d);
    }

    #login-toggle {
      display: flex;
      justify-content: space-between;
      margin-top: 0.3rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    #login-toggle button {
      background: transparent;
      color: #38bdf8;
      padding: 0;
      box-shadow: none;
    }

    #login-message {
      font-size: 0.8rem;
      margin-top: 0.4rem;
      min-height: 1rem;
      color: #f97316;
    }

    #register-extra {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    /* FILAS DE GASTOS FIJOS CON ESTADO */

    .fijo-amarillo {
      background: #422006 !important;
    }
    .fijo-rojo {
      background: #450a0a !important;
    }
    .fijo-verde {
      background: #022c22 !important;
    }

    .badge-estado {
      display: inline-flex;
      align-items: center;
      padding: 0.05rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    .badge-amarillo {
      background: #facc15;
      color: #1f2937;
    }
    .badge-rojo {
      background: #ef4444;
      color: #f9fafb;
    }
    .badge-verde {
      background: #22c55e;
      color: #022c22;
    }
    .badge-normal {
      background: #4b5563;
      color: #e5e7eb;
    }

    .reporte-controles {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
    }
    .reporte-controles > div {
      min-width: 160px;
    }

    /* MODAL PRIMEROS PASOS */

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
      form {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      nav {
        display: none;
        position: fixed;
        top: 50px;
        left: 0;
        height: calc(100vh - 50px);
        z-index: 20;
      }
      nav.open {
        display: block;
      }
      .container {
        flex-direction: column;
      }
      main {
        padding: 0.75rem;
      }
      .main-inner {
        max-width: 100%;
      }
      header button#menu-toggle {
        display: inline-block;
      }
    }

    @media (min-width: 769px) {
      header button#menu-toggle {
        display: none;
      }
    }
  </style>
</head>

<body>

<!-- PANTALLA DE LOGIN -->
<section id="login-screen">
  <div id="login-box">
    <h2>Entrar al Control Financiero</h2>
    <p>Inicia sesión o crea una cuenta. Los datos financieros se guardan por usuario en este navegador.</p>

    <form id="login-form">
      <div>
        <label for="login-email">Correo electrónico</label>
        <input type="email" id="login-email" required placeholder="tu@ejemplo.com" />
      </div>
      <div>
        <label for="login-password">Contraseña</label>
        <input type="password" id="login-password" required />
      </div>

      <div id="register-extra" class="hidden">
        <div>
          <label for="register-edad">Edad (opcional)</label>
          <input type="number" id="register-edad" min="10" max="120" />
        </div>
        <div>
          <label for="register-meta">Meta mensual de gasto (opcional)</label>
          <input type="text" id="register-meta" placeholder="Ej: 1500" />
        </div>
      </div>

      <button type="submit" class="primary" id="login-submit">Entrar</button>
      <div id="login-toggle">
        <span id="toggle-text">¿No tienes cuenta?</span>
        <button type="button" id="toggle-mode">Crear cuenta</button>
      </div>
      <div id="login-message"></div>
    </form>
  </div>
</section>

<!-- APLICACIÓN PRINCIPAL -->
<div id="app" class="hidden">
  <header>
    <div style="display:flex; align-items:center; gap:0.5rem;">
      <button id="menu-toggle">☰</button>
      <h1>Control Financiero</h1>
    </div>
    <div class="user-info">
      <span id="user-email"></span>
      <button id="logout-btn">Salir</button>
    </div>
  </header>

  <div class="container">
    <nav id="sidebar">
      <h2>Menú</h2>
      <button data-section="dashboard" class="active">Dashboard</button>
      <button data-section="transacciones">Transacciones</button>
      <button data-section="fijos">Gastos fijos</button>
      <button data-section="tarjetas">Tarjetas</button>
      <button data-section="reportes">Reporte mensual</button>
      <button data-section="categorias">Categorías y metas</button>
      <button data-section="perfil">Perfil</button>
    </nav>

    <main>
      <div class="main-inner">

        <!-- DASHBOARD -->
        <section id="section-dashboard">
          <div class="card">
            <h3>Resumen del mes actual</h3>
            <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:stretch; margin-top:0.5rem;">
              <div style="flex:2 1 220px;">
                <div class="grid">
                  <div class="stat">
                    <div class="stat-label">Entradas</div>
                    <div class="stat-value" id="stat-entradas">$ 0,00</div>
                  </div>
                  <div class="stat">
                    <div class="stat-label">Salidas</div>
                    <div class="stat-value" id="stat-salidas">$ 0,00</div>
                  </div>
                  <div class="stat">
                    <div class="stat-label">Saldo</div>
                    <div class="stat-value" id="stat-saldo">$ 0,00</div>
                    <div class="stat-small" id="stat-saldo-texto"></div>
                  </div>
                </div>
              </div>
              <div style="flex:1 1 160px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <canvas id="meta-chart" width="160" height="160"></canvas>
                <div class="stat-small" id="stat-meta-uso" style="margin-top:0.4rem; text-align:center;"></div>
                <div class="stat-small" id="stat-ingreso-alerta" style="margin-top:0.25rem; text-align:center;"></div>
              </div>
            </div>
          </div>

          <!-- OBJETIVO DE AHORRO ESPECÍFICO -->
          <div class="card">
            <h3>Objetivo de ahorro específico</h3>
            <p class="card-subtitle">
              Define un objetivo en la sección Perfil (ej.: “Computador 10.000”).
              Cada vez que cambies de objetivo o reinicies, el progreso comienza desde cero.
            </p>
            <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:stretch; margin-top:0.5rem;">
              <div style="flex:2 1 220px;">
                <div class="stat">
                  <div class="stat-label">Objetivo</div>
                  <div class="stat-value" id="obj-nombre">Sin objetivo definido</div>
                  <div class="stat-small">
                    Meta: <span id="obj-meta">-</span>
                  </div>
                </div>
                <div class="grid" style="margin-top:0.5rem;">
                  <div class="stat">
                    <div class="stat-label">Ahorro acumulado para este objetivo</div>
                    <div class="stat-value" id="obj-ahorrado">$ 0,00</div>
                  </div>
                  <div class="stat">
                    <div class="stat-label">Falta para el objetivo</div>
                    <div class="stat-value" id="obj-restante">$ 0,00</div>
                  </div>
                  <div class="stat">
                    <div class="stat-label">Detalle</div>
                    <div class="stat-small" id="obj-texto"></div>
                  </div>
                </div>
              </div>
              <div style="flex:1 1 160px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <canvas id="objetivo-chart" width="160" height="160"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Distribución de salidas del mes</h3>
            <p class="card-subtitle">
              Porcentaje de gastos fijos y otros gastos sobre el total de salidas.
            </p>
            <div class="grid" style="margin-top:0.5rem;">
              <div class="stat">
                <div class="stat-label">Gastos fijos</div>
                <div class="stat-value" id="stat-lazer">0%</div>
              </div>
              <div class="stat">
                <div class="stat-label">Otros gastos</div>
                <div class="stat-value" id="stat-essenciais">0%</div>
              </div>
              <div class="stat">
                <div class="stat-label">—</div>
                <div class="stat-value" id="stat-outras">0%</div>
              </div>
            </div>
            <div class="barra-distribucion">
              <div class="barra-segmento barra-lazer" id="barra-lazer" style="width:0%;"></div>
              <div class="barra-segmento barra-essencial" id="barra-essencial" style="width:0%;"></div>
              <div class="barra-segmento barra-outras" id="barra-outras" style="width:0%;"></div>
            </div>
          </div>
        </section>

        <!-- TRANSACCIONES -->
        <section id="section-transacciones" class="hidden">
          <div class="card">
            <h3>Nueva transacción</h3>
            <form id="form-transaccion">
              <div>
                <label for="tipo">Tipo</label>
                <select id="tipo" required>
                  <option value="entrada">Entrada</option>
                  <option value="salida">Salida</option>
                </select>
              </div>
              <div>
                <label for="categoria">Categoría</label>
                <select id="categoria" required></select>
              </div>
              <div id="campo-origen" class="hidden">
                <label for="origen">Origen (solo salidas)</label>
                <select id="origen">
                  <option value="normal">Normal</option>
                  <option value="tarjeta">Tarjeta</option>
                </select>
              </div>
              <div id="campo-tarjeta" class="hidden">
                <label for="tarjeta-select">Tarjeta</label>
                <select id="tarjeta-select"></select>
              </div>
              <div>
                <label for="valor">Valor</label>
                <input type="text" id="valor" required placeholder="Ej: 1.300,50" />
              </div>
              <div>
                <label for="data">Fecha</label>
                <input type="date" id="data" required />
              </div>
              <div id="campo-gasto-fijo" class="hidden">
                <label for="gasto-fijo-select">Seleccionar gasto fijo</label>
                <select id="gasto-fijo-select"></select>
              </div>
              <div class="full">
                <label for="descripcion">Descripción</label>
                <input type="text" id="descripcion" placeholder="Ej: Salario, Mercado, Cine, etc." />
              </div>
              <div>
                <button type="submit" class="primary">Añadir</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3>Transacciones del mes</h3>
            <div class="card-subtitle">
              Usa el buscador para encontrarlas por descripción o por fecha.
            </div>

            <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
              <div>
                <label for="filtro-texto">Buscar por descripción</label>
                <input type="text" id="filtro-texto" placeholder="Ej: mercado, cine, alquiler..." />
              </div>
              <div>
                <label for="filtro-fecha">Filtrar por fecha</label>
                <input type="date" id="filtro-fecha" />
              </div>
              <div>
                <button type="button" class="primary" id="btn-limpiar-filtros">Limpiar filtros</button>
              </div>
            </div>

            <div class="tabla-wrapper">
              <table id="tabla-transacciones">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Categoría</th>
                    <th>Origen</th>
                    <th>Descripción</th>
                    <th>Valor</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- GASTOS FIJOS -->
        <section id="section-fijos" class="hidden">
          <div class="card">
            <h3>Nuevo gasto fijo mensual</h3>
            <form id="form-fijo">
              <div>
                <label for="fijo-descripcion">Descripción</label>
                <input type="text" id="fijo-descripcion" required placeholder="Alquiler, Internet, etc." />
              </div>
              <div>
                <label for="fijo-valor">Valor mensual</label>
                <input type="text" id="fijo-valor" required placeholder="Ej: 1.300" />
              </div>
              <div>
                <label for="fijo-vencimiento">Día de vencimiento</label>
                <input type="number" id="fijo-vencimiento" min="1" max="31" required />
              </div>
              <div>
                <button type="submit" class="primary">Añadir fijo</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3>Gastos fijos registrados</h3>
            <p class="card-subtitle">
              Amarillo = cerca de vencer (7 días) · Rojo = vencido / día de vencimiento sin pago · Verde = pagado este mes.
              Si el pago es parcial, verás cuánto falta.
            </p>
            <div class="tabla-wrapper">
              <table id="tabla-fijos">
                <thead>
                  <tr>
                    <th>Descripción</th>
                    <th>Valor</th>
                    <th>Vencimiento</th>
                    <th>Estado del mes</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- TARJETAS -->
        <section id="section-tarjetas" class="hidden">
          <div class="card">
            <h3>Registrar tarjeta</h3>
            <p class="card-subtitle">
              Guarda una referencia como los últimos dígitos para saber de qué tarjeta salió el gasto.
            </p>
            <form id="form-tarjeta">
              <div>
                <label for="tarjeta-alias">Propietario</label>
                <input type="text" id="tarjeta-alias" placeholder="Ej: Juan Pérez" />
              </div>
              <div>
                <label for="tarjeta-digitos">Últimos dígitos</label>
                <input type="text" id="tarjeta-digitos" maxlength="6" placeholder="Ej: 12345" />
              </div>
              <div>
                <label for="tarjeta-banco">Banco (opcional)</label>
                <input type="text" id="tarjeta-banco" placeholder="Ej: Banco Y" />
              </div>
              <div>
                <button type="submit" class="primary">Añadir tarjeta</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3>Tarjetas registradas</h3>
            <div class="tabla-wrapper">
              <table id="tabla-tarjetas">
                <thead>
                  <tr>
                    <th>Propietario</th>
                    <th>Últimos dígitos</th>
                    <th>Banco</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- REPORTE MENSUAL -->
        <section id="section-reportes" class="hidden">
          <div class="card">
            <h3>Reporte mensual</h3>
            <p class="card-subtitle">
              Resumen de entradas, salidas y saldo de un mes, con desglose por categoría.
              Puedes revisarlo al final de cada mes.
            </p>
            <div class="reporte-controles">
              <div>
                <label for="reporte-mes">Seleccionar mes</label>
                <select id="reporte-mes"></select>
              </div>
              <div>
                <button type="button" class="primary" id="reporte-mes-actual">
                  Ir al mes actual
                </button>
              </div>
            </div>

            <div class="grid" style="margin-top:0.75rem;">
              <div class="stat">
                <div class="stat-label">Entradas del mes</div>
                <div class="stat-value" id="rep-entradas">$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Salidas del mes</div>
                <div class="stat-value" id="rep-salidas">$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Saldo del mes</div>
                <div class="stat-value" id="rep-saldo">$ 0,00</div>
                <div class="stat-small" id="rep-saldo-texto"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Gastos por categoría (solo salidas)</h3>
            <div class="tabla-wrapper">
              <table id="reporte-tabla-categorias">
                <thead>
                  <tr>
                    <th>Categoría</th>
                    <th>Tipo</th>
                    <th>Total gastado</th>
                    <th>% sobre las salidas</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CATEGORÍAS Y METAS -->
        <section id="section-categorias" class="hidden">
          <div class="card">
            <h3>Categorías</h3>
            <form id="form-categoria">
              <div>
                <label for="cat-nome">Nombre de la categoría</label>
                <input type="text" id="cat-nome" required placeholder="Ej: Mercado, Gasolina, Universidad, Salud" />
              </div>
              <div>
                <label for="cat-grupo">Tipo</label>
                <select id="cat-grupo" required>
                  <option value="entrada">Entrada</option>
                  <option value="salida">Salida</option>
                </select>
              </div>
              <div>
                <button type="submit" class="primary">Añadir categoría</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3>Categorías registradas</h3>
            <div class="tabla-wrapper">
              <table id="tabla-categorias">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <p class="card-subtitle" style="margin-top:0.4rem;">
              El tipo define dónde se usa la categoría: <strong>Entrada</strong> o <strong>Salida</strong>.
            </p>
          </div>
        </section>

        <!-- PERFIL -->
        <section id="section-perfil" class="hidden">
          <div class="card">
            <h3>Perfil financiero</h3>
            <p class="card-subtitle">
              Define tu edad, sexo, país, moneda, ingreso mensual y una meta mensual general de gastos.
              También puedes definir un objetivo específico de ahorro (ej.: pagar un computador de 10.000).
              Cada objetivo tiene su propio “inicio”, y el progreso se resetea al cambiar el objetivo o al usar el botón de reinicio.
            </p>
            <form id="form-perfil">
              <div>
                <label for="perfil-edad">Edad</label>
                <input type="number" id="perfil-edad" min="10" max="120" />
              </div>
              <div>
                <label for="perfil-sexo">Sexo</label>
                <select id="perfil-sexo">
                  <option value="">No informar</option>
                  <option value="m">Masculino</option>
                  <option value="f">Femenino</option>
                  <option value="o">Otro</option>
                </select>
              </div>
              <div>
                <label for="perfil-pais">País (para análisis per cápita)</label>
                <select id="perfil-pais">
                  <option value="">Seleccionar país</option>
                  <option value="bo">Bolivia</option>
                  <option value="br">Brasil</option>
                  <option value="ar">Argentina</option>
                  <option value="cl">Chile</option>
                  <option value="mx">México</option>
                  <option value="otro">Otro país de LATAM</option>
                </select>
              </div>
              <div>
                <label for="perfil-meta">Meta mensual de gasto</label>
                <input type="text" id="perfil-meta" placeholder="Ej: 1500" />
              </div>
              <div>
                <label for="perfil-ingreso">Ingreso mensual aproximado</label>
                <input type="text" id="perfil-ingreso" placeholder="Ej: 2500" />
              </div>
              <div>
                <label for="perfil-moneda">Moneda</label>
                <select id="perfil-moneda">
                  <option value="">Automático por país</option>
                  <option value="BOB">BOB (Boliviano)</option>
                  <option value="BRL">BRL (Real brasileño)</option>
                  <option value="ARS">ARS (Peso argentino)</option>
                  <option value="CLP">CLP (Peso chileno)</option>
                  <option value="MXN">MXN (Peso mexicano)</option>
                  <option value="USD">USD (Dólar americano)</option>
                  <option value="EUR">EUR (Euro)</option>
                </select>
              </div>
              <div>
                <label for="perfil-objetivo-nombre">Objetivo de ahorro (nombre)</label>
                <input type="text" id="perfil-objetivo-nombre" placeholder="Ej: Computador nuevo" />
              </div>
              <div>
                <label for="perfil-objetivo-valor">Valor objetivo</label>
                <input type="text" id="perfil-objetivo-valor" placeholder="Ej: 10.000" />
              </div>
              <div>
                <button type="submit" class="primary">Guardar perfil</button>
              </div>
              <div>
                <button type="button" class="btn-icon" id="perfil-objetivo-reset">
                  Reiniciar progreso del objetivo
                </button>
              </div>
            </form>
            <div id="perfil-mensaje" class="stat-small" style="margin-top:0.4rem;"></div>
            <div id="perfil-analisis" class="stat-small" style="margin-top:0.5rem;"></div>
          </div>

          <div class="card">
            <h3>Historial de objetivos de ahorro</h3>
            <p class="card-subtitle">
              Aquí aparecen los objetivos que fueron completados (100% o más) y se guardan como concluidos.
            </p>
            <div class="tabla-wrapper">
              <table id="tabla-historial-objetivos">
                <thead>
                  <tr>
                    <th>Objetivo</th>
                    <th>Valor meta</th>
                    <th>Ahorro final</th>
                    <th>Fecha inicio</th>
                    <th>Fecha conclusión</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>
</div>

<!-- MODAL PRIMEROS PASOS (CATEGORÍAS) -->
<div id="modal-categorias" class="modal hidden">
  <div class="card" style="max-width:420px; width:90%; text-align:left;">
    <h3>Primeros pasos</h3>
    <p class="card-subtitle">
      Como acabas de crear tu cuenta, tus categorías están vacías.
    </p>
    <p style="font-size:0.85rem; margin-top:0.5rem;">
      1. En el menú lateral, entra en <strong>"Categorías y metas"</strong>.<br/>
      2. Crea tus propias categorías (ej.: Mercado, Alquiler, Universidad, Salud, Ocio...).<br/>
      3. Después, usa estas categorías al registrar tus transacciones.
    </p>
    <button type="button" class="primary" id="modal-categorias-ok" style="margin-top:0.75rem;">
      Entendido
    </button>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://unpkg.com/@nhost/nhost-js@4.1.0/dist/nhost-js.es.js';

  const nhost = createClient({
    subdomain: 'cpmnrcipviprenstjcwg',
    region: 'sa-east-1'
  });

  window.nhost = nhost;

  function monedaPorDefectoParaPais(pais) {
    switch (pais) {
      case "bo": return "BOB";
      case "br": return "BRL";
      case "ar": return "ARS";
      case "cl": return "CLP";
      case "mx": return "MXN";
      case "otro": return "USD";
      default: return "USD";
    }
  }

  function parseNumeroLocal(str) {
    if (str === null || str === undefined) return 0;
    if (typeof str !== "string") str = String(str);
    str = str.trim();
    if (!str) return 0;
    str = str.replace(/\./g, "");
    str = str.replace(",", ".");
    const n = parseFloat(str);
    return isNaN(n) ? 0 : n;
  }

  let monedaUsuario = "USD";

  function formatearMoneda(valor) {
    const currency = monedaUsuario || "USD";
    let locale = "en-US";

    switch (currency) {
      case "BRL": locale = "pt-BR"; break;
      case "BOB": locale = "es-BO"; break;
      case "ARS": locale = "es-AR"; break;
      case "CLP": locale = "es-CL"; break;
      case "MXN": locale = "es-MX"; break;
      case "EUR": locale = "es-ES"; break;
      default:    locale = "en-US";
    }

    try {
      return valor.toLocaleString(locale, { style: "currency", currency });
    } catch (e) {
      return valor.toFixed(2);
    }
  }

  function obtenerAnioMesActual() {
    const hoy = new Date();
    return hoy.toISOString().slice(0, 7);
  }

  function filtrarMesActual(lista, campoFecha) {
    const anioMesActual = obtenerAnioMesActual();
    return lista.filter(item => item[campoFecha].startsWith(anioMesActual));
  }

  function nombreMes(anioMes) {
    if (!anioMes) return "";
    const [anio, mes] = anioMes.split("-");
    const fecha = new Date(parseInt(anio), parseInt(mes) - 1, 1);
    return fecha.toLocaleDateString("es-ES", { month: "long", year: "numeric" });
  }

  function siguienteAnioMes(anioMes) {
    if (!anioMes) return anioMes;
    const [anioStr, mesStr] = anioMes.split("-");
    let anio = parseInt(anioStr, 10);
    let mes = parseInt(mesStr, 10);
    mes += 1;
    if (mes === 13) {
      mes = 1;
      anio += 1;
    }
    return anio.toString().padStart(4, "0") + "-" + mes.toString().padStart(2, "0");
  }

  let usuarioActual = null;
  let usuariosLocal = [];

  let categoriasLocal = [];
  let transaccionesLocal = [];
  let fijosLocal = [];
  let tarjetasLocal = [];
  let metaMensualUsuario = 0;
  let ingresoMensualUsuario = 0;
  let edadUsuario = null;
  let sexoUsuario = "";
  let paisUsuario = "";
  let yaMostroModalCategorias = false;

  let objetivoNombre = "";
  let objetivoValor = 0;
  let objetivoAhorroBase = 0;
  let objetivoFechaInicio = null;
  let objetivoCompletado = false;
  let objetivosHistorial = [];

  function guardarLocal() {
    localStorage.setItem("usuarios-financiero", JSON.stringify(usuariosLocal));
    if (!usuarioActual) return;
    const email = usuarioActual.email;
    localStorage.setItem("categorias-financiero-" + email, JSON.stringify(categoriasLocal));
    localStorage.setItem("transacciones-financiero-" + email, JSON.stringify(transaccionesLocal));
    localStorage.setItem("fijos-financiero-" + email, JSON.stringify(fijosLocal));
    localStorage.setItem("tarjetas-financiero-" + email, JSON.stringify(tarjetasLocal));
    const perfil = {
      metaMensual: metaMensualUsuario,
      ingresoMensual: ingresoMensualUsuario,
      edad: edadUsuario,
      sexo: sexoUsuario,
      pais: paisUsuario,
      moneda: monedaUsuario,
      objetivoNombre,
      objetivoValor,
      objetivoAhorroBase,
      objetivoFechaInicio,
      objetivoCompletado,
      objetivosHistorial,
      mostroModalCategorias: yaMostroModalCategorias
    };
    localStorage.setItem("perfil-financiero-" + email, JSON.stringify(perfil));
  }

  function cargarDatosUsuario() {
    if (!usuarioActual) return;
    const email = usuarioActual.email;
    categoriasLocal     = JSON.parse(localStorage.getItem("categorias-financiero-" + email) || "[]");
    transaccionesLocal  = JSON.parse(localStorage.getItem("transacciones-financiero-" + email) || "[]");
    fijosLocal          = JSON.parse(localStorage.getItem("fijos-financiero-" + email) || "[]");
    tarjetasLocal       = JSON.parse(localStorage.getItem("tarjetas-financiero-" + email) || "[]");

    const perfilStr = localStorage.getItem("perfil-financiero-" + email);
    if (perfilStr) {
      try {
        const perfil = JSON.parse(perfilStr);
        metaMensualUsuario       = perfil.metaMensual || 0;
        ingresoMensualUsuario    = perfil.ingresoMensual || 0;
        edadUsuario              = perfil.edad || null;
        sexoUsuario              = perfil.sexo || "";
        paisUsuario              = perfil.pais || "";
        monedaUsuario            = perfil.moneda || "";
        objetivoNombre           = perfil.objetivoNombre || "";
        objetivoValor            = perfil.objetivoValor || 0;
        objetivoAhorroBase       = perfil.objetivoAhorroBase || 0;
        objetivoFechaInicio      = perfil.objetivoFechaInicio || null;
        objetivoCompletado       = !!perfil.objetivoCompletado;
        objetivosHistorial       = perfil.objetivosHistorial || [];
        yaMostroModalCategorias  = !!perfil.mostroModalCategorias;
      } catch (e) {
        metaMensualUsuario = 0;
        ingresoMensualUsuario = 0;
        edadUsuario = null;
        sexoUsuario = "";
        paisUsuario = "";
        monedaUsuario = "";
        objetivoNombre = "";
        objetivoValor = 0;
        objetivoAhorroBase = 0;
        objetivoFechaInicio = null;
        objetivoCompletado = false;
        objetivosHistorial = [];
        yaMostroModalCategorias = false;
      }
    } else {
      metaMensualUsuario = 0;
      ingresoMensualUsuario = 0;
      edadUsuario = null;
      sexoUsuario = "";
      paisUsuario = "";
      monedaUsuario = "";
      objetivoNombre = "";
      objetivoValor = 0;
      objetivoAhorroBase = 0;
      objetivoFechaInicio = null;
      objetivoCompletado = false;
      objetivosHistorial = [];
      yaMostroModalCategorias = false;
    }

    if (!monedaUsuario) {
      monedaUsuario = monedaPorDefectoParaPais(paisUsuario) || "USD";
    }

    if (fijosLocal.length > 0 && !("id" in fijosLocal[0])) {
      const mesActual = obtenerAnioMesActual();
      const mesInicio = siguienteAnioMes(mesActual);
      fijosLocal = fijosLocal.map((f, idx) => ({
        id: idx + 1,
        descripcion: f.descricao || f.descripcion,
        valor: f.valor,
        vencimiento: f.vencimento || f.vencimiento,
        mesInicio
      }));
      guardarLocal();
    }
  }

  // --- NUEVO: Cargar perfil desde Nhost / Hasura ---
  async function cargarPerfilDesdeNhost() {
    if (!usuarioActual || !usuarioActual.email) return;
    try {
      const { data, error } = await nhost.graphql.request(`
        query PerfilPorEmail($email: String!) {
          perfil_financiero_by_pk(email: $email) {
            email
            edad
            sexo
            pais
            moneda
            meta_mensual
            ingreso_mensual
            objetivo_nombre
            objetivo_valor
            objetivo_ahorro_base
            objetivo_fecha_inicio
            objetivo_completado
          }
        }
      `, { email: usuarioActual.email });

      if (error) {
        console.error("Error al cargar perfil desde Nhost:", error);
        return;
      }

      const perfil = data?.perfil_financiero_by_pk;
      if (!perfil) return;

      edadUsuario           = perfil.edad ?? edadUsuario ?? null;
      sexoUsuario           = perfil.sexo ?? sexoUsuario ?? "";
      paisUsuario           = perfil.pais ?? paisUsuario ?? "";
      monedaUsuario         = perfil.moneda || monedaPorDefectoParaPais(paisUsuario) || monedaUsuario || "USD";
      metaMensualUsuario    = typeof perfil.meta_mensual === "number" ? perfil.meta_mensual : (metaMensualUsuario || 0);
      ingresoMensualUsuario = typeof perfil.ingreso_mensual === "number" ? perfil.ingreso_mensual : (ingresoMensualUsuario || 0);
      objetivoNombre        = perfil.objetivo_nombre ?? objetivoNombre ?? "";
      objetivoValor         = typeof perfil.objetivo_valor === "number" ? perfil.objetivo_valor : (objetivoValor || 0);
      objetivoAhorroBase    = typeof perfil.objetivo_ahorro_base === "number" ? perfil.objetivo_ahorro_base : (objetivoAhorroBase || 0);
      objetivoFechaInicio   = perfil.objetivo_fecha_inicio ?? objetivoFechaInicio ?? null;
      objetivoCompletado    = perfil.objetivo_completado ?? objetivoCompletado ?? false;

      guardarLocal();
    } catch (e) {
      console.error("Error de conexión con Nhost al cargar perfil:", e);
    }
  }

  // --- NUEVO: Guardar perfil en Nhost / Hasura ---
  async function guardarPerfilEnNhost() {
    if (!usuarioActual || !usuarioActual.email) return;
    try {
      const obj = {
        email: usuarioActual.email,
        edad: edadUsuario,
        sexo: sexoUsuario || null,
        pais: paisUsuario || null,
        moneda: monedaUsuario || null,
        meta_mensual: metaMensualUsuario,
        ingreso_mensual: ingresoMensualUsuario,
        objetivo_nombre: objetivoNombre || null,
        objetivo_valor: objetivoValor || 0,
        objetivo_ahorro_base: objetivoAhorroBase || 0,
        objetivo_fecha_inicio: objetivoFechaInicio || null,
        objetivo_completado: objetivoCompletado
      };

      const { error } = await nhost.graphql.request(`
        mutation UpsertPerfilFinanciero($obj: perfil_financiero_insert_input!) {
          insert_perfil_financiero_one(
            object: $obj,
            on_conflict: {
              constraint: perfil_financiero_pkey,
              update_columns: [
                edad,
                sexo,
                pais,
                moneda,
                meta_mensual,
                ingreso_mensual,
                objetivo_nombre,
                objetivo_valor,
                objetivo_ahorro_base,
                objetivo_fecha_inicio,
                objetivo_completado
              ]
            }
          ) {
            email
          }
        }
      `, { obj });

      if (error) {
        console.error("Error al guardar perfil en Nhost:", error);
      }
    } catch (e) {
      console.error("Error de conexión con Nhost al guardar perfil:", e);
    }
  }

  const loginScreen      = document.getElementById("login-screen");
  const app              = document.getElementById("app");
  const loginForm        = document.getElementById("login-form");
  const loginEmail       = document.getElementById("login-email");
  const loginPassword    = document.getElementById("login-password");
  const loginSubmit      = document.getElementById("login-submit");
  const toggleModeBtn    = document.getElementById("toggle-mode");
  const toggleText       = document.getElementById("toggle-text");
  const loginMessage     = document.getElementById("login-message");
  const registerExtra    = document.getElementById("register-extra");
  const registerEdad     = document.getElementById("register-edad");
  const registerMeta     = document.getElementById("register-meta");

  const modalCategorias   = document.getElementById("modal-categorias");
  const modalCategoriasOk = document.getElementById("modal-categorias-ok");

  let modoRegistro = false;

  toggleModeBtn.addEventListener("click", () => {
    modoRegistro = !modoRegistro;
    if (modoRegistro) {
      loginSubmit.textContent = "Crear cuenta";
      toggleText.textContent = "¿Ya tienes cuenta?";
      toggleModeBtn.textContent = "Entrar";
      registerExtra.classList.remove("hidden");
    } else {
      loginSubmit.textContent = "Entrar";
      toggleText.textContent = "¿No tienes cuenta?";
      toggleModeBtn.textContent = "Crear cuenta";
      registerExtra.classList.add("hidden");
    }
    loginMessage.textContent = "";
    loginMessage.style.color = "#f97316";
  });

  // BLOQUE LOGIN AJUSTADO CON AVISO DE VERIFICACIÓN
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = loginEmail.value.trim().toLowerCase();
    const password = loginPassword.value.trim();
    if (!email || !password) return;

    loginMessage.style.color = "#f97316";
    loginMessage.textContent = "";

    if (modoRegistro) {
      // REGISTRO: CREA LA CUENTA Y PIDE VERIFICAR EL EMAIL (SIN INICIAR SESIÓN AUTOMÁTICAMENTE)
      try {
        const { error } = await nhost.auth.signUpEmailPassword({ email, password });
        if (error) {
          console.error("Nhost signUpEmailPassword error:", error);
          loginMessage.textContent = error.message || "Error al crear cuenta (Nhost).";
          return;
        }

        // Guardar edad/meta de registro como perfil inicial (localStorage), sin dejar logueado
        const edad = parseInt(registerEdad.value || "0", 10) || null;
        const metaMensual = parseNumeroLocal(registerMeta.value || "0");

        const usuarioTemp = { email };
        const usuarioAnterior = usuarioActual;
        usuarioActual = usuarioTemp;

        edadUsuario = edad;
        metaMensualUsuario = metaMensual;
        ingresoMensualUsuario = 0;
        sexoUsuario = "";
        paisUsuario = "";
        monedaUsuario = "USD";
        objetivoNombre = "";
        objetivoValor = 0;
        objetivoAhorroBase = 0;
        objetivoFechaInicio = null;
        objetivoCompletado = false;
        objetivosHistorial = [];
        yaMostroModalCategorias = false;

        guardarLocal();
        usuarioActual = usuarioAnterior;

        loginMessage.style.color = "#22c55e";
        loginMessage.textContent =
          "Cuenta creada. Revisa tu correo y verifica tu email. Luego inicia sesión con tu contraseña.";

        // Volver a modo login
        modoRegistro = false;
        loginSubmit.textContent = "Entrar";
        toggleText.textContent = "¿No tienes cuenta?";
        toggleModeBtn.textContent = "Crear cuenta";
        registerExtra.classList.add("hidden");
      } catch (err) {
        console.error("Error de conexión / SDK con Nhost (signUp):", err);
        const mensajeError =
          (err && (err.response?.error || err.message)) ||
          "Error de conexión con Nhost (ver consola del navegador - F12).";
        loginMessage.style.color = "#f97316";
        loginMessage.textContent = mensajeError;
      }
    } else {
      // LOGIN NORMAL
      try {
        const { error } = await nhost.auth.signInEmailPassword({ email, password });
        if (error) {
          console.error("Nhost signInEmailPassword error:", error);
          loginMessage.textContent = error.message || "Credenciales inválidas.";
          return;
        }
        usuarioActual = { email };
        await abrirApp();
      } catch (err) {
        console.error("Error de conexión / SDK con Nhost (signIn):", err);
        const mensajeError =
          (err && (err.response?.error || err.message)) ||
          "Error de conexión con Nhost (ver consola del navegador - F12).";
        loginMessage.style.color = "#f97316";
        loginMessage.textContent = mensajeError;
      }
    }
  });

  // --- AJUSTADA: ahora async para poder esperar cargarPerfilDesdeNhost ---
  async function abrirApp() {
    document.getElementById("user-email").textContent = usuarioActual.email;
    loginScreen.classList.add("hidden");
    app.classList.remove("hidden");

    // 1) Carrega dados locais (categorias, transações, etc.)
    cargarDatosUsuario();

    // 2) Tenta sincronizar perfil com Nhost (sobrescreve apenas campos de perfil)
    await cargarPerfilDesdeNhost();

    // 3) Atualiza UI com o que estiver em memória
    inicializarInterfaz();
    mostrarModalCategoriasSiCorresponde();
  }

  document.getElementById("logout-btn").addEventListener("click", async () => {
    try {
      await nhost.auth.signOut();
    } catch (e) {
      console.error("Error al cerrar sesión en Nhost:", e);
    }
    usuarioActual = null;
    app.classList.add("hidden");
    loginScreen.classList.remove("hidden");
  });

  modalCategoriasOk.addEventListener("click", () => {
    modalCategorias.classList.add("hidden");
    yaMostroModalCategorias = true;
    guardarLocal();
  });

  function mostrarModalCategoriasSiCorresponde() {
    if (categoriasLocal.length === 0 && !yaMostroModalCategorias) {
      modalCategorias.classList.remove("hidden");
    } else {
      modalCategorias.classList.add("hidden");
    }
  }

  const sidebar    = document.getElementById("sidebar");
  const menuToggle = document.getElementById("menu-toggle");

  menuToggle.addEventListener("click", () => {
    sidebar.classList.toggle("open");
  });

  sidebar.addEventListener("click", (e) => {
    if (e.target.tagName !== "BUTTON") return;
    const seccion = e.target.getAttribute("data-section");
    if (!seccion) return;

    sidebar.querySelectorAll("button").forEach(btn => btn.classList.remove("active"));
    e.target.classList.add("active");

    document.querySelectorAll("main section").forEach(sec => sec.classList.add("hidden"));
    document.getElementById("section-" + seccion).classList.remove("hidden");

    sidebar.classList.remove("open");
  });

  const selectCategoria   = document.getElementById("categoria");
  const campoOrigen       = document.getElementById("campo-origen");
  const selectOrigen      = document.getElementById("origen");
  const campoGastoFijo    = document.getElementById("campo-gasto-fijo");
  const selectGastoFijo   = document.getElementById("gasto-fijo-select");
  const campoTarjeta      = document.getElementById("campo-tarjeta");
  const selectTarjeta     = document.getElementById("tarjeta-select");

  const tablaTransaccionesBody = document.querySelector("#tabla-transacciones tbody");
  const tablaFijosBody         = document.querySelector("#tabla-fijos tbody");
  const tablaCategoriasBody    = document.querySelector("#tabla-categorias tbody");
  const tablaTarjetasBody      = document.querySelector("#tabla-tarjetas tbody");
  const tablaHistorialObjetivosBody = document.querySelector("#tabla-historial-objetivos tbody");

  const statEntradas    = document.getElementById("stat-entradas");
  const statSalidas     = document.getElementById("stat-salidas");
  const statSaldo       = document.getElementById("stat-saldo");
  const statSaldoTexto  = document.getElementById("stat-saldo-texto");
  const statLazer       = document.getElementById("stat-lazer");
  const statEssenciais  = document.getElementById("stat-essenciais");
  const statOutras      = document.getElementById("stat-outras");
  const barraLazer      = document.getElementById("barra-lazer");
  const barraEssencial  = document.getElementById("barra-essencial");
  const barraOutras     = document.getElementById("barra-outras");
  const statMetaUso     = document.getElementById("stat-meta-uso");
  const statIngresoAlerta = document.getElementById("stat-ingreso-alerta");

  const objNombreSpan    = document.getElementById("obj-nombre");
  const objMetaSpan      = document.getElementById("obj-meta");
  const objAhorradoSpan  = document.getElementById("obj-ahorrado");
  const objRestanteSpan  = document.getElementById("obj-restante");
  const objTexto         = document.getElementById("obj-texto");

  const filtroTexto       = document.getElementById("filtro-texto");
  const filtroFecha       = document.getElementById("filtro-fecha");
  const btnLimpiarFiltros = document.getElementById("btn-limpiar-filtros");

  const selectReporteMes        = document.getElementById("reporte-mes");
  const btnReporteMesActual     = document.getElementById("reporte-mes-actual");
  const repEntradas             = document.getElementById("rep-entradas");
  const repSalidas              = document.getElementById("rep-salidas");
  const repSaldo                = document.getElementById("rep-saldo");
  const repSaldoTexto           = document.getElementById("rep-saldo-texto");
  const reporteTablaCategorias  = document.querySelector("#reporte-tabla-categorias tbody");

  const formPerfil        = document.getElementById("form-perfil");
  const perfilEdadInput   = document.getElementById("perfil-edad");
  const perfilSexoInput   = document.getElementById("perfil-sexo");
  const perfilPaisInput   = document.getElementById("perfil-pais");
  const perfilMetaInput   = document.getElementById("perfil-meta");
  const perfilIngresoInput= document.getElementById("perfil-ingreso");
  const perfilMonedaInput = document.getElementById("perfil-moneda");
  const perfilObjetivoNombreInput = document.getElementById("perfil-objetivo-nombre");
  const perfilObjetivoValorInput  = document.getElementById("perfil-objetivo-valor");
  const perfilMensaje     = document.getElementById("perfil-mensaje");
  const perfilAnalisis    = document.getElementById("perfil-analisis");
  const resetObjetivoBtn  = document.getElementById("perfil-objetivo-reset");

  function dibujarGraficoMeta(porcentajeUsado) {
    const canvas = document.getElementById("meta-chart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width;
    const h = canvas.height;
    const cx = w / 2;
    const cy = h / 2;
    const radio = Math.min(w, h) / 2 - 10;
    const innerRadio = radio * 0.6;

    ctx.clearRect(0, 0, w, h);

    ctx.beginPath();
    ctx.arc(cx, cy, radio, 0, Math.PI * 2);
    ctx.fillStyle = "#111827";
    ctx.fill();

    const clamped = Math.max(0, Math.min(porcentajeUsado, 200)) / 100;
    const inicio = -Math.PI / 2;
    const fin = inicio + Math.PI * 2 * clamped;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radio, inicio, fin);
    ctx.closePath();
    ctx.fillStyle = "#22c55e";
    ctx.fill();

    if (clamped < 1) {
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radio, fin, inicio + Math.PI * 2);
      ctx.closePath();
      ctx.fillStyle = "#4b5563";
      ctx.fill();
    }

    ctx.beginPath();
    ctx.arc(cx, cy, innerRadio, 0, Math.PI * 2);
    ctx.fillStyle = "#020617";
    ctx.fill();
  }

  function dibujarGraficoObjetivo(porcentaje) {
    const canvas = document.getElementById("objetivo-chart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width;
    const h = canvas.height;
    const cx = w / 2;
    const cy = h / 2;
    const radio = Math.min(w, h) / 2 - 10;
    const innerRadio = radio * 0.6;

    ctx.clearRect(0, 0, w, h);

    ctx.beginPath();
    ctx.arc(cx, cy, radio, 0, Math.PI * 2);
    ctx.fillStyle = "#111827";
    ctx.fill();

    const clamped = Math.max(0, Math.min(porcentaje, 200)) / 100;
    const inicio = -Math.PI / 2;
    const fin = inicio + Math.PI * 2 * clamped;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radio, inicio, fin);
    ctx.closePath();
    ctx.fillStyle = "#0ea5e9";
    ctx.fill();

    if (clamped < 1) {
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radio, fin, inicio + Math.PI * 2);
      ctx.closePath();
      ctx.fillStyle = "#4b5563";
      ctx.fill();
    }

    ctx.beginPath();
    ctx.arc(cx, cy, innerRadio, 0, Math.PI * 2);
    ctx.fillStyle = "#020617";
    ctx.fill();
  }

  function rellenarPerfil() {
    if (!usuarioActual) return;
    perfilEdadInput.value          = edadUsuario || "";
    perfilSexoInput.value          = sexoUsuario || "";
    perfilPaisInput.value          = paisUsuario || "";
    perfilMetaInput.value          = metaMensualUsuario || "";
    perfilIngresoInput.value       = ingresoMensualUsuario || "";
    perfilMonedaInput.value        = monedaUsuario || "";
    perfilObjetivoNombreInput.value= objetivoNombre || "";
    perfilObjetivoValorInput.value = objetivoValor || "";
  }

  function analisisLatam() {
    const edad = parseInt(perfilEdadInput.value || "0", 10) || 0;
    const pais = perfilPaisInput.value;
    if (!metaMensualUsuario || metaMensualUsuario <= 0 || !pais || !edad) {
      perfilAnalisis.textContent = "Para ver el análisis comparativo, completa país, edad y una meta mensual de gasto.";
      return;
    }

    const base = {
      bo: 1500,
      br: 3000,
      ar: 250000,
      cl: 400000,
      mx: 9000,
      otro: 700
    };

    const nombrePais = {
      bo: "Bolivia",
      br: "Brasil",
      ar: "Argentina",
      cl: "Chile",
      mx: "México",
      otro: "otro país de LATAM"
    };

    const basePais = base[pais] || base.otro;

    let factorEdad = 1;
    if (edad < 25) factorEdad = 0.85;
    else if (edad < 36) factorEdad = 1.0;
    else if (edad < 51) factorEdad = 1.1;
    else factorEdad = 0.95;

    const referencia = basePais * factorEdad;
    const ratio = referencia > 0 ? (metaMensualUsuario / referencia) * 100 : 0;

    let mensaje;
    if (ratio < 70) {
      mensaje =
        `Tu meta está por debajo del gasto promedio estimado para una persona de tu edad en ${nombrePais[pais]} ` +
        `en términos per cápita aproximados. Puede ser positivo si tu objetivo es ahorrar, pero revisa si no está demasiado restrictiva.`;
    } else if (ratio <= 120) {
      mensaje =
        `Tu meta está en un rango razonable comparado con un gasto promedio estimado para tu perfil en ${nombrePais[pais]}. ` +
        `Si además consigues ahorrar una parte, estás en un buen camino.`;
    } else {
      mensaje =
        `Tu meta de gasto está por encima del nivel promedio estimado para tu edad en ${nombrePais[pais]}. ` +
        `No es necesariamente malo, pero vale la pena revisar ingresos, deudas y objetivos de ahorro.`;
    }

    const refTexto = formatearMoneda(referencia);
    perfilAnalisis.textContent =
      mensaje + ` Referencia aproximada utilizada: ${refTexto}. ` +
      "Cálculo aproximado y solo orientativo, no es una recomendación financiera oficial.";
  }

  // --- AJUSTADO: agora async e chama guardarPerfilEnNhost ---
  formPerfil.addEventListener("submit", async (e) => {
    e.preventDefault();

    const viejoNombre = objetivoNombre || "";
    const viejoValor  = objetivoValor || 0;
    const ahorroTotal = calcularAhorroTotal();

    edadUsuario           = parseInt(perfilEdadInput.value || "0", 10) || null;
    sexoUsuario           = perfilSexoInput.value || "";
    paisUsuario           = perfilPaisInput.value || "";
    metaMensualUsuario    = parseNumeroLocal(perfilMetaInput.value || "0");
    ingresoMensualUsuario = parseNumeroLocal(perfilIngresoInput.value || "0");

    const nuevoNombre = perfilObjetivoNombreInput.value.trim();
    const nuevoValor  = parseNumeroLocal(perfilObjetivoValorInput.value || "0");

    const cambioObjetivo = (nuevoNombre !== viejoNombre) || (nuevoValor !== viejoValor);

    if (cambioObjetivo && nuevoNombre && nuevoValor > 0) {
      objetivoNombre      = nuevoNombre;
      objetivoValor       = nuevoValor;
      objetivoAhorroBase  = ahorroTotal;
      objetivoFechaInicio = new Date().toISOString().slice(0, 10);
      objetivoCompletado  = false;
    } else {
      objetivoNombre = nuevoNombre;
      objetivoValor  = nuevoValor;
      if (!nuevoNombre || nuevoValor <= 0) {
        objetivoAhorroBase  = 0;
        objetivoFechaInicio = null;
        objetivoCompletado  = false;
      }
    }

    let monedaSel = perfilMonedaInput.value;
    if (!monedaSel) {
      monedaSel = monedaPorDefectoParaPais(paisUsuario) || "USD";
    }
    monedaUsuario = monedaSel;

    guardarLocal();
    await guardarPerfilEnNhost();

    rellenarPerfil();
    actualizarResumen();
    analisisLatam();
    actualizarObjetivo();
    perfilMensaje.textContent = "Perfil guardado.";
    setTimeout(() => { perfilMensaje.textContent = ""; }, 3000);
  });

  perfilPaisInput.addEventListener("change", () => {
    const m = monedaPorDefectoParaPais(perfilPaisInput.value);
    if (m) {
      monedaUsuario = m;
      perfilMonedaInput.value = m;
      guardarLocal();
      actualizarResumen();
      analisisLatam();
      actualizarObjetivo();
    }
  });

  perfilMonedaInput.addEventListener("change", () => {
    monedaUsuario = perfilMonedaInput.value || "USD";
    guardarLocal();
    actualizarResumen();
    analisisLatam();
    actualizarObjetivo();
  });

  // --- AJUSTADO: também sincroniza com Nhost ao resetar objetivo ---
  resetObjetivoBtn.addEventListener("click", async () => {
    if (!objetivoNombre || !objetivoValor || objetivoValor <= 0) {
      alert("Primero define un objetivo con nombre y valor en el formulario.");
      return;
    }
    const ok = confirm("¿Seguro que quieres reiniciar el progreso de este objetivo? Esto no borra tus transacciones, solo reinicia el cálculo del ahorro para este objetivo.");
    if (!ok) return;

    const ahorroTotal = calcularAhorroTotal();
    objetivoAhorroBase  = ahorroTotal;
    objetivoFechaInicio = new Date().toISOString().slice(0, 10);
    objetivoCompletado  = false;
    guardarLocal();
    await guardarPerfilEnNhost();
    actualizarObjetivo();
  });

  function siguienteId(lista) {
    let max = 0;
    lista.forEach(item => {
      if (item.id && item.id > max) max = item.id;
    });
    return max + 1;
  }

  function inicializarInterfaz() {
    rellenarSelectCategorias();
    rellenarTablaCategorias();
    rellenarTablaFijos();
    rellenarSelectGastosFijos();
    rellenarTablaTarjetas();
    rellenarSelectTarjetas();
    rellenarTablaTransacciones();
    rellenarPerfil();
    rellenarHistorialObjetivos();
    actualizarResumen();
    inicializarReporte();
    analisisLatam();
    actualizarObjetivo();
    document.getElementById("data").valueAsDate = new Date();
    actualizarCampoGastoFijo();
    actualizarCampoOrigenYTarjeta();
  }

  function rellenarSelectCategorias() {
    selectCategoria.innerHTML = "";
    const tipo = document.getElementById("tipo").value;

    if (tipo === "salida" && fijosLocal.length > 0) {
      const optGF = document.createElement("option");
      optGF.value = "__gasto_fijo__";
      optGF.textContent = "Gastos fijos";
      selectCategoria.appendChild(optGF);
    }

    categoriasLocal.forEach(cat => {
      if (cat.grupo !== tipo) return;
      const opt = document.createElement("option");
      opt.value = String(cat.id);
      opt.textContent = cat.nome;
      selectCategoria.appendChild(opt);
    });
  }

  function rellenarTablaCategorias() {
    tablaCategoriasBody.innerHTML = "";
    categoriasLocal.forEach(cat => {
      const tr = document.createElement("tr");
      const tdNombre = document.createElement("td");
      tdNombre.textContent = cat.nome;
      const tdGrupo = document.createElement("td");
      tdGrupo.textContent = cat.grupo === "entrada" ? "Entrada" : "Salida";
      const tdAcciones = document.createElement("td");
      const btnDel = document.createElement("button");
      btnDel.textContent = "Eliminar";
      btnDel.className = "btn-icon btn-icon-danger";
      btnDel.addEventListener("click", () => {
        if (confirm("¿Eliminar esta categoría? Las transacciones existentes seguirán mostrando el nombre antiguo si ya lo guardaron.")) {
          categoriasLocal = categoriasLocal.filter(c => c.id !== cat.id);
          guardarLocal();
          rellenarTablaCategorias();
          rellenarSelectCategorias();
        }
      });
      tdAcciones.appendChild(btnDel);
      tr.appendChild(tdNombre);
      tr.appendChild(tdGrupo);
      tr.appendChild(tdAcciones);
      tablaCategoriasBody.appendChild(tr);
    });
  }

  function rellenarTablaTarjetas() {
    tablaTarjetasBody.innerHTML = "";
    tarjetasLocal.forEach(t => {
      const tr = document.createElement("tr");
      const tdAlias = document.createElement("td");
      tdAlias.textContent = t.alias || "";
      const tdDigitos = document.createElement("td");
      tdDigitos.textContent = t.digitos || "";
      const tdBanco = document.createElement("td");
      tdBanco.textContent = t.banco || "";
      const tdAcc = document.createElement("td");
      const btnDel = document.createElement("button");
      btnDel.textContent = "Eliminar";
      btnDel.className = "btn-icon btn-icon-danger";
      btnDel.addEventListener("click", () => {
        if (confirm("¿Eliminar esta tarjeta?")) {
          tarjetasLocal = tarjetasLocal.filter(x => x.id !== t.id);
          guardarLocal();
          rellenarTablaTarjetas();
          rellenarSelectTarjetas();
        }
      });
      tdAcc.appendChild(btnDel);
      tr.appendChild(tdAlias);
      tr.appendChild(tdDigitos);
      tr.appendChild(tdBanco);
      tr.appendChild(tdAcc);
      tablaTarjetasBody.appendChild(tr);
    });
  }

  function rellenarSelectTarjetas() {
    selectTarjeta.innerHTML = "";
    tarjetasLocal.forEach(t => {
      const opt = document.createElement("option");
      opt.value = String(t.id);
      opt.textContent = `${t.alias || ""} (${t.digitos || ""})`;
      selectTarjeta.appendChild(opt);
    });
  }

  function rellenarSelectGastosFijos() {
    selectGastoFijo.innerHTML = "";
    fijosLocal.forEach(f => {
      const opt = document.createElement("option");
      opt.value = String(f.id);
      opt.textContent = `${f.descripcion} (${formatearMoneda(f.valor)})`;
      selectGastoFijo.appendChild(opt);
    });
  }

  function estadoFijoParaMes(fijo, anioMesActual) {
    const hoy = new Date();
    const diaHoy = hoy.getDate();
    const venc = fijo.vencimiento;
    const mesInicio = fijo.mesInicio || obtenerAnioMesActual();

    if (anioMesActual < mesInicio) {
      return {
        claseFila: "",
        badgeClase: "badge-normal",
        texto: "Aún no aplica este mes",
        restante: fijo.valor,
        totalPagado: 0
      };
    }

    const transMes = filtrarMesActual(transaccionesLocal, "fecha");
    let totalPagado = 0;
    transMes.forEach(t => {
      if (t.tipo === "salida" && t.gastoFijoId === fijo.id) {
        totalPagado += t.valor;
      }
    });
    const restante = Math.max(0, fijo.valor - totalPagado);
    const pagoCompleto = totalPagado >= (fijo.valor - 0.01);

    if (pagoCompleto) {
      return {
        claseFila: "fijo-verde",
        badgeClase: "badge-verde",
        texto: "Pagado completamente este mes",
        restante: 0,
        totalPagado
      };
    }

    const faltanteTexto = restante > 0
      ? `Falta ${formatearMoneda(restante)}`
      : "";

    if (totalPagado > 0 && !pagoCompleto) {
      if (diaHoy >= venc) {
        return {
          claseFila: "fijo-rojo",
          badgeClase: "badge-rojo",
          texto: `Pago parcial (${formatearMoneda(totalPagado)} de ${formatearMoneda(fijo.valor)}). ${faltanteTexto}`,
          restante,
          totalPagado
        };
      } else if (diaHoy >= venc - 7) {
        return {
          claseFila: "fijo-amarillo",
          badgeClase: "badge-amarillo",
          texto: `Pago parcial (${formatearMoneda(totalPagado)} de ${formatearMoneda(fijo.valor)}). ${faltanteTexto}`,
          restante,
          totalPagado
        };
      } else {
        return {
          claseFila: "",
          badgeClase: "badge-normal",
          texto: `Pago parcial (${formatearMoneda(totalPagado)} de ${formatearMoneda(fijo.valor)}). ${faltanteTexto}`,
          restante,
          totalPagado
        };
      }
    }

    if (diaHoy < venc - 7) {
      return {
        claseFila: "",
        badgeClase: "badge-normal",
        texto: "Pendiente",
        restante,
        totalPagado
      };
    } else if (diaHoy >= venc - 7 && diaHoy < venc) {
      return {
        claseFila: "fijo-amarillo",
        badgeClase: "badge-amarillo",
        texto: "Cerca del vencimiento",
        restante,
        totalPagado
      };
    } else {
      return {
        claseFila: "fijo-rojo",
        badgeClase: "badge-rojo",
        texto: "Vencido / día de vencimiento sin pago",
        restante,
        totalPagado
      };
    }
  }

  function rellenarTablaFijos() {
    tablaFijosBody.innerHTML = "";
    const anioMesActual = obtenerAnioMesActual();

    fijosLocal.forEach(f => {
      const estado = estadoFijoParaMes(f, anioMesActual);
      const tr = document.createElement("tr");
      if (estado.claseFila) tr.classList.add(estado.claseFila);

      const tdDesc = document.createElement("td");
      tdDesc.textContent = f.descripcion;

      const tdValor = document.createElement("td");
      tdValor.textContent = formatearMoneda(f.valor);

      const tdVenc = document.createElement("td");
      tdVenc.textContent = `Día ${f.vencimiento}`;

      const tdEstado = document.createElement("td");
      const badge = document.createElement("span");
      badge.className = "badge-estado " + estado.badgeClase;
      badge.textContent = estado.texto;
      tdEstado.appendChild(badge);

      const tdAcc = document.createElement("td");
      const btnDel = document.createElement("button");
      btnDel.textContent = "Eliminar";
      btnDel.className = "btn-icon btn-icon-danger";
      btnDel.addEventListener("click", () => {
        if (confirm("¿Eliminar este gasto fijo? Las transacciones ya registradas que lo usan no se eliminan.")) {
          fijosLocal = fijosLocal.filter(x => x.id !== f.id);
          guardarLocal();
          rellenarTablaFijos();
          rellenarSelectGastosFijos();
          rellenarTablaTransacciones();
          actualizarResumen();
          inicializarReporte();
        }
      });
      tdAcc.appendChild(btnDel);

      tr.appendChild(tdDesc);
      tr.appendChild(tdValor);
      tr.appendChild(tdVenc);
      tr.appendChild(tdEstado);
      tr.appendChild(tdAcc);
      tablaFijosBody.appendChild(tr);
    });
  }

  function obtenerNombreCategoriaPorId(id) {
    const cat = categoriasLocal.find(c => String(c.id) === String(id));
    return cat ? cat.nome : "";
  }

  function obtenerDescripcionFijoPorId(id) {
    const f = fijosLocal.find(x => x.id === id);
    return f ? f.descripcion : "";
  }

  function obtenerTarjetaTextoPorId(id) {
    const t = tarjetasLocal.find(x => x.id === id);
    if (!t) return "";
    return `${t.alias || ""} (${t.digitos || ""})`;
  }

  function rellenarTablaTransacciones() {
    tablaTransaccionesBody.innerHTML = "";
    const anioMesActual = obtenerAnioMesActual();
    let lista = transaccionesLocal.filter(t => t.fecha.startsWith(anioMesActual));

    const textoFiltro = (filtroTexto.value || "").trim().toLowerCase();
    const fechaFiltro = (filtroFecha.value || "").trim();

    if (textoFiltro) {
      lista = lista.filter(t =>
        (t.descripcion || "").toLowerCase().includes(textoFiltro)
      );
    }

    if (fechaFiltro) {
      lista = lista.filter(t => t.fecha === fechaFiltro);
    }

    lista.sort((a, b) => (a.fecha < b.fecha ? 1 : -1));

    lista.forEach(t => {
      const tr = document.createElement("tr");

      const tdFecha = document.createElement("td");
      tdFecha.textContent = t.fecha;

      const tdTipo = document.createElement("td");
      const tag = document.createElement("span");
      tag.className = "tag " + t.tipo;
      tag.textContent = t.tipo;
      tdTipo.appendChild(tag);

      const tdCat = document.createElement("td");
      if (t.categoriaId === "__gasto_fijo__" && t.gastoFijoId) {
        tdCat.textContent = "Gasto fijo - " + obtenerDescripcionFijoPorId(t.gastoFijoId);
      } else {
        tdCat.textContent = obtenerNombreCategoriaPorId(t.categoriaId) || "-";
      }

      const tdOrigen = document.createElement("td");
      if (t.tipo === "salida") {
        if (t.origen === "tarjeta" && t.tarjetaId) {
          tdOrigen.textContent = "Tarjeta - " + obtenerTarjetaTextoPorId(t.tarjetaId);
        } else {
          tdOrigen.textContent = "Normal";
        }
      } else {
        tdOrigen.textContent = "-";
      }

      const tdDesc = document.createElement("td");
      tdDesc.textContent = t.descripcion || "";

      const tdValor = document.createElement("td");
      tdValor.textContent = formatearMoneda(t.valor);

      const tdAcc = document.createElement("td");
      const btnDel = document.createElement("button");
      btnDel.textContent = "Eliminar";
      btnDel.className = "btn-icon btn-icon-danger";
      btnDel.addEventListener("click", () => {
        if (confirm("¿Eliminar esta transacción?")) {
          transaccionesLocal = transaccionesLocal.filter(x => x.id !== t.id);
          guardarLocal();
          rellenarTablaTransacciones();
          rellenarTablaFijos();
          actualizarResumen();
          inicializarReporte();
          actualizarObjetivo();
        }
      });
      tdAcc.appendChild(btnDel);

      tr.appendChild(tdFecha);
      tr.appendChild(tdTipo);
      tr.appendChild(tdCat);
      tr.appendChild(tdOrigen);
      tr.appendChild(tdDesc);
      tr.appendChild(tdValor);
      tr.appendChild(tdAcc);
      tablaTransaccionesBody.appendChild(tr);
    });
  }

  function calcularAhorroTotal() {
    let totalEntradas = 0;
    let totalSalidas = 0;
    transaccionesLocal.forEach(t => {
      if (t.tipo === "entrada") totalEntradas += t.valor;
      else if (t.tipo === "salida") totalSalidas += t.valor;
    });
    const ahorro = totalEntradas - totalSalidas;
    return ahorro > 0 ? ahorro : 0;
  }

  function actualizarObjetivo() {
    if (!objetivoNombre || !objetivoValor || objetivoValor <= 0) {
      objNombreSpan.textContent = "Sin objetivo definido";
      objMetaSpan.textContent = "-";
      objAhorradoSpan.textContent = formatearMoneda(0);
      objRestanteSpan.textContent = formatearMoneda(0);
      objTexto.textContent = "Define un objetivo en el Perfil para comenzar a seguir tu ahorro.";
      dibujarGraficoObjetivo(0);
      rellenarHistorialObjetivos();
      return;
    }

    const ahorroTotal = calcularAhorroTotal();
    let ahorroObjetivo = ahorroTotal - objetivoAhorroBase;
    if (ahorroObjetivo < 0) ahorroObjetivo = 0;

    if (!objetivoCompletado && ahorroObjetivo >= objetivoValor) {
      objetivoCompletado = true;
      const hoy = new Date().toISOString().slice(0, 10);
      objetivosHistorial.push({
        nombre: objetivoNombre,
        valorMeta: objetivoValor,
        ahorroFinal: ahorroObjetivo,
        fechaInicio: objetivoFechaInicio || "",
        fechaConclusion: hoy
      });
      guardarLocal();
    }

    const porcentaje = objetivoValor > 0 ? (ahorroObjetivo / objetivoValor) * 100 : 0;
    const restante = objetivoValor - ahorroObjetivo;

    objNombreSpan.textContent = objetivoNombre;
    objMetaSpan.textContent = formatearMoneda(objetivoValor);
    objAhorradoSpan.textContent = formatearMoneda(ahorroObjetivo);
    objRestanteSpan.textContent = formatearMoneda(restante > 0 ? restante : 0);

    if (restante <= 0 && objetivoValor > 0) {
      objTexto.textContent = "¡Objetivo alcanzado o superado! Considera registrar un nuevo objetivo o reiniciar el progreso.";
    } else {
      objTexto.textContent = `Has avanzado aproximadamente ${porcentaje.toFixed(1)}% de este objetivo.`;
    }

    dibujarGraficoObjetivo(porcentaje);
    rellenarHistorialObjetivos();
  }

  function rellenarHistorialObjetivos() {
    tablaHistorialObjetivosBody.innerHTML = "";
    objetivosHistorial.forEach(o => {
      const tr = document.createElement("tr");
      const tdNom = document.createElement("td");
      tdNom.textContent = o.nombre || "";
      const tdMeta = document.createElement("td");
      tdMeta.textContent = formatearMoneda(o.valorMeta || 0);
      const tdFinal = document.createElement("td");
      tdFinal.textContent = formatearMoneda(o.ahorroFinal || 0);
      const tdIni = document.createElement("td");
      tdIni.textContent = o.fechaInicio || "";
      const tdConc = document.createElement("td");
      tdConc.textContent = o.fechaConclusion || "";
      tr.appendChild(tdNom);
      tr.appendChild(tdMeta);
      tr.appendChild(tdFinal);
      tr.appendChild(tdIni);
      tr.appendChild(tdConc);
      tablaHistorialObjetivosBody.appendChild(tr);
    });
  }

  function actualizarResumen() {
    const transMes = filtrarMesActual(transaccionesLocal, "fecha");
    let totalEntradas = 0;
    let totalSalidas = 0;

    let totalSalidasFijos = 0;
    let totalSalidasOtros = 0;

    transMes.forEach(t => {
      if (t.tipo === "entrada") {
        totalEntradas += t.valor;
      } else if (t.tipo === "salida") {
        totalSalidas += t.valor;
        if (t.gastoFijoId) totalSalidasFijos += t.valor;
        else totalSalidasOtros += t.valor;
      }
    });

    const saldo = totalEntradas - totalSalidas;

    statEntradas.textContent = formatearMoneda(totalEntradas);
    statSalidas.textContent  = formatearMoneda(totalSalidas);
    statSaldo.textContent    = formatearMoneda(saldo);

    if (saldo > 0) {
      statSaldoTexto.textContent = "Estás con saldo positivo este mes.";
    } else if (saldo < 0) {
      statSaldoTexto.textContent = "Estás gastando más de lo que entra este mes.";
    } else {
      statSaldoTexto.textContent = "Saldo neutro por ahora.";
    }

    let pctFijos = 0;
    let pctOtros = 0;
    const totalSalidasMes = totalSalidasFijos + totalSalidasOtros;
    if (totalSalidasMes > 0) {
      pctFijos = (totalSalidasFijos / totalSalidasMes) * 100;
      pctOtros = (totalSalidasOtros / totalSalidasMes) * 100;
    }

    statLazer.textContent      = pctFijos.toFixed(1) + "%";
    statEssenciais.textContent = pctOtros.toFixed(1) + "%";
    statOutras.textContent     = "0%";

    barraLazer.style.width     = pctFijos + "%";
    barraEssencial.style.width = pctOtros + "%";
    barraOutras.style.width    = "0%";

    if (metaMensualUsuario > 0) {
      const uso = (totalSalidas / metaMensualUsuario) * 100;
      const hoy = new Date();
      const anioMes = obtenerAnioMesActual().split("-");
      const anio = parseInt(anioMes[0], 10);
      const mes  = parseInt(anioMes[1], 10);
      const diasMes = new Date(anio, mes, 0).getDate();
      const diaHoy = hoy.getDate();
      const gastoPromedioDia = totalSalidas / (diaHoy || 1);
      const metaPorDia = metaMensualUsuario / diasMes;

      let texto = `Has usado ${uso.toFixed(1)}% de tu meta mensual de gasto. `;
      if (gastoPromedioDia > metaPorDia) {
        texto += "Tu gasto promedio diario está por encima de lo ideal para cumplir la meta.";
      } else {
        texto += "Tu gasto promedio diario está dentro o por debajo de lo ideal para cumplir la meta.";
      }
      statMetaUso.textContent = texto;
      dibujarGraficoMeta(uso);
    } else {
      statMetaUso.textContent = "Define una meta mensual de gasto en Perfil para ver tu uso en porcentaje.";
      dibujarGraficoMeta(0);
    }

    if (ingresoMensualUsuario > 0) {
      const ratio = (totalSalidas / ingresoMensualUsuario) * 100;
      let msg = `Tus salidas representan aproximadamente ${ratio.toFixed(1)}% de tu ingreso mensual declarado. `;
      if (ratio < 50) {
        msg += "Nivel saludable de gasto frente al ingreso.";
      } else if (ratio <= 80) {
        msg += "Nivel moderado. Está relativamente equilibrado.";
      } else {
        msg += "Alerta: tus gastos están muy cerca o por encima de tu ingreso mensual.";
      }
      statIngresoAlerta.textContent = msg;
    } else {
      statIngresoAlerta.textContent = "Informa tu ingreso mensual en Perfil para ver la relación gasto/ingreso.";
    }
  }

  function inicializarReporte() {
    const mesesSet = new Set();
    transaccionesLocal.forEach(t => {
      if (t.fecha && t.fecha.length >= 7) {
        mesesSet.add(t.fecha.slice(0, 7));
      }
    });

    if (mesesSet.size === 0) {
      mesesSet.add(obtenerAnioMesActual());
    }

    const meses = Array.from(mesesSet).sort();
    selectReporteMes.innerHTML = "";
    meses.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = nombreMes(m);
      selectReporteMes.appendChild(opt);
    });

    const actual = obtenerAnioMesActual();
    if (meses.includes(actual)) {
      selectReporteMes.value = actual;
    }

    actualizarReporte();
  }

  function actualizarReporte() {
    const mesSel = selectReporteMes.value || obtenerAnioMesActual();
    const transMes = transaccionesLocal.filter(t => t.fecha.startsWith(mesSel));
    let totalEntradas = 0;
    let totalSalidas = 0;

    const porCategoria = {};

    transMes.forEach(t => {
      if (t.tipo === "entrada") {
        totalEntradas += t.valor;
      } else if (t.tipo === "salida") {
        totalSalidas += t.valor;
        let nombreCat;
        let tipoCat;
        if (t.categoriaId === "__gasto_fijo__" && t.gastoFijoId) {
          nombreCat = "Gasto fijo - " + (obtenerDescripcionFijoPorId(t.gastoFijoId) || "");
          tipoCat = "Gasto fijo";
        } else {
          nombreCat = obtenerNombreCategoriaPorId(t.categoriaId) || "Sin categoría";
          tipoCat = "Normal";
        }
        const clave = nombreCat + "||" + tipoCat;
        if (!porCategoria[clave]) porCategoria[clave] = 0;
        porCategoria[clave] += t.valor;
      }
    });

    repEntradas.textContent = formatearMoneda(totalEntradas);
    repSalidas.textContent  = formatearMoneda(totalSalidas);
    const saldo = totalEntradas - totalSalidas;
    repSaldo.textContent = formatearMoneda(saldo);
    if (saldo > 0) repSaldoTexto.textContent = "Mes con saldo positivo.";
    else if (saldo < 0) repSaldoTexto.textContent = "Mes con saldo negativo.";
    else repSaldoTexto.textContent = "Saldo neutro.";

    reporteTablaCategorias.innerHTML = "";
    const claves = Object.keys(porCategoria);
    claves.forEach(cl => {
      const [nombreCat, tipoCat] = cl.split("||");
      const valor = porCategoria[cl];
      const pct = totalSalidas > 0 ? (valor / totalSalidas) * 100 : 0;
      const tr = document.createElement("tr");
      const tdNom = document.createElement("td");
      tdNom.textContent = nombreCat;
      const tdTipo = document.createElement("td");
      tdTipo.textContent = tipoCat;
      const tdTot = document.createElement("td");
      tdTot.textContent = formatearMoneda(valor);
      const tdPct = document.createElement("td");
      tdPct.textContent = pct.toFixed(1) + "%";
      tr.appendChild(tdNom);
      tr.appendChild(tdTipo);
      tr.appendChild(tdTot);
      tr.appendChild(tdPct);
      reporteTablaCategorias.appendChild(tr);
    });
  }

  selectReporteMes.addEventListener("change", actualizarReporte);
  btnReporteMesActual.addEventListener("click", () => {
    const actual = obtenerAnioMesActual();
    selectReporteMes.value = actual;
    actualizarReporte();
  });

  const formCategoria = document.getElementById("form-categoria");
  formCategoria.addEventListener("submit", (e) => {
    e.preventDefault();
    const nome = document.getElementById("cat-nome").value.trim();
    const grupo = document.getElementById("cat-grupo").value;
    if (!nome) return;
    const id = nextCategoriaId();
    categoriasLocal.push({ id, nome, grupo });
    guardarLocal();
    document.getElementById("cat-nome").value = "";
    rellenarTablaCategorias();
    rellenarSelectCategorias();
    mostrarModalCategoriasSiCorresponde();
  });

  function nextCategoriaId() {
    let max = 0;
    categoriasLocal.forEach(c => { if (c.id > max) max = c.id; });
    return max + 1;
  }

  const formFijo = document.getElementById("form-fijo");
  formFijo.addEventListener("submit", (e) => {
    e.preventDefault();
    const descripcion = document.getElementById("fijo-descripcion").value.trim();
    const valor = parseNumeroLocal(document.getElementById("fijo-valor").value || "0");
    const vencimiento = parseInt(document.getElementById("fijo-vencimiento").value || "0", 10);
    if (!descripcion || !valor || !vencimiento) return;

    const id = siguienteId(fijosLocal);
    const mesActual = obtenerAnioMesActual();
    const mesInicio = siguienteAnioMes(mesActual);

    fijosLocal.push({
      id,
      descripcion,
      valor,
      vencimiento,
      mesInicio
    });

    guardarLocal();
    document.getElementById("fijo-descripcion").value = "";
    document.getElementById("fijo-valor").value = "";
    document.getElementById("fijo-vencimiento").value = "";
    rellenarTablaFijos();
    rellenarSelectGastosFijos();
    actualizarResumen();
  });

  const formTarjeta = document.getElementById("form-tarjeta");
  formTarjeta.addEventListener("submit", (e) => {
    e.preventDefault();
    const alias = document.getElementById("tarjeta-alias").value.trim();
    const digitos = document.getElementById("tarjeta-digitos").value.trim();
    const banco = document.getElementById("tarjeta-banco").value.trim();
    if (!alias && !digitos) return;

    const id = siguienteId(tarjetasLocal);
    tarjetasLocal.push({ id, alias, digitos, banco });
    guardarLocal();

    document.getElementById("tarjeta-alias").value = "";
    document.getElementById("tarjeta-digitos").value = "";
    document.getElementById("tarjeta-banco").value = "";
    rellenarTablaTarjetas();
    rellenarSelectTarjetas();
  });

  const formTransaccion = document.getElementById("form-transaccion");
  formTransaccion.addEventListener("submit", (e) => {
    e.preventDefault();
    const tipo = document.getElementById("tipo").value;
    const categoriaVal = selectCategoria.value;
    const origen = selectOrigen.value;
    const valor = parseNumeroLocal(document.getElementById("valor").value || "0");
    const fecha = document.getElementById("data").value;
    const descripcion = document.getElementById("descripcion").value.trim();

    if (!tipo || !categoriaVal || !valor || !fecha) return;

    let gastoFijoId = null;
    if (tipo === "salida" && categoriaVal === "__gasto_fijo__") {
      if (!selectGastoFijo.value) {
        alert("Selecciona qué gasto fijo deseas pagar.");
        return;
      }
      gastoFijoId = parseInt(selectGastoFijo.value, 10);
    }

    let tarjetaId = null;
    let origenFinal = null;
    if (tipo === "salida") {
      if (origen === "tarjeta") {
        if (!selectTarjeta.value) {
          alert("Selecciona la tarjeta utilizada.");
          return;
        }
        origenFinal = "tarjeta";
        tarjetaId = parseInt(selectTarjeta.value, 10);
      } else {
        origenFinal = "normal";
      }
    }

    const id = siguienteId(transaccionesLocal);
    const trans = {
      id,
      tipo,
      categoriaId: categoriaVal,
      gastoFijoId,
      origen: origenFinal,
      tarjetaId,
      valor,
      fecha,
      descripcion
    };
    transaccionesLocal.push(trans);
    guardarLocal();

    document.getElementById("valor").value = "";
    document.getElementById("descripcion").value = "";

    rellenarTablaTransacciones();
    rellenarTablaFijos();
    actualizarResumen();
    inicializarReporte();
    actualizarObjetivo();
  });

  function actualizarCampoGastoFijo() {
    const tipo = document.getElementById("tipo").value;
    const esSalida = tipo === "salida";
    const esGastoFijoCategoria = esSalida && selectCategoria.value === "__gasto_fijo__";
    if (esGastoFijoCategoria) {
      campoGastoFijo.classList.remove("hidden");
    } else {
      campoGastoFijo.classList.add("hidden");
    }
  }

  function actualizarCampoOrigenYTarjeta() {
    const tipo = document.getElementById("tipo").value;
    if (tipo === "salida") {
      campoOrigen.classList.remove("hidden");
      if (selectOrigen.value === "tarjeta") {
        campoTarjeta.classList.remove("hidden");
      } else {
        campoTarjeta.classList.add("hidden");
      }
    } else {
      campoOrigen.classList.add("hidden");
      campoTarjeta.classList.add("hidden");
    }
  }

  document.getElementById("tipo").addEventListener("change", () => {
    rellenarSelectCategorias();
    actualizarCampoGastoFijo();
    actualizarCampoOrigenYTarjeta();
  });

  selectCategoria.addEventListener("change", () => {
    actualizarCampoGastoFijo();
  });

  selectOrigen.addEventListener("change", () => {
    actualizarCampoOrigenYTarjeta();
  });

  filtroTexto.addEventListener("input", () => {
    rellenarTablaTransacciones();
  });

  filtroFecha.addEventListener("change", () => {
    rellenarTablaTransacciones();
  });

  btnLimpiarFiltros.addEventListener("click", () => {
    filtroTexto.value = "";
    filtroFecha.value = "";
    rellenarTablaTransacciones();
  });

  window.addEventListener("load", () => {
    // Siempre mostrar pantalla de login al recargar.
  });
</script>
</body>
</html>